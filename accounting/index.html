<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>財富自由 (單人版)</title>
    
    <!-- 核心函式庫 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind 設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#FAFAFA', card: '#FFFFFF', sidebar: '#F4F4F5', text: '#171717',
                            muted: '#737373', border: '#E5E5E5', accent: '#171717', green: '#059669',
                            red: '#DC2626', blue: '#2563EB', hover: '#F4F4F5',
                        }
                    },
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        mono: ['"Rajdhani"', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #FAFAFA; 
            color: #171717; 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        /* 捲軸美化 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D4D4D8; border-radius: 3px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .sticky-header th { position: sticky; top: 0; z-index: 10; background-color: #FFFFFF; box-shadow: 0 1px 0 #E5E5E5; }
        .toast-bg { background-color: rgba(23, 23, 23, 0.9) !important; backdrop-filter: blur(4px); color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        input, select, textarea { color-scheme: light; }
        @keyframes popIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- GITHUB CONFIGURATION ---
        const CONFIG_GITHUB_TOKEN = "2HeFl4D7QeZLTRCf0SG97fD6UyjM2Y0F6uyl"; 
        const CONFIG_REPO_BASE = "zenningh1983/money"; 
        const CONFIG_FILE_PATH = "accounting/money_data.json"; 

        const GITHUB_CONFIG = {
            ENABLED: true,
            TOKEN: `ghp_${CONFIG_GITHUB_TOKEN}`,
            REPO: CONFIG_REPO_BASE,
            PATH: CONFIG_FILE_PATH
        };

        // --- SHARED CONSTANTS ---
        const DEFAULT_ACCOUNT_TYPES = {
            cash: { label: '現金', icon: 'banknote' }, 
            bank: { label: '銀行', icon: 'landmark' },
            credit: { label: '信用卡', icon: 'credit-card' },
            stock: { label: '證券戶', icon: 'trending-up' },  
            pay: { label: '行動支付', icon: 'smartphone' },   
            ticket: { label: '電子票券', icon: 'ticket' }
        };

        const TX_TYPES = {
            expense: { label: '支出', color: 'text-rose-500', icon: 'minus' },
            income: { label: '收入', color: 'text-emerald-500', icon: 'plus' },
            transfer: { label: '轉帳', color: 'text-muji-blue', icon: 'arrow-right-left' },
            advance: { label: '代墊', color: 'text-orange-500', icon: 'hand-coins' }, 
            repay: { label: '還款', color: 'text-teal-600', icon: 'undo-2' }
        };

        const DEFAULT_CATEGORY_GROUPS = {
            expense: [
                { id: 'food', label: '伙食', icon: 'utensils', subs: ['三餐', '交際應酬', '酒類', '咖啡飲料', '水果', '零食', '超市', '團購食材'] },
                { id: 'transport', label: '交通', icon: 'bus', subs: ['公車捷運', 'Gogoro', '高鐵台鐵', '租車', '計程車', '加油', '停車', '洗車', '維修保養', 'ETC'] },
                { id: 'home', label: '居家', icon: 'home', subs: ['房貸', '管理費', '水電瓦斯', '網路', '手機費', '傢俱家電', '日用雜貨', '3C 周邊', '修繕'] },
                { id: 'life', label: '生活', icon: 'shopping-bag', subs: ['治裝', '美容美妝', '美髮', '美甲', '美睫'] },        
                { id: 'play', label: '娛樂', icon: 'gamepad-2', subs: ['電影', '唱歌', '棒球', '泡湯按摩', '植栽', '旅行', 'APP訂閱', '遊戲課金', '打牌博弈'] },
                { id: 'medical', label: '醫療', icon: 'stethoscope', subs: ['掛號費', '藥用品', '保健食品', '健檢', '疫苗', '住院手術'] },
                { id: 'insurance', label: '保險稅負', icon: 'shield', subs: ['一般保險', '車險', '旅遊險', '各式稅金'] },
                { id: 'parenting', label: '育兒', icon: 'baby', subs: ['學雜費', '補習班', '安親班', '才藝', '冬夏令營', '零用錢', '小孩物品', '小孩治裝', '學用品', '手機費', '保險', '掛號費'] },
                { id: 'invest', label: '投資理財', icon: 'piggy-bank', subs: ['個股', 'ETF', '基金', '定存', '外幣'] },
                { id: 'other', label: '其他', icon: 'circle-ellipsis', subs: ['手續費', '滯納金', '運費', '人情紅包', '禮物', '捐款', '請客', '罰單', '遺失', '其他'] }
            ],
            income: [
                { id: 'active', label: '主動', icon: 'briefcase', subs: ['薪資', '加班費', '獎金'] },
                { id: 'passive', label: '被動', icon: 'trending-up', subs: ['股息', '利息', '贖回'] },
                { id: 'other_in', label: '其他', icon: 'wallet', subs: ['紅包', '退款', '補助款', '中獎', '紅利回饋','其他', '還款', '葡眾'] }
            ]
        };

        const DEFAULT_DEBT_TARGETS = [
            { id: 'dt_1', name: '朋友A', defaultPercent: 50 },
            { id: 'dt_2', name: '公司', defaultPercent: 100 },
        ];

        const INITIAL_DATA = {
            accounts: [
                { id: 'acc1', name: '我的錢包', type: 'cash', balance: 0 },
                { id: 'acc2', name: '薪資帳戶', type: 'bank', balance: 0 },
            ],
            transactions: [],
            settings: { categoryGroups: DEFAULT_CATEGORY_GROUPS, accountTypes: DEFAULT_ACCOUNT_TYPES },
            debtTargets: DEFAULT_DEBT_TARGETS
        };

        const KEYWORD_MAPPING = {
            '早餐': 'food_三餐', '午餐': 'food_三餐', '晚餐': 'food_三餐', '便當': 'food_三餐', '三餐': 'food_三餐',
            '飲料': 'food_咖啡飲料', '咖啡': 'food_咖啡飲料', '星巴克': 'food_咖啡飲料', '7-11': 'food_零食', '全家': 'food_零食',
            '捷運': 'transport_公車捷運', '公車': 'transport_公車捷運', 'Uber': 'transport_計程車', '計程車': 'transport_計程車',
            '加油': 'transport_加油', '薪資': 'active_薪資', '股息': 'passive_股息', '利息': 'passive_利息'
        };

        const QUOTES = ["每一塊錢都是你的士兵。", "理財就是理生活。", "複利是世界第八大奇蹟。", "不要為錢工作，讓錢為你工作。", "節儉是為了更自由的未來。"];

        // --- HELPER FUNCTIONS ---
        const getFlatCategories = (categoryGroups) => {
            const flat = {};
            if(!categoryGroups) return flat;
            Object.values(categoryGroups).forEach(typeGroups => {
                typeGroups.forEach(group => {
                    group.subs.forEach(sub => {
                        const id = `${group.id}_${sub}`; 
                        flat[id] = { id, name: sub, group: group.label, icon: group.icon, type: typeGroups === categoryGroups.expense ? 'expense' : 'income' };
                    });
                });
            });
            return flat;
        };

        const calculateBalance = (data, accId) => {
            const initial = data.accounts.find(a => a.id === accId)?.balance || 0;
            const txs = data.transactions.filter(t => t.accountId === accId || t.toAccountId === accId);
            return txs.reduce((acc, curr) => {
                const amount = curr.amount || 0;
                if ((curr.type === 'income' || curr.type === 'repay') && curr.accountId === accId) return acc + amount;
                if ((curr.type === 'expense' || curr.type === 'advance') && curr.accountId === accId) return acc - amount;
                if (curr.type === 'transfer') {
                    if (curr.accountId === accId) return acc - amount; 
                    if (curr.toAccountId === accId) return acc + amount; 
                }
                return acc;
            }, initial);
        };

        const calculateMonthlyStats = (data, date = new Date()) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const txs = data.transactions.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear() === year && d.getMonth() === month;
            });
            const income = txs.reduce((sum, t) => t.type === 'income' ? sum + (t.amount || 0) : sum, 0); 
            const expense = txs.reduce((sum, t) => {
                if (t.type === 'expense') {
                    let myAmount = t.amount || 0;
                    if (t.splits && t.splits.length > 0) {
                        const othersAmount = t.splits.reduce((acc, s) => {
                            return s.owner !== 'me' ? acc + (parseFloat(s.amount) || 0) : acc;
                        }, 0);
                        myAmount = myAmount - othersAmount;
                    }
                    return sum + myAmount;
                }
                return sum;
            }, 0);
            return { income, expense };
        };

        const autoTag = (note) => {
            if(!note) return 'other_其他';
            const lowerNote = note.toLowerCase();
            for (let key in KEYWORD_MAPPING) if (lowerNote.includes(key.toLowerCase())) return KEYWORD_MAPPING[key];
            return 'other_其他'; 
        };

        const getDebtSummary = (data) => {
            const debts = {}; 
            data.transactions.forEach(tx => {
                const amount = tx.amount || 0;
                if (tx.isSettled) return; // Only count unsettled for the summary card
                if (tx.type === 'repay' && tx.targetName) debts[tx.targetName] = (debts[tx.targetName] || 0) - amount;
                if (tx.type === 'expense' && tx.splits && Array.isArray(tx.splits)) {
                    tx.splits.forEach(split => {
                        if (split.name && split.owner !== 'me') { 
                            const name = split.name;
                            debts[name] = (debts[name] || 0) + (parseFloat(split.amount) || 0);
                        }
                    });
                }
                if (tx.type === 'advance' && tx.targetName) debts[tx.targetName] = (debts[tx.targetName] || 0) + amount;
            });
            return debts;
        };

        const refreshIcons = () => { if (window.lucide) setTimeout(() => window.lucide.createIcons(), 50); };

        // --- SHARED COMPONENTS ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { 
                if (message) {
                    const timer = setTimeout(() => { if(onClose) onClose(); }, 1000); 
                    return () => clearTimeout(timer); 
                }
            }, [message, onClose]);
            if (!message) return null;
            return <div className="fixed inset-0 z-50 flex items-center justify-center pointer-events-none"><div className="px-6 py-3 rounded-xl shadow-2xl text-sm font-medium tracking-wide animate-pop toast-bg">{message}</div></div>;
        };

        const Modal = ({ children, onClose, title }) => {
            useEffect(() => {
                const handleKeyDown = (e) => { if (e.key === 'Escape') { if (onClose) onClose('esc'); } };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [onClose]);
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-pop cursor-pointer" onClick={() => onClose && onClose('backdrop')}>
                    <div className="bg-muji-card w-full max-w-xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] border border-muji-border cursor-auto" onClick={(e) => e.stopPropagation()}>
                        <div className="p-4 border-b border-muji-border flex justify-between items-center bg-muji-bg">
                            <h3 className="font-bold text-lg text-muji-text">{title}</h3>
                            <button onClick={() => onClose && onClose('close_btn')} className="p-2 hover:bg-black/5 rounded-full transition-colors"><i data-lucide="x" className="w-5 h-5 text-muji-muted"></i></button>
                        </div>
                        <div className="overflow-y-auto p-6 custom-scrollbar text-muji-text">{children}</div>
                    </div>
                </div>
            );
        };

        const LucideIcon = React.memo(({ name, className = "", onClick, size }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.className = className;
                    if (size) { i.style.width = size + 'px'; i.style.height = size + 'px'; }
                    ref.current.innerHTML = '';
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, className, size]);
            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} onClick={onClick}></span>;
        });

        const CollapsibleSection = ({ title, isOpen, onToggle, children }) => (
            <div className="bg-muji-card border border-muji-border rounded-xl shadow-sm overflow-hidden mb-4 transition-all">
                <button onClick={onToggle} className="w-full p-4 flex justify-between items-center bg-muji-bg hover:bg-muji-hover transition-colors">
                    <h3 className="font-bold text-lg text-muji-text">{title}</h3>
                    <LucideIcon name={isOpen ? "chevron-down" : "chevron-right"} className="w-5 h-5 text-muji-muted" />
                </button>
                {isOpen && <div className="p-6 border-t border-muji-border animate-fade">{children}</div>}
            </div>
        );

        // --- SUB COMPONENTS ---
        const CategorySelector = ({ type, categoryGroups, selectedGroup, setSelectedGroup, onSelectCategory, currentCategory }) => {
            const effectiveType = type === 'advance' ? 'expense' : (type === 'repay' ? 'income' : type);
            if (!['expense', 'income'].includes(effectiveType)) return null;
            const groups = categoryGroups[effectiveType] || [];
            return (
                <div className="space-y-4 mt-6">
                    <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar px-2 p-4">
                        {groups.map(g => (
                            <button key={g.id} onClick={() => setSelectedGroup(g.id)} className={`flex flex-col items-center gap-1 min-w-[3rem] transition-all ${selectedGroup === g.id ? 'opacity-100 scale-110' : 'opacity-50 hover:opacity-80'}`}>
                                <div className={`w-10 h-10 rounded-full border-2 flex items-center justify-center ${selectedGroup === g.id ? 'border-muji-accent text-white bg-muji-accent shadow-sm' : 'border-muji-muted text-muji-muted'}`}>
                                    <LucideIcon name={g.icon} className="w-5 h-5 stroke-[1.5]" />
                                </div>
                                <span className="text-[10px] text-muji-text font-bold mt-1">{g.label}</span>
                            </button>
                        ))}
                    </div>
                    <div className="grid grid-cols-4 gap-2">
                        {groups.find(g => g.id === selectedGroup)?.subs.map(sub => {
                            const catId = `${selectedGroup}_${sub}`;
                            const isSelected = currentCategory === catId;
                            return (
                                <button key={sub} onClick={() => onSelectCategory(catId)} className={`py-1.5 px-1 rounded text-xs border transition-colors truncate ${isSelected ? 'bg-muji-accent text-white border-muji-accent shadow-sm' : 'bg-muji-card border-muji-border text-muji-text hover:border-muji-accent'}`}>{sub}</button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const ExtraFieldsInput = ({ type, accountId, toAccountId, targetName, userAccounts, selectedAccount, onChange, debtTargets, onAddTarget }) => {
            if (type === 'transfer') {
                const handleSwap = () => { if (onChange) onChange('swap_accounts', { from: accountId, to: toAccountId }); };
                return (
                    <div className="flex gap-2 mt-1 w-full items-end">
                        <div className="flex-1 flex flex-col gap-1"><label className="text-xs text-muji-muted">轉出 (From)</label><select className="p-2 bg-muji-card rounded border border-muji-border text-sm w-full text-muji-text" value={accountId} onChange={e => onChange('accountId', e.target.value)}><option value="">選擇帳戶</option>{userAccounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>
                        <div className="flex items-center pb-2 text-muji-muted"><button onClick={handleSwap} className="p-1 hover:bg-muji-bg rounded-full transition-colors"><LucideIcon name="arrow-right-left" className="w-4 h-4" /></button></div>
                        <div className="flex-1 flex flex-col gap-1"><label className="text-xs text-muji-muted">轉入 (To)</label><select className="p-2 bg-muji-card rounded border border-muji-border text-sm w-full text-muji-text" value={toAccountId} onChange={e => onChange('toAccountId', e.target.value)}><option value="">選擇帳戶</option>{userAccounts.filter(a => a.id !== accountId).map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>
                    </div>
                );
            }
            if (type === 'advance' || type === 'repay') {
                return (
                    <div className="flex flex-col gap-1 mt-2">
                        <label className="text-xs text-muji-muted font-bold">{type === 'advance' ? '代墊對象' : '還款來源 (對象)'}</label>
                        <div className="flex gap-2">
                             <select className="flex-1 p-2 bg-muji-card rounded border border-muji-border text-sm text-muji-text" value={targetName} onChange={e => onChange('targetName', e.target.value)}><option value="">選擇對象...</option>{debtTargets.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}</select>
                             <button onClick={() => { const name = prompt("新增對象:"); if(name) onAddTarget(name); }} className="p-2 bg-muji-bg border border-muji-border rounded text-xs"><LucideIcon name="plus" className="w-4 h-4" /></button>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const SplitSection = ({ amount, splits, setSplits, debtTargets, onAddTarget, flatCategories, categoryGroups, type }) => {
            const totalAmount = parseFloat(amount) || 0;
            const safeSplits = Array.isArray(splits) ? splits : [];
            const [selectingCategoryIdx, setSelectingCategoryIdx] = useState(null);
            const [selectedGroup, setSelectedGroup] = useState('food'); 

            useEffect(() => { setSelectedGroup(type === 'income' ? 'active' : 'food'); }, [type]);
            useEffect(() => { if (safeSplits.length === 0 && totalAmount > 0) { const defCat = type === 'income' ? 'active_薪資' : 'food_三餐'; setSplits([{ owner: 'me', name: '我', amount: totalAmount, percent: '', categoryId: Object.keys(flatCategories)[0] || defCat, type: type }]); } }, [totalAmount, type]); 

            const splitTotal = safeSplits.reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
            const isValid = Math.abs(totalAmount - splitTotal) < 1;

            const addSplit = () => { const defCat = type === 'income' ? 'active_薪資' : 'food_三餐'; const newSplit = { owner: 'me', name: '我', amount: 0, percent: '', categoryId: safeSplits[0]?.categoryId || defCat, type: type }; setSplits([...safeSplits, newSplit]); };
            const updateSplit = (idx, field, val) => {
                let newSplits = [...safeSplits];
                let newSplit = { ...newSplits[idx], [field]: val };
                if(field === 'owner') {
                    if (val === 'me') { newSplit.name = '我'; newSplit.percent = ''; newSplit.type = type; } 
                    else if (val === '__add_new__') { const newT = prompt("輸入新對象姓名"); if (newT) { onAddTarget(newT); newSplit.owner = newT; newSplit.name = newT; } else return; } 
                    else { newSplit.name = val; if (type === 'expense') newSplit.type = 'advance'; else if (type === 'income') newSplit.type = 'repay'; const targetObj = debtTargets.find(t => t.name === val); if (targetObj && targetObj.defaultPercent) { const pct = parseFloat(targetObj.defaultPercent); newSplit.percent = pct; newSplit.amount = Math.round(totalAmount * (pct / 100)); } }
                } else if (field === 'percent') { const pct = parseFloat(val); if (!isNaN(pct)) { newSplit.amount = Math.round(totalAmount * (pct / 100)); } else { newSplit.percent = ''; }
                } else if (field === 'amount') { newSplit.percent = ''; } else if (field === 'type') { newSplit.type = val; }
                newSplits[idx] = newSplit;
                const mainMeIndex = newSplits.findIndex(s => s.owner === 'me');
                if (mainMeIndex !== -1 && idx !== mainMeIndex) { const otherSum = newSplits.reduce((sum, s, i) => i === mainMeIndex ? sum : sum + (parseFloat(s.amount) || 0), 0); const residual = totalAmount - otherSum; if (residual >= 0) newSplits[mainMeIndex] = { ...newSplits[mainMeIndex], amount: residual, percent: '' }; }
                setSplits(newSplits);
            };
            const removeSplit = (idx) => { let newSplits = safeSplits.filter((_, i) => i !== idx); const mainMeIndex = newSplits.findIndex(s => s.owner === 'me'); if (mainMeIndex !== -1) { const otherSum = newSplits.reduce((sum, s, i) => i === mainMeIndex ? sum : sum + (parseFloat(s.amount) || 0), 0); newSplits[mainMeIndex] = { ...newSplits[mainMeIndex], amount: totalAmount - otherSum }; } setSplits(newSplits); };

            return (
                <div className="mt-4 p-3 bg-muji-bg rounded-lg border border-muji-border text-sm animate-fade">
                    <div className="flex justify-between items-center mb-2"><span className="font-bold text-muji-text">{type === 'income' ? '多類別明細' : '分帳 / 多類別明細'}</span><span className={`text-xs font-mono ${isValid ? 'text-muji-green' : 'text-muji-red'}`}>合計: ${splitTotal.toLocaleString()} {isValid ? 'OK' : `(差 ${totalAmount - splitTotal})`}</span></div>
                    <div className="space-y-2">
                        {safeSplits.map((s, idx) => {
                            const cat = flatCategories[s.categoryId] || {};
                            const rowTypeOptions = type === 'expense' ? [{val: 'expense', label: '支出'}, {val: 'advance', label: '代墊'}] : [{val: 'income', label: '收入'}, {val: 'repay', label: '還款'}];
                            return (
                                <div key={idx} className="flex flex-col gap-1 p-2 bg-white rounded border border-muji-border shadow-sm">
                                    <div className="flex gap-2">
                                        <select className="w-1/4 p-1.5 bg-muji-bg rounded border border-muji-border text-xs text-muji-text font-bold" value={s.owner === 'me' ? 'me' : s.name} onChange={e => updateSplit(idx, 'owner', e.target.value)}><option value="me">我</option><optgroup label="對象">{debtTargets.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}</optgroup><option value="__add_new__">+ 新增...</option></select>
                                        <select className={`w-1/4 p-1.5 rounded border border-muji-border text-xs font-bold ${s.type === 'advance' ? 'bg-orange-50 text-orange-600' : 'bg-muji-bg text-muji-text'}`} value={s.type || type} onChange={e => updateSplit(idx, 'type', e.target.value)} disabled={s.owner === 'me'}>{rowTypeOptions.map(opt => <option key={opt.val} value={opt.val}>{opt.label}</option>)}</select>
                                        <button className="flex-1 p-1.5 bg-muji-bg rounded border border-muji-border text-xs text-muji-text flex items-center justify-between" onClick={() => { setSelectingCategoryIdx(idx); if (cat.group) { let foundGroupId = 'food'; for(let type in categoryGroups) { for(let g of categoryGroups[type]) { if(g.label === cat.group) { foundGroupId = g.id; break; } } } setSelectedGroup(foundGroupId); } else { setSelectedGroup(type === 'income' ? 'active' : 'food'); } }}><span className="flex items-center gap-1">{cat.icon && <LucideIcon name={cat.icon} className="w-3 h-3" />}{cat.name || '選擇分類'}</span><LucideIcon name="chevron-down" className="w-3 h-3 text-muji-muted" /></button>
                                    </div>
                                    <div className="flex gap-2 items-center">
                                        <div className="relative w-20"><input type="number" className="w-full p-1.5 pl-1 pr-4 bg-white rounded border border-muji-border text-xs text-center text-muji-text font-mono" placeholder="%" value={s.percent || ''} onChange={e => updateSplit(idx, 'percent', e.target.value)} /><span className="absolute right-1.5 top-1.5 text-xs text-muji-muted">%</span></div>
                                        <div className="relative flex-1"><span className="absolute left-2 top-1.5 text-xs text-muji-muted">$</span><input type="number" className="w-full p-1.5 pl-4 bg-white rounded border border-muji-border text-xs text-muji-text font-mono font-bold" placeholder="金額" value={s.amount} onChange={e => updateSplit(idx, 'amount', e.target.value)} /></div>
                                        <button onClick={() => removeSplit(idx)} className="p-1.5 text-muji-muted hover:text-muji-red hover:bg-muji-bg rounded transition-colors"><LucideIcon name="trash-2" className="w-4 h-4" /></button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <button onClick={addSplit} className="w-full py-2 border border-dashed border-muji-accent text-muji-accent text-xs rounded hover:bg-white transition-colors flex items-center justify-center gap-1 mt-3"><LucideIcon name="plus" className="w-3 h-3" /> 新增明細</button>
                    {selectingCategoryIdx !== null && (<div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-pop" onClick={() => setSelectingCategoryIdx(null)}><div className="bg-muji-card w-full max-w-sm rounded-xl shadow-2xl overflow-hidden border border-muji-border flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}><div className="p-4 border-b border-muji-border flex justify-between items-center bg-muji-bg"><h3 className="font-bold text-lg text-muji-text">選擇分類</h3><button onClick={() => setSelectingCategoryIdx(null)} className="p-2 hover:bg-black/5 rounded-full"><LucideIcon name="x" className="w-5 h-5 text-muji-muted" /></button></div><div className="p-4 overflow-y-auto custom-scrollbar"><CategorySelector type={type === 'income' ? 'income' : 'expense'} categoryGroups={categoryGroups} selectedGroup={selectedGroup} setSelectedGroup={setSelectedGroup} onSelectCategory={(catId) => { updateSplit(selectingCategoryIdx, 'categoryId', catId); setSelectingCategoryIdx(null); }} currentCategory={safeSplits[selectingCategoryIdx]?.categoryId} /></div></div></div>)}
                </div>
            );
        };

        const SmartImportModal = ({ onClose, importText, setImportText, previewData, setPreviewData, saveData, data, handleSmartImport, flatCategories, userAccounts, selectedAccount }) => {
            const [showCategoryPicker, setShowCategoryPicker] = useState(false);
            const [editingPreviewIndex, setEditingPreviewIndex] = useState(null);
            const [selectedGroup, setSelectedGroup] = useState('food');
            const [targetAccountId, setTargetAccountId] = useState(selectedAccount || (userAccounts.length > 0 ? userAccounts[0].id : ''));
            const [showExitConfirm, setShowExitConfirm] = useState(false);
            
            const doSmartImport = () => { handleSmartImport(targetAccountId); };
            const handleAttemptClose = (reason) => { if (reason === 'close_btn') onClose(); else if (previewData.length > 0 || importText.trim().length > 0) setShowExitConfirm(true); else onClose(); };
            const confirmClose = () => { setShowExitConfirm(false); onClose(); };
            return (
                <Modal title="AI 記帳" onClose={handleAttemptClose}>
                    {previewData.length === 0 ? (
                        <div className="space-y-4">
                            <div className="flex flex-col gap-1"><label className="text-xs text-muji-muted font-bold">匯入至帳戶</label><select className="w-full p-2 bg-muji-card rounded border border-muji-border text-sm text-muji-text" value={targetAccountId} onChange={(e) => setTargetAccountId(e.target.value)}>{userAccounts.map(acc => <option key={acc.id} value={acc.id}>{acc.name}</option>)}</select></div>
                            <textarea className="w-full h-40 p-3 bg-white rounded-lg text-sm border border-muji-border focus:border-muji-accent outline-none text-muji-text" placeholder="直接貼上..." value={importText} onChange={e => setImportText(e.target.value)}></textarea>
                            <button onClick={doSmartImport} className="w-full py-3 bg-muji-accent text-white rounded-lg font-bold shadow-sm">解析</button>
                        </div>
                    ) : (
                         <div className="space-y-4">
                            {!showCategoryPicker ? (
                                <>
                                    <div className="max-h-[60vh] overflow-y-auto space-y-3 custom-scrollbar pr-1">{previewData.map((item, idx) => (<div key={item.id || idx} className="flex flex-col gap-2 p-3 bg-muji-card rounded-lg text-sm border border-muji-border shadow-sm"><div className="flex justify-between items-center gap-2"><input type="date" className="bg-transparent border-b border-muji-border focus:border-muji-accent outline-none font-mono text-muji-text w-28 text-xs" value={item.date} onChange={(e) => { const n = [...previewData]; n[idx].date = e.target.value; setPreviewData(n); }} /><select className="bg-transparent font-bold outline-none cursor-pointer text-xs flex-1" value={item.type} onChange={(e) => { const n = [...previewData]; n[idx].type = e.target.value; setPreviewData(n); }}>{Object.entries(TX_TYPES).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}</select><input type="number" className="bg-transparent font-bold font-mono outline-none w-20 text-right border-b border-muji-border focus:border-muji-accent text-muji-text" value={item.amount} onChange={(e) => { const n = [...previewData]; n[idx].amount = parseFloat(e.target.value); setPreviewData(n); }} /><button onClick={() => setPreviewData(previewData.filter((_, i) => i !== idx))} className="text-muji-muted hover:text-muji-red"><LucideIcon name="trash-2" className="w-4 h-4" /></button></div><div className="flex items-center gap-2">{(item.type === 'expense' || item.type === 'income') && (<button onClick={() => { setEditingPreviewIndex(idx); setShowCategoryPicker(true); }} className="flex-1 text-left px-2 py-1.5 rounded bg-white border border-muji-border text-xs flex items-center gap-2 hover:border-muji-accent text-muji-text"><LucideIcon name={flatCategories[item.categoryId]?.icon || 'tag'} className="w-3 h-3" />{flatCategories[item.categoryId]?.name || '選擇分類'}</button>)}<ExtraFieldsInput type={item.type} accountId={item.accountId} toAccountId={item.toAccountId} targetName={item.targetName} userAccounts={userAccounts} selectedAccount={item.accountId} onChange={(k, v) => { const n = [...previewData]; n[idx][k] = v; setPreviewData(n); }} debtTargets={data.debtTargets} onAddTarget={() => {}} /></div><input type="text" className="w-full bg-transparent border-b border-muji-border focus:border-muji-accent outline-none text-muji-text text-xs placeholder-muji-muted" placeholder="備註..." value={item.note} onChange={(e) => { const n = [...previewData]; n[idx].note = e.target.value; setPreviewData(n); }} /></div>))}</div>
                                    <div className="flex gap-2 pt-2"><button onClick={() => setPreviewData([])} className="flex-1 py-3 bg-white text-muji-text rounded-lg font-bold border border-muji-border">放棄</button><button onClick={() => { saveData({...data, transactions: [...data.transactions, ...previewData], debtTargets: data.debtTargets }); setPreviewData([]); onClose(); }} className="flex-[2] py-3 bg-muji-accent text-white rounded-lg font-bold shadow-sm">確認匯入 ({previewData.length})</button></div>
                                </>
                            ) : (
                                <div className="animate-fade"><div className="flex justify-between items-center mb-4"><h4 className="font-bold text-muji-text">選擇分類</h4><button onClick={() => setShowCategoryPicker(false)} className="text-muji-muted">取消</button></div><CategorySelector type={previewData[editingPreviewIndex].type} categoryGroups={DEFAULT_CATEGORY_GROUPS} selectedGroup={selectedGroup} setSelectedGroup={setSelectedGroup} onSelectCategory={(catId) => { const n = [...previewData]; n[editingPreviewIndex].categoryId = catId; setPreviewData(n); setShowCategoryPicker(false); }} /></div>
                            )}
                        </div>
                    )}
                    {showExitConfirm && (<div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm animate-pop cursor-auto" onClick={(e) => e.stopPropagation()}><div className="bg-white p-6 rounded-xl shadow-xl border border-muji-border w-full max-w-sm"><h4 className="font-bold text-lg mb-2 text-muji-text">確認中斷</h4><p className="text-sm text-muji-muted mb-4">內容尚未儲存，確定要中斷記帳嗎？</p><div className="flex gap-3"><button onClick={() => setShowExitConfirm(false)} className="flex-1 py-2 rounded-lg border border-muji-border text-muji-muted hover:bg-muji-bg">繼續編輯</button><button onClick={confirmClose} className="flex-1 py-2 rounded-lg bg-muji-red text-white font-bold shadow-sm">確定中斷</button></div></div></div>)}
                </Modal>
            );
        };

        const TransactionModal = ({ onClose, isEditMode, newTx, setNewTx, isSplitMode, setIsSplitMode, splitTotal, setSplitTotal, splits, setSplits, categoryGroups, flatCategories, userAccounts, selectedAccount, saveTransaction, handleDeleteTransaction, data, saveData, showToast }) => {
            const [selectedGroup, setSelectedGroup] = useState(flatCategories[newTx.categoryId]?.group || (newTx.type === 'income' ? 'active' : 'food'));
            const [showBalanceConfirm, setShowBalanceConfirm] = useState(false);
            const [pendingBalanceDiff, setPendingBalanceDiff] = useState(0);
            const [showExitConfirm, setShowExitConfirm] = useState(false);
            const debtTargets = data.debtTargets || [];
            
            const handleAddTarget = (name) => {
                if (!name) return;
                const currentTargets = data.debtTargets || [];
                if (currentTargets.some(t => t.name === name)) return;
                const newTargets = [...currentTargets, { id: `dt_${Date.now()}`, name, defaultPercent: '' }];
                saveData({ ...data, debtTargets: newTargets }, false); 
            };

            const handleSave = () => { 
                const finalAccountId = newTx.accountId || selectedAccount || (userAccounts.length > 0 ? userAccounts[0].id : '');

                if (!finalAccountId && newTx.type !== 'transfer') {
                     if(showToast) showToast('請選擇帳戶', 'error');
                     return;
                }

                if ((newTx.type === 'expense' || newTx.type === 'income') && isSplitMode) {
                     const safeSplits = (splits || []).filter(s => s.name && parseFloat(s.amount) > 0);
                     const total = parseFloat(splitTotal || 0);
                     const splitSum = safeSplits.reduce((acc, s) => acc + (parseFloat(s.amount) || 0), 0);
                     const diff = total - splitSum;
                     
                     if (diff > 1) {
                         setPendingBalanceDiff(diff);
                         setShowBalanceConfirm(true);
                         return;
                     } else if (diff < -1) {
                         if(showToast) showToast('分帳金額超過總金額', 'error');
                         return;
                     }

                     const linkId = Date.now().toString(); 
                     const txsToSave = safeSplits.map((s, idx) => {
                        const isMe = s.owner === 'me';
                        let txType = s.type || newTx.type; 
                        let targetName = '';
                        
                        if (!isMe) {
                            targetName = s.name;
                            if (!s.type) {
                                if (newTx.type === 'expense') txType = 'advance'; 
                                else if (newTx.type === 'income') txType = 'repay';
                            }
                        }

                        return {
                            id: linkId + '_' + idx, 
                            linkId: linkId, 
                            date: newTx.date,
                            type: txType,
                            accountId: finalAccountId, 
                            toAccountId: '', 
                            amount: parseFloat(s.amount),
                            note: newTx.note + (s.note ? ` (${s.note})` : ''), 
                            categoryId: s.categoryId,
                            targetName: targetName,
                            splits: [] 
                        };
                     });

                     saveTransaction(txsToSave, data.debtTargets); 

                } else {
                     const txToSave = { 
                         ...newTx, 
                         id: newTx.id || Date.now().toString(),
                         amount: parseFloat(newTx.amount),
                         accountId: finalAccountId,
                         splits: [] 
                     };
                     saveTransaction(txToSave, data.debtTargets); 
                }
            };

            const handleUpdateField = (key, value) => {
                if (key === 'swap_accounts') {
                     setNewTx({ ...newTx, accountId: value.to, toAccountId: value.from });
                } else {
                     setNewTx({...newTx, [key]: value});
                }
            };

            const handleConfirmBalance = () => {
                const safeSplits = (splits || []).filter(s => s.name && parseFloat(s.amount) > 0);
                const defCat = newTx.type === 'income' ? 'active_薪資' : 'food_三餐';
                safeSplits.push({
                     owner: 'me',
                     name: '我',
                     amount: pendingBalanceDiff,
                     percent: '',
                     categoryId: newTx.categoryId || defCat,
                     type: newTx.type
                });
                
                const linkId = Date.now().toString();
                const finalAccountId = newTx.accountId || selectedAccount || (userAccounts.length > 0 ? userAccounts[0].id : '');

                const txsToSave = safeSplits.map((s, idx) => {
                    const isMe = s.owner === 'me';
                    let txType = s.type || newTx.type;
                    let targetName = '';
                    
                    if (!isMe) {
                        targetName = s.name;
                        if(!s.type) txType = newTx.type === 'expense' ? 'advance' : 'repay';
                    }

                    return {
                        id: linkId + '_' + idx,
                        linkId: linkId,
                        date: newTx.date,
                        type: txType,
                        accountId: finalAccountId,
                        amount: parseFloat(s.amount),
                        note: newTx.note,
                        categoryId: s.categoryId,
                        targetName: targetName,
                        splits: []
                    };
                });

                saveTransaction(txsToSave, data.debtTargets);
                setShowBalanceConfirm(false);
            };

            const toggleSplitMode = () => {
                 const nextMode = !isSplitMode;
                 setIsSplitMode(nextMode);

                 if (nextMode) {
                     setSplitTotal(newTx.amount.toString() || '0');
                     if ((newTx.splits || []).length === 0) {
                         const defCat = newTx.type === 'income' ? 'active_薪資' : 'food_三餐';
                         setSplits([{ 
                             owner: 'me', 
                             name: '我', 
                             amount: newTx.amount || '', 
                             percent: '', 
                             categoryId: newTx.categoryId || 'food_伙食' 
                         }]);
                     } else {
                         setSplits(newTx.splits);
                     }
                 } else {
                     setSplitTotal('');
                     setSplits([]);
                 }
            }

            const handleAttemptClose = (reason) => {
                if (reason === 'close_btn') {
                    onClose();
                } else {
                    setShowExitConfirm(true);
                }
            };

            const confirmClose = () => {
                setShowExitConfirm(false);
                onClose();
            };
            
            return (
                <Modal title={isEditMode ? "編輯交易" : "記一筆"} onClose={handleAttemptClose}>
                    <div className="space-y-4">
                        <div className="flex justify-between items-center overflow-x-auto no-scrollbar pb-2">
                            <div className="flex bg-muji-bg rounded-lg p-1">
                                {Object.entries(TX_TYPES).map(([k, v]) => {
                                    if (newTx.isQuickAdd && k !== 'expense') return null;
                                    const isDisabled = isSplitMode && k !== newTx.type && k !== 'expense' && k !== 'income'; 
                                    
                                    return (
                                        <button 
                                            key={k} 
                                            disabled={isDisabled} 
                                            className={`px-3 py-1.5 rounded text-xs font-bold transition whitespace-nowrap ${newTx.type === k ? 'bg-muji-card shadow-sm text-muji-accent border border-muji-border' : 'text-muji-muted'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`} 
                                            onClick={() => { 
                                                let defCat = 'food_三餐'; 
                                                let defGroup = 'food'; 
                                                if(k === 'income') { defCat = 'active_薪資'; defGroup = 'active'; }
                                                setNewTx({...newTx, type: k, categoryId: defCat}); 
                                                setSelectedGroup(defGroup); 
                                                if(isSplitMode) {
                                                    setSplits([{ 
                                                        owner: 'me', name: '我', amount: splitTotal, percent: '', categoryId: defCat, type: k 
                                                    }]);
                                                }
                                            }}
                                        >
                                            {v.label}
                                        </button>
                                    );
                                })}
                            </div>
                            
                            {['expense', 'income'].includes(newTx.type) && !newTx.isQuickAdd && (
                                <div className="flex items-center gap-2 ml-2">
                                    <span className="text-xs text-muji-text font-bold whitespace-nowrap">拆帳/代墊</span>
                                    <button onClick={toggleSplitMode} className={`w-8 h-5 rounded-full p-0.5 transition-colors flex-shrink-0 ${isSplitMode ? 'bg-muji-accent' : 'bg-muji-border'}`}>
                                        <div className={`w-4 h-4 bg-white rounded-full transition-transform ${isSplitMode ? 'translate-x-3' : ''}`}></div>
                                    </button>
                                </div>
                            )}
                        </div>

                        <input type="number" 
                            className="w-full text-4xl font-bold text-center py-4 bg-transparent border-b border-muji-border outline-none font-mono text-muji-text" 
                            placeholder={isSplitMode ? "總金額" : "0"} 
                            autoFocus={!isSplitMode} 
                            value={isSplitMode ? splitTotal : newTx.amount} 
                            onChange={e => isSplitMode ? setSplitTotal(e.target.value) : setNewTx({...newTx, amount: e.target.value})} 
                        />
                        
                        {['expense', 'income'].includes(newTx.type) && isSplitMode ? (
                            <SplitSection 
                                amount={splitTotal} 
                                splits={splits} 
                                setSplits={setSplits} 
                                debtTargets={debtTargets} 
                                flatCategories={flatCategories}
                                isWithOthersMode={true} 
                                onAddTarget={handleAddTarget}
                                categoryGroups={categoryGroups}
                                type={newTx.type}
                            />
                        ) : (
                            <>
                                <CategorySelector 
                                    type={newTx.type} 
                                    categoryGroups={categoryGroups} 
                                    selectedGroup={selectedGroup} 
                                    setSelectedGroup={setSelectedGroup} 
                                    onSelectCategory={(catId) => setNewTx({...newTx, categoryId: catId})} 
                                    currentCategory={newTx.categoryId} 
                                />
                                <ExtraFieldsInput 
                                    type={newTx.type} 
                                    accountId={newTx.accountId}
                                    toAccountId={newTx.toAccountId} 
                                    targetName={newTx.targetName} 
                                    userAccounts={userAccounts} 
                                    selectedAccount={selectedAccount} 
                                    onChange={handleUpdateField} 
                                    debtTargets={debtTargets} 
                                    onAddTarget={() => {}} 
                                />
                                {newTx.type !== 'transfer' && !selectedAccount && (
                                     <div className="flex flex-col gap-1 mt-2">
                                        <label className="text-xs text-muji-muted font-bold">帳戶</label>
                                        <select 
                                            className="p-2 bg-muji-card rounded border border-muji-border text-sm w-full text-muji-text" 
                                            value={newTx.accountId} 
                                            onChange={e => setNewTx({...newTx, accountId: e.target.value})}
                                        >
                                            <option value="">選擇帳戶</option>
                                            {userAccounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                        </select>
                                    </div>
                                )}
                            </>
                        )}
                        
                        <div className="flex gap-2 mt-4">
                            <input type="date" className="flex-1 p-3 bg-muji-card rounded-lg text-muji-text border border-muji-border" value={newTx.date} onChange={e => setNewTx({...newTx, date: e.target.value})} />
                            <input type="text" className="flex-[2] p-3 bg-muji-card rounded-lg text-muji-text border border-muji-border" placeholder="備註" value={newTx.note} onChange={e => setNewTx({...newTx, note: e.target.value})} />
                        </div>
                        
                        {newTx.isQuickAdd && (
                            <div className="text-xs text-muji-muted text-center mt-1">
                                (快速記帳模式：已鎖定為現金支出)
                            </div>
                        )}

                        <div className="flex gap-3 pt-2">
                            {isEditMode && <button onClick={handleDeleteTransaction} className="flex-1 py-3 bg-muji-red/10 text-muji-red rounded-lg font-bold border border-muji-red/30">刪除</button>}
                            <button onClick={handleSave} className="flex-[2] py-3 bg-muji-accent text-white rounded-lg font-bold shadow-sm">{isEditMode ? "更新" : "儲存"}</button>
                        </div>
                    </div>

                    {showBalanceConfirm && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm animate-pop">
                            <div className="bg-white p-6 rounded-xl shadow-xl border border-muji-border w-full max-w-sm">
                                <h4 className="font-bold text-lg mb-2 text-muji-text">確認餘額分配</h4>
                                <p className="text-sm text-muji-muted mb-4">
                                    尚有餘額 <span className="font-bold text-muji-text">${pendingBalanceDiff.toLocaleString()}</span> 未分配。<br/>
                                    是否自動歸入「我」的支出？
                                </p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowBalanceConfirm(false)} className="flex-1 py-2 rounded-lg border border-muji-border text-muji-muted hover:bg-muji-bg">手動調整</button>
                                    <button onClick={handleConfirmBalance} className="flex-1 py-2 rounded-lg bg-muji-accent text-white font-bold shadow-sm">是，自動歸入</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showExitConfirm && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm animate-pop cursor-auto" onClick={(e) => e.stopPropagation()}>
                            <div className="bg-white p-6 rounded-xl shadow-xl border border-muji-border w-full max-w-sm">
                                <h4 className="font-bold text-lg mb-2 text-muji-text">確認中斷</h4>
                                <p className="text-sm text-muji-muted mb-4">內容尚未儲存，確定要中斷記帳嗎？</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowExitConfirm(false)} className="flex-1 py-2 rounded-lg border border-muji-border text-muji-muted hover:bg-muji-bg">繼續編輯</button>
                                    <button onClick={confirmClose} className="flex-1 py-2 rounded-lg bg-muji-red text-white font-bold shadow-sm">確定中斷</button>
                                </div>
                            </div>
                        </div>
                    )}
                </Modal>
            );
        };

        const AccountingView = ({ data, saveData, selectedAccount, setSelectedAccount, setInputModal, showToast, initialTab }) => {
            const [showImport, setShowImport] = useState(false); const [importText, setImportText] = useState(''); const [previewData, setPreviewData] = useState([]);
            const [showAdd, setShowAdd] = useState(false); const [isEditMode, setIsEditMode] = useState(false); const [editingTxId, setEditingTxId] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date()); const [showDatePicker, setShowDatePicker] = useState(false);
            const [isSplitMode, setIsSplitMode] = useState(false); const [splitTotal, setSplitTotal] = useState(''); const [splits, setSplits] = useState([]);
            const [newTx, setNewTx] = useState({ amount: '', note: '', type: 'expense', categoryId: 'food_伙食', date: new Date().toISOString().split('T')[0], toAccountId: '', targetName: '', splits: [] });
            const [filterType, setFilterType] = useState('all'); 
            const [activeTab, setActiveTab] = useState('all_grid'); 

            useEffect(() => {
                if(initialTab) setActiveTab(initialTab);
            }, [initialTab]);

            const [selectedTxIds, setSelectedTxIds] = useState([]);
            const [showDeleteBatchConfirm, setShowDeleteBatchConfirm] = useState(false);
            const [expandedTypes, setExpandedTypes] = useState(['recent']); 
            const [expandedGroups, setExpandedGroups] = useState({});

            const categoryGroups = data.settings?.categoryGroups || DEFAULT_CATEGORY_GROUPS;
            const accountTypes = data.settings?.accountTypes || DEFAULT_ACCOUNT_TYPES;
            const flatCategories = useMemo(() => getFlatCategories(categoryGroups), [categoryGroups]);
            
            const userAccounts = data.accounts; 

            const accountLastModified = useMemo(() => {
                const map = {};
                userAccounts.forEach(a => map[a.id] = 0);
                
                data.transactions.forEach(t => {
                    const time = new Date(t.date).getTime();
                    if (map.hasOwnProperty(t.accountId)) {
                        if (time > map[t.accountId]) map[t.accountId] = Math.max(map[t.accountId], time);
                    }
                    if (t.toAccountId && map.hasOwnProperty(t.toAccountId)) {
                        if (time > map[t.toAccountId]) map[t.toAccountId] = Math.max(map[t.toAccountId], time);
                    }
                });
                return map;
            }, [data.transactions, userAccounts]);

            const accountMonthlyExpenses = useMemo(() => {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                
                const expenses = {};
                
                data.transactions.forEach(t => {
                    const d = new Date(t.date);
                    if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
                        if (t.type === 'expense' && t.accountId) {
                            let amount = t.amount || 0;
                            if (t.splits && t.splits.length > 0) {
                                const othersAmount = t.splits.reduce((acc, s) => {
                                    return s.owner !== 'me' ? acc + (parseFloat(s.amount) || 0) : acc;
                                }, 0);
                                amount -= othersAmount;
                            }
                            
                            if (amount > 0) {
                                expenses[t.accountId] = (expenses[t.accountId] || 0) + amount;
                            }
                        }
                    }
                });
                return expenses;
            }, [data.transactions]);
            
            const monthlyExpenseAccounts = useMemo(() => {
                const list = userAccounts.filter(acc => (accountMonthlyExpenses[acc.id] || 0) > 0);
                return list.sort((a, b) => (accountMonthlyExpenses[b.id] || 0) - (accountMonthlyExpenses[a.id] || 0));
            }, [userAccounts, accountMonthlyExpenses]);

            const totalMonthlyExpenseSum = useMemo(() => {
                return monthlyExpenseAccounts.reduce((sum, acc) => sum + (accountMonthlyExpenses[acc.id] || 0), 0);
            }, [monthlyExpenseAccounts, accountMonthlyExpenses]);

            const resetForm = () => { setNewTx({ amount: '', note: '', type: 'expense', categoryId: 'food_伙食', date: new Date().toISOString().split('T')[0], toAccountId: '', targetName: '', splits: [] }); setIsSplitMode(false); setSplitTotal(''); setSplits([]); setIsEditMode(false); setEditingTxId(null); };

            const openEdit = (tx) => { setNewTx({ ...tx, amount: tx.amount.toString(), accountId: tx.accountId || selectedAccount }); if(tx.splits && tx.splits.length > 0) { setIsSplitMode(true); setSplitTotal(tx.amount.toString()); setSplits(tx.splits); } else { setIsSplitMode(false); setSplitTotal(''); setSplits([]); } setIsEditMode(true); setEditingTxId(tx.id); setShowAdd(true); };

            const getRecentAccounts = useCallback(() => {
                const sorted = [...userAccounts].sort((a, b) => {
                    const timeA = accountLastModified[a.id] || 0;
                    const timeB = accountLastModified[b.id] || 0;
                    if (timeB === timeA) return 0; 
                    return timeB - timeA;
                });
                return sorted.slice(0, 4);
            }, [userAccounts, accountLastModified]);

            const getFilteredTransactions = useCallback(() => { 
                const account = data.accounts.find(a => a.id === selectedAccount);
                const closingDay = (account?.type === 'credit' && account?.closingDay) ? parseInt(account.closingDay) : null;
                
                let start, end;
                const y = currentDate.getFullYear();
                const m = currentDate.getMonth();

                if (closingDay) {
                    start = new Date(y, m - 1, closingDay + 1);
                    end = new Date(y, m, closingDay);
                    end.setHours(23, 59, 59, 999);
                    start.setHours(0, 0, 0, 0);
                } else {
                    start = new Date(y, m, 1);
                    end = new Date(y, m + 1, 0);
                    end.setHours(23, 59, 59, 999);
                    start.setHours(0, 0, 0, 0);
                }

                let txs = data.transactions.filter(t => { 
                    const d = new Date(t.date); 
                    const isRelated = t.accountId === selectedAccount || t.toAccountId === selectedAccount; 
                    return d >= start && d <= end && isRelated;
                });
                
                if (filterType !== 'all') {
                    txs = txs.filter(t => t.type === filterType);
                }

                return txs.sort((a, b) => { const dateDiff = new Date(b.date) - new Date(a.date); if (dateDiff !== 0) return dateDiff; if (b.id < a.id) return -1; if (b.id > a.id) return 1; return 0; }); 
            }, [data.transactions, currentDate, selectedAccount, filterType]);

            const filteredTxs = useMemo(() => {
                if (!selectedAccount) return [];
                return getFilteredTransactions();
            }, [selectedAccount, getFilteredTransactions]);

            const currentMonthStats = useMemo(() => {
                let income = 0;
                let expense = 0;
                filteredTxs.forEach(t => {
                    if (t.type === 'income') income += (t.amount || 0);
                    if (t.type === 'expense') {
                        let myAmount = t.amount || 0;
                        if (t.splits && t.splits.length > 0) {
                             const others = t.splits.reduce((acc, s) => s.owner !== 'me' ? acc + (parseFloat(s.amount)||0) : acc, 0);
                             myAmount -= others;
                        }
                        expense += myAmount;
                    }
                });
                return { income, expense };
            }, [filteredTxs]);

            const groupedTxs = []; 
            let skipIds = new Set();
            filteredTxs.forEach(tx => {
                if (skipIds.has(tx.id)) return;
                if (tx.linkId) {
                    const groupParts = filteredTxs.filter(t => t.linkId === tx.linkId);
                    if (groupParts.length > 1) {
                        const totalAmount = groupParts.reduce((sum, t) => sum + t.amount, 0);
                        const headerTx = { ...tx, id: 'group_' + tx.linkId, isGroupHeader: true, totalAmount: totalAmount, subTransactions: groupParts };
                        groupedTxs.push(headerTx);
                        groupParts.forEach(t => skipIds.add(t.id));
                    } else { groupedTxs.push(tx); skipIds.add(tx.id); }
                } else { groupedTxs.push(tx); skipIds.add(tx.id); }
            });

            const handleDuplicateTx = (tx) => { const newTx = JSON.parse(JSON.stringify(tx)); newTx.id = Date.now().toString(); delete newTx.linkId; const newTransactions = [...data.transactions, newTx]; saveData({ ...data, transactions: newTransactions }); showToast('已複製並新增一筆交易'); };
            const handleSaveTransaction = (txsToSave, newDebtTargets) => {
                let updatedTransactions = [...data.transactions]; let updatedDebtTargets = data.debtTargets || []; if(newDebtTargets) updatedDebtTargets = newDebtTargets;
                const txsArray = Array.isArray(txsToSave) ? txsToSave : [txsToSave];
                if (isEditMode && editingTxId) { const oldTx = data.transactions.find(t => t.id === editingTxId); if(oldTx && oldTx.linkId) { updatedTransactions = updatedTransactions.filter(t => t.id !== editingTxId); } else { updatedTransactions = updatedTransactions.filter(t => t.id !== editingTxId); } }
                updatedTransactions = [...updatedTransactions, ...txsArray];
                saveData({ ...data, transactions: updatedTransactions, debtTargets: updatedDebtTargets });
                setShowAdd(false); resetForm();
            };
            const handleDelete = (txToDelete) => { 
                const targetId = txToDelete?.id || editingTxId; const tx = txToDelete || data.transactions.find(t => t.id === targetId);
                if (!tx) return;
                let updatedTransactions = [...data.transactions];
                if (tx.linkId) { const group = updatedTransactions.filter(t => t.linkId === tx.linkId && t.id !== tx.id); if (group.length > 0) { let mainTxIndex = group.findIndex(t => !t.targetName || t.targetName === '我'); if (mainTxIndex === -1) mainTxIndex = 0; const mainTx = group[mainTxIndex]; const newAmount = mainTx.amount + tx.amount; const mainTxGlobalIndex = updatedTransactions.findIndex(t => t.id === mainTx.id); if (mainTxGlobalIndex !== -1) { updatedTransactions[mainTxGlobalIndex] = { ...mainTx, amount: newAmount }; } updatedTransactions = updatedTransactions.filter(t => t.id !== tx.id); saveData({ ...data, transactions: updatedTransactions }); setShowAdd(false); showToast(`已刪除並將 $${tx.amount} 加回 ${mainTx.targetName || '我'}`); return; } }
                updatedTransactions = updatedTransactions.filter(t => t.id !== targetId); saveData({ ...data, transactions: updatedTransactions }); setShowAdd(false); 
            };
            const handleDeleteTransaction = () => handleDelete(null);
            
            const toggleGroup = (linkId) => { 
                setExpandedGroups(prev => {
                    const isCurrentlyOpen = prev[linkId] !== undefined ? prev[linkId] : true;
                    return { ...prev, [linkId]: !isCurrentlyOpen };
                }); 
            };
            
            const handleSmartImport = (targetAccountId, hintType) => { 
                const rawLines = importText.split('\n').map(l => l.trim()).filter(l => l); const parsed = []; const currentYear = new Date().getFullYear(); const parseNum = (str) => parseFloat(str.replace(/,/g, '')); const isNum = (str) => /^\d{1,3}(,\d{3})*(\.\d+)?$/.test(str); const dateRegexFull = /^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/; const dateRegexShort = /^(\d{1,2})[\/\-\.](\d{1,2})/; let currentBlock = []; 
                const processBlock = (block) => { if (block.length === 0) return; try { const dateLine = block[0]; let dateMatch = dateLine.match(dateRegexFull); let dateStr = ""; 
                    if (dateMatch) { 
                        dateStr = dateMatch[0].replace(/[\/\.]/g, '-'); 
                    } else { 
                        dateMatch = dateLine.match(dateRegexShort); 
                        if (dateMatch) { 
                            const m = dateMatch[1].padStart(2, '0'); const d = dateMatch[2].padStart(2, '0'); dateStr = `${currentYear}-${m}-${d}`; 
                        } 
                    } 
                    if (!dateStr) return; 
                    let amount = 0; let type = 'expense'; let foundAmount = false; for (let i = 0; i < block.length; i++) { let content = block[i].replace(/−/g, '-').replace(/\t/g, ' '); const tokens = content.split(/\s+/).filter(t => t.trim() !== ''); for (let j = 0; j < tokens.length; j++) { const token = tokens[j]; const nextToken = tokens[j+1]; if (token.includes('/') || token.includes(':')) continue; if (isNum(token)) { if (nextToken === '-') { amount = parseNum(token); type = 'expense'; foundAmount = true; break; } if (tokens.length === 1 && !foundAmount) { amount = parseNum(token); type = 'expense'; foundAmount = true; break; } if (!foundAmount && block.length === 1 && j === tokens.length - 1) { amount = parseNum(token); type = 'expense'; foundAmount = true; break; } } else if (token === '-') { if (isNum(nextToken)) { amount = parseNum(nextToken); type = 'income'; foundAmount = true; break; } } } if (foundAmount) break; } if (!foundAmount || amount === 0) return; let noteParts = []; block.forEach((line, i) => { let content = line.replace(/−/g, '-').replace(/\t/g, ' '); if (i === 0 && dateMatch) content = content.replace(dateMatch[0], ''); content = content.replace(/-/g, '').trim(); const tokens = content.split(/\s+/); const cleanTokens = tokens.filter(t => { if (isNum(t) && parseNum(t) === amount) return false; return true; }); content = cleanTokens.join(' '); if (content.trim()) noteParts.push(content.trim()); }); let note = noteParts.join(' '); if (note.includes('配息') || note.includes('轉入') || note.includes('存款息')) { type = 'income'; } let toAccountId = ''; if (block.some(l => l.includes('提款'))) { type = 'transfer'; const cashAcc = userAccounts.find(a => a.type === 'cash'); if(cashAcc) toAccountId = cashAcc.id; } if (!note) note = "一般消費"; const txObj = { id: '', date: dateStr, amount: amount, note: note, type: type, categoryId: autoTag(note), accountId: targetAccountId, toAccountId: toAccountId, targetName: '', splits: [] }; parsed.push(txObj); } catch(e) { console.error("Block parse error", e); } }; 
                // Enhanced parsing for credit card bills
                const creditCardRegex = /^(\d{4}\/\d{2}\/\d{2})\s+(.+?)\s+([A-Z]{3})\s+([\d,]+)/;
                const creditCardRegexShort = /^(\d{2}\/\d{2})\s+(.+?)\s+([A-Z]{3})\s+([\d,]+)/;
                
                // Pre-process for credit card bill messiness
                let cleanLines = [];
                for(let i=0; i<rawLines.length; i++) {
                    let line = rawLines[i].trim();
                    // Fix joined date case like "02432025/12/26" -> "2025/12/26"
                    if (/^\d{4}(\d{4}\/\d{2}\/\d{2})/.test(line)) {
                        line = line.replace(/^\d{4}/, '');
                    }
                    if (!line || line.startsWith('−') || /^\d+$/.test(line)) continue; // skip garbage
                    cleanLines.push(line);
                }

                // Try parsing credit card lines first
                for(let i=0; i<cleanLines.length; i++) {
                    const line = cleanLines[i];
                    let match = line.match(creditCardRegex);
                    if (!match) {
                        // Try short date format, prepend current year if needed
                        const shortMatch = line.match(creditCardRegexShort);
                        if (shortMatch) {
                             const fullDate = `${new Date().getFullYear()}/${shortMatch[1]}`;
                             match = [line, fullDate, shortMatch[2], shortMatch[3], shortMatch[4]];
                        }
                    }

                    if (match) {
                        const dateStr = match[1].replace(/\//g, '-');
                        const note = match[2].trim();
                        const amount = parseFloat(match[4].replace(/,/g, ''));
                        const type = 'expense'; 
                        
                        parsed.push({
                            id: (Date.now() + parsed.length).toString(),
                            date: dateStr,
                            amount: amount,
                            note: note,
                            type: type,
                            categoryId: autoTag(note),
                            accountId: targetAccountId,
                            toAccountId: '',
                            targetName: '',
                            splits: []
                        });
                        continue; 
                    }
                    
                    // Fallback to block parser
                    const isDateStart = /^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/.test(line) || (/^(\d{1,2})[\/\-\.](\d{1,2})/.test(line) && line.length < 50 && (line.includes('/') || line.includes('-'))); 
                    if (isDateStart) { 
                        if (currentBlock.length > 0) processBlock(currentBlock); 
                        currentBlock = [line]; 
                    } else { 
                        currentBlock.push(line); 
                    } 
                } 
                if (currentBlock.length > 0) processBlock(currentBlock); 
                
                const baseTime = Date.now(); 
                parsed.forEach((p, i) => { if(!p.id) p.id = (baseTime + (parsed.length - i)).toString(); }); 
                setPreviewData(parsed); 
            }; 

            const toggleSelectTx = (id) => { if (selectedTxIds.includes(id)) setSelectedTxIds(selectedTxIds.filter(tid => tid !== id)); else setSelectedTxIds([...selectedTxIds, id]); };
            const toggleSelectAll = (filteredTxs) => { if (selectedTxIds.length === filteredTxs.length) setSelectedTxIds([]); else setSelectedTxIds(filteredTxs.map(t => t.id)); };
            const confirmBatchDelete = () => { if (selectedTxIds.length > 0) { const updated = data.transactions.filter(t => !selectedTxIds.includes(t.id)); saveData({ ...data, transactions: updated }); setSelectedTxIds([]); setShowDeleteBatchConfirm(false); showToast('已刪除選取項目'); } };
            const toggleSection = (key) => { if (expandedTypes.includes(key)) setExpandedTypes(expandedTypes.filter(k => k !== key)); else setExpandedTypes([...expandedTypes, key]); refreshIcons(); };
            
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);
            const handleDragStart = (e, id) => { e.dataTransfer.effectAllowed = "move"; e.dataTransfer.setData("text/plain", id); dragItem.current = id; e.target.style.opacity = '0.5'; };
            const handleDragEnd = (e) => { e.target.style.opacity = '1'; dragItem.current = null; dragOverItem.current = null; };
            const handleDragOver = (e, id) => { e.preventDefault(); dragOverItem.current = id; };
            const handleDrop = (e, targetId) => { e.preventDefault(); const sourceId = dragItem.current; if (!sourceId || sourceId === targetId) return; const currentOrder = data.accountOrder || userAccounts.map(a => a.id); const sourceIndex = currentOrder.indexOf(sourceId); const targetIndex = currentOrder.indexOf(targetId); if (sourceIndex === -1 || targetIndex === -1) return; const newOrder = [...currentOrder]; const [removed] = newOrder.splice(sourceIndex, 1); newOrder.splice(targetIndex, 0, removed); saveData({ ...data, accountOrder: newOrder }, false); };

            const balanceMap = useMemo(() => { if (!selectedAccount) return {}; const acc = data.accounts.find(a => a.id === selectedAccount); const initial = acc?.balance || 0; const allTxs = data.transactions.filter(t => t.accountId === selectedAccount || t.toAccountId === selectedAccount).sort((a, b) => { const dateDiff = new Date(a.date) - new Date(b.date); if (dateDiff !== 0) return dateDiff; if (a.id < b.id) return -1; if (a.id > b.id) return 1; return 0; }); const map = {}; let currentBal = initial; allTxs.forEach(tx => { const amount = parseFloat(tx.amount) || 0; if (tx.type === 'income' || (tx.type === 'repay' && tx.accountId === selectedAccount)) { currentBal += amount; } else if (tx.type === 'expense' || (tx.type === 'advance' && tx.accountId === selectedAccount)) { let finalAmount = amount; if (tx.type === 'expense' && tx.splits && tx.splits.length > 0) { const otherSplitsSum = tx.splits.filter(s => s.owner !== 'me').reduce((acc, s) => acc + (parseFloat(s.amount) || 0), 0); finalAmount = amount - otherSplitsSum; } currentBal -= finalAmount; } else if (tx.type === 'transfer') { if (tx.toAccountId === selectedAccount) { currentBal += amount; } else if (tx.accountId === selectedAccount) { currentBal -= amount; } } map[tx.id] = currentBal; }); map['_final'] = currentBal; return map; }, [data.transactions, selectedAccount, data.accounts]);
            
            const monthsWithData = useMemo(() => {
                if (!selectedAccount) return new Set();
                const currentYear = currentDate.getFullYear();
                const activeMonths = new Set();
                data.transactions.forEach(t => {
                    if(!t.date) return;
                    const parts = t.date.split('-');
                    const ty = parseInt(parts[0]);
                    const tm = parseInt(parts[1]);
                    const isRelated = t.accountId === selectedAccount || t.toAccountId === selectedAccount;
                    if (ty === currentYear && isRelated) {
                        activeMonths.add(tm - 1); 
                    }
                });
                return activeMonths;
            }, [data.transactions, currentDate, selectedAccount]);

            useEffect(() => { 
                if (window.lucide) { 
                    setTimeout(() => window.lucide.createIcons(), 50); 
                    setTimeout(() => window.lucide.createIcons(), 500); 
                } 
            }, [showAdd, isEditMode, showImport, previewData, showDatePicker, expandedTypes, selectedAccount, data.transactions, filterType, expandedGroups, activeTab]); 

            if (selectedAccount) {
                const currentAccount = data.accounts.find(a => a.id === selectedAccount);
                const currentTotalBalance = balanceMap['_final'] !== undefined ? balanceMap['_final'] : (currentAccount?.balance || 0);
                
                return (
                    <div className="pb-24 md:pb-0 animate-fade flex flex-col h-full relative">
                       <div className="flex flex-col md:flex-row justify-between items-center mb-4 px-4 md:px-0 pt-4 gap-3 relative">
                            <div className="flex items-center gap-4 w-full md:w-1/3">
                                <button onClick={() => setSelectedAccount(null)} className="md:hidden p-2 -ml-2 rounded-full hover:bg-black/5"><LucideIcon name="arrow-left" className="w-5 h-5 text-muji-text" /></button>
                                <div>
                                    <h3 className="text-xl font-bold text-muji-text leading-tight">{currentAccount?.name}</h3>
                                    <button onClick={() => setInputModal({ show: true, title: '餘額校正', value: currentTotalBalance.toString(), type: 'calibrate_account', data: currentAccount.id, extra: currentTotalBalance })} className={`text-sm font-mono font-bold mt-1 text-left hover:opacity-60 transition-opacity flex items-center gap-2 ${currentTotalBalance >= 0 ? 'text-muji-green' : 'text-rose-500'}`} title="點擊校正餘額">${currentTotalBalance.toLocaleString()} <LucideIcon name="pencil" className="w-3 h-3 opacity-30" /></button>
                                </div>
                            </div>
                            <div className="flex justify-center w-full md:w-1/3"><div className="flex items-center bg-white border border-muji-border rounded-lg px-1 py-1"><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-1 hover:bg-muji-bg rounded"><span className="font-mono text-lg">&lt;</span></button><span className="text-xs font-bold mx-2 cursor-pointer whitespace-nowrap" onClick={() => setShowDatePicker(true)}>{currentDate.getFullYear()}/{currentDate.getMonth() + 1}</span><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-1 hover:bg-muji-bg rounded"><span className="font-mono text-lg">&gt;</span></button><button onClick={() => setCurrentDate(new Date())} className="ml-2 px-3 py-1 bg-muji-bg border border-muji-border rounded text-xs font-bold hover:bg-muji-hover text-muji-text">今天</button></div></div>
                            <div className="flex justify-end items-center gap-4 w-full md:w-1/3">
                                <div className="text-xs text-rose-500 font-bold bg-rose-50/50 px-2 py-1 rounded border border-rose-100">
                                    本月支出: ${currentMonthStats.expense.toLocaleString()}
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => { resetForm(); setShowAdd(true); }} className="bg-muji-accent text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1"><LucideIcon name="plus" className="w-4 h-4" /> 記帳</button><button onClick={() => { setImportText(''); setPreviewData([]); setShowImport(true); }} className="bg-white border border-muji-border text-muji-text px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm hover:bg-muji-bg flex items-center gap-1"><LucideIcon name="sparkles" className="w-4 h-4" /> AI</button>
                                </div>
                            </div>
                       </div>

                        <div className="px-4 md:px-0 mb-4">
                            <div className="flex overflow-x-auto no-scrollbar gap-2 pb-1">
                                {[
                                    { id: 'all', label: '全部' },
                                    { id: 'expense', label: '支出' },
                                    { id: 'income', label: '收入' },
                                    { id: 'transfer', label: '轉帳' },
                                    { id: 'repay', label: '還款' },
                                    { id: 'advance', label: '代墊' }
                                ].map(type => (
                                    <button
                                        key={type.id}
                                        onClick={() => setFilterType(type.id)}
                                        className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors border ${filterType === type.id ? 'bg-muji-text text-white border-muji-text' : 'bg-white text-muji-muted border-muji-border hover:bg-muji-bg'}`}
                                    >
                                        {type.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                       {selectedTxIds.length > 0 && (<div className="mb-4 flex justify-between items-center bg-muji-red/10 p-2 rounded-lg border border-muji-red/30 mx-4 md:mx-0"><span className="text-xs text-muji-red font-bold ml-2">已選取 {selectedTxIds.length} 筆</span><button onClick={() => setShowDeleteBatchConfirm(true)} className="text-xs bg-muji-red text-white px-3 py-1.5 rounded font-bold hover:opacity-80">刪除</button></div>)}

                       <div className="flex-1 overflow-y-auto bg-white mx-4 md:mx-0 mb-20 md:mb-0 rounded-xl border border-muji-border min-h-[50vh] max-h-[calc(100vh-250px)] relative flex flex-col">
                            <div className="bg-muji-bg text-muji-muted font-medium border-b border-muji-border flex text-sm shadow-sm z-20 sticky top-0 grid grid-cols-[5rem_1fr_1fr_1fr_1fr_1fr_1fr] items-center text-xs">
                                <div className="p-4 flex justify-center"><input type="checkbox" className="w-4 h-4 accent-muji-accent cursor-pointer" checked={filteredTxs.length > 0 && selectedTxIds.length === filteredTxs.length} onChange={() => toggleSelectAll(filteredTxs)} /></div>
                                <div className="p-4 text-center font-bold text-xs">日期</div>
                                <div className="p-4 text-center font-bold text-xs">類型</div>
                                <div className="p-4 text-center font-bold text-xs">分類</div>
                                <div className="p-4 text-center font-bold text-xs">金額</div>
                                <div className="p-4 text-center font-bold text-xs">餘額</div>
                                <div className="p-4 pl-4 text-left text-muji-muted truncate font-bold text-xs">備註</div>
                            </div>
                            <div>
                                {groupedTxs.length === 0 ? (<div className="p-10 text-center text-muji-muted">無紀錄</div>) : (
                                    groupedTxs.map(tx => { 
                                        if (tx.isGroupHeader) {
                                            const isExpanded = expandedGroups[tx.linkId] !== false; 
                                            const firstSubTx = tx.subTransactions[0];
                                            const date = firstSubTx.date;
                                            const totalAmt = tx.totalAmount;
                                            return (
                                                <React.Fragment key={tx.id}>
                                                    <div onClick={() => toggleGroup(tx.linkId)} className="grid grid-cols-[5rem_1fr_1fr_1fr_1fr_1fr_1fr] items-center border-b border-muji-border/50 bg-gray-50/80 hover:bg-gray-100 font-bold cursor-pointer transition-colors text-sm">
                                                        <div className="p-4 flex justify-center">
                                                            <span key={isExpanded ? "exp" : "col"} className="flex items-center justify-center">
                                                                <LucideIcon name={isExpanded ? "chevron-down" : "chevron-right"} className="w-4 h-4 text-muji-muted" />
                                                            </span>
                                                        </div>
                                                        <div className="p-4 text-center font-mono text-xs">{date}</div>
                                                        <div className="p-4 text-center text-xs text-muji-muted">拆帳</div>
                                                        <div className="p-4 text-center text-xs"><span className="bg-muji-accent/10 text-muji-accent px-2 py-0.5 rounded-full text-[10px]">{tx.subTransactions.length} 筆</span></div>
                                                        <div className="p-4 text-center font-mono text-muji-text">${totalAmt.toLocaleString()}</div>
                                                        <div className="p-4 text-center">-</div>
                                                        <div className="p-4 pl-4 text-xs text-muji-muted italic truncate text-left">點擊展開/收合</div>
                                                    </div>
                                                    {isExpanded && tx.subTransactions.map(subTx => {
                                                        const cat = flatCategories[subTx.categoryId] || { icon: 'help-circle', name: '未分類' };
                                                        const txType = window.TX_TYPES[subTx.type] || { label: '未知', color: 'text-gray-500' };
                                                        let display = cat.name;
                                                        if(subTx.type === 'repay' || subTx.type === 'advance') {
                                                             const target = subTx.targetName || '-';
                                                             display = `${cat.name} (${target})`;
                                                        }
                                                        const textColorClass = subTx.type === 'expense' ? 'text-rose-500' : (subTx.type === 'income' ? 'text-emerald-500' : txType.color);
                                                        let sign = subTx.type === 'expense' || subTx.type === 'advance' ? '-' : '+';
                                                        const balance = balanceMap[subTx.id];
                                                        const isSettled = subTx.isSettled; 
                                                        return (
                                                            <div key={subTx.id} onClick={() => openEdit(subTx)} className={`grid grid-cols-[5rem_1fr_1fr_1fr_1fr_1fr_1fr] items-center border-b border-muji-border/50 hover:bg-muji-hover transition-colors bg-white cursor-pointer text-sm ${isSettled ? 'opacity-50' : ''}`}>
                                                                <div className="p-4 flex justify-center gap-2 pl-6 border-l-4 border-muji-accent/20"><button onClick={(e) => { e.stopPropagation(); handleDuplicateTx(subTx); }} className="p-1 text-muji-muted hover:text-muji-accent"><LucideIcon name="copy" className="w-3.5 h-3.5" /></button><button onClick={(e) => { e.stopPropagation(); handleDelete(subTx); }} className="p-1 text-muji-muted hover:text-muji-red" title="刪除並回補"><LucideIcon name="trash-2" className="w-3.5 h-3.5" /></button></div>
                                                                <div className="p-4 text-center opacity-0">-</div> 
                                                                <div className={`p-4 text-center font-bold ${txType.color} text-xs px-1 whitespace-nowrap ${isSettled ? 'line-through decoration-muji-text/50' : ''}`}>{txType.label}</div>
                                                                <div className={`p-4 text-center text-xs gap-2 flex justify-center items-center ${isSettled ? 'line-through decoration-muji-text/50' : ''}`}>{(subTx.type==='expense'||subTx.type==='income')&&
                                                                    <span className="flex">
                                                                        <LucideIcon name={cat.icon || 'circle'} className="w-4 h-4" />
                                                                    </span>
                                                                }<span className="truncate">{display}</span></div>
                                                                <div className={`p-4 text-center font-mono font-bold ${textColorClass} text-xs ${isSettled ? 'line-through decoration-muji-text/50' : ''}`}>{sign}${subTx.amount.toLocaleString()}</div>
                                                                <div className={`p-4 text-center font-mono text-xs text-muji-muted`}>${balance?.toLocaleString()}</div>
                                                                <div className={`p-4 pl-4 text-left text-muji-muted text-xs truncate ${isSettled ? 'line-through' : ''}`}>{subTx.note}{isSettled ? ' (已結清)' : ''}</div>
                                                            </div>
                                                        );
                                                    })}
                                                </React.Fragment>
                                            );
                                        } else {
                                            const cat = flatCategories[tx.categoryId] || { icon: 'help-circle', name: '未分類' }; 
                                            const txType = window.TX_TYPES[tx.type] || { label: '未知', color: 'text-gray-500' }; 
                                            let display = cat.name;
                                            if(tx.type === 'transfer') { const to = userAccounts.find(a=>a.id===tx.toAccountId); const from = userAccounts.find(a=>a.id===tx.accountId); if (selectedAccount === tx.accountId) display = to ? `-> ${to.name}` : '轉出'; else if (selectedAccount === tx.toAccountId) display = from ? `<- ${from.name}` : '轉入'; } 
                                            else if(tx.type === 'repay' || tx.type === 'advance') { const target = tx.targetName || '-'; display = `${cat.name} (${target})`; }
                                            const amountVal = tx.amount || 0;
                                            const textColorClass = tx.type === 'expense' ? 'text-rose-500' : (tx.type === 'income' ? 'text-emerald-500' : txType.color);
                                            let sign = '';
                                            if (tx.type === 'expense') sign = '-'; else if (tx.type === 'income') sign = '+'; else if (tx.type === 'transfer') sign = selectedAccount === tx.accountId ? '-' : '+'; else if (tx.type === 'repay') sign = '+'; else if (tx.type === 'advance') sign = '-';
                                            const balance = balanceMap[tx.id];
                                            const isSettled = tx.isSettled; 

                                            return (
                                                <div key={tx.id} onClick={() => openEdit(tx)} className={`grid grid-cols-[5rem_1fr_1fr_1fr_1fr_1fr_1fr] items-center border-b border-muji-border/50 hover:bg-muji-hover transition-colors cursor-pointer text-sm ${isSettled ? 'opacity-50' : ''}`}>
                                                    <div className="p-4 flex justify-center gap-2" onClick={(e) => e.stopPropagation()}>
                                                        <input type="checkbox" className="w-4 h-4 accent-muji-accent cursor-pointer" checked={selectedTxIds.includes(tx.id)} onChange={() => toggleSelectTx(tx.id)} />
                                                        <button onClick={(e) => { e.stopPropagation(); handleDuplicateTx(tx); }} className="p-1 text-muji-muted hover:text-muji-accent transition-colors" title="複製並新增一筆"><LucideIcon name="copy" className="w-3.5 h-3.5" /></button>
                                                    </div>
                                                    <div className="p-4 text-center font-mono text-xs">{tx.date}</div>
                                                    <div className={`p-4 text-center font-bold ${txType.color} text-xs px-1 whitespace-nowrap ${isSettled ? 'line-through decoration-muji-text/50' : ''}`}>{txType.label}</div>
                                                    <div className={`p-4 text-center text-xs gap-2 flex justify-center items-center ${isSettled ? 'line-through decoration-muji-text/50' : ''}`}>{(tx.type==='expense'||tx.type==='income')&&
                                                        <span className="flex">
                                                            <LucideIcon name={cat.icon || 'circle'} className="w-4 h-4" />
                                                        </span>
                                                    }<span className="truncate">{display}</span></div>
                                                    <div className={`p-4 text-center font-mono font-bold ${textColorClass} text-xs ${isSettled ? 'line-through decoration-muji-text/50' : ''}`}><span>{sign}${amountVal.toLocaleString()}</span></div>
                                                    <div className={`p-4 text-center font-mono text-xs text-muji-muted`}>{balance !== undefined ? `$${balance.toLocaleString()}` : '-'}</div>
                                                    <div className={`p-4 pl-4 text-left text-muji-muted text-xs truncate ${isSettled ? 'line-through' : ''}`}>{tx.note}{isSettled ? ' (已結清)' : ''}</div>
                                                </div>
                                            ) 
                                        }
                                    })
                                )}
                            </div>
                       </div>
                       
                       {showDatePicker && (<Modal title="選擇日期" onClose={() => setShowDatePicker(false)}><div className="p-4"><div className="flex justify-between items-center mb-4 px-2"><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear() - 1, currentDate.getMonth(), 1))} className="p-2 hover:bg-muji-bg rounded-full"><LucideIcon name="chevron-left" className="w-5 h-5" /></button><span className="text-xl font-bold font-mono">{currentDate.getFullYear()}</span><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear() + 1, currentDate.getMonth(), 1))} className="p-2 hover:bg-muji-bg rounded-full"><LucideIcon name="chevron-right" className="w-5 h-5" /></button></div><div className="grid grid-cols-4 gap-2">{Array.from({length: 12}, (_, i) => i).map(m => { const hasData = monthsWithData.has(m); const isSelected = currentDate.getMonth() === m; return (<button key={m} onClick={() => { setCurrentDate(new Date(currentDate.getFullYear(), m, 1)); setShowDatePicker(false); }} className={`py-3 rounded-lg text-sm font-bold transition-colors relative ${isSelected ? 'bg-muji-accent text-white shadow-md' : hasData ? 'bg-white text-muji-text border border-muji-accent/30 shadow-sm hover:border-muji-accent' : 'bg-muji-bg text-muji-muted/50 hover:bg-gray-200'}`}>{m+1}月{hasData && !isSelected && <div className="absolute top-2 right-2 w-1.5 h-1.5 rounded-full bg-muji-accent"></div>}</button>); })}</div></div></Modal>)}
                       {showDeleteBatchConfirm && (<Modal title="刪除確認" onClose={() => setShowDeleteBatchConfirm(false)}><div className="p-4 text-center space-y-4"><p className="text-muji-text">確定要刪除選取的 <span className="font-bold">{selectedTxIds.length}</span> 筆資料嗎？</p><p className="text-xs text-muji-red">此操作無法復原！</p><div className="flex gap-3"><button onClick={() => setShowDeleteBatchConfirm(false)} className="flex-1 py-3 border border-muji-border rounded-lg">取消</button><button onClick={confirmBatchDelete} className="flex-1 py-3 bg-muji-red text-white font-bold rounded-lg shadow-sm">確認刪除</button></div></div></Modal>)}
                       {showImport && <SmartImportModal onClose={() => setShowImport(false)} importText={importText} setImportText={setImportText} previewData={previewData} setPreviewData={setPreviewData} saveData={saveData} data={data} handleSmartImport={handleSmartImport} flatCategories={flatCategories} userAccounts={userAccounts} selectedAccount={selectedAccount} />}
                       {showAdd && <TransactionModal onClose={() => setShowAdd(false)} isEditMode={isEditMode} newTx={newTx} setNewTx={setNewTx} isSplitMode={isSplitMode} setIsSplitMode={setIsSplitMode} splitTotal={splitTotal} setSplitTotal={setSplitTotal} splits={splits} setSplits={setSplits} categoryGroups={categoryGroups} flatCategories={flatCategories} userAccounts={userAccounts} selectedAccount={selectedAccount} saveTransaction={handleSaveTransaction} handleDeleteTransaction={handleDeleteTransaction} data={data} saveData={saveData} showToast={showToast} />}
                    </div>
                );
            }
            
            const recentAccounts = getRecentAccounts(); 

            return (
                <div className="p-6 md:p-10 animate-fade relative min-h-full">
                    <div className="sticky top-0 z-10 bg-muji-bg flex justify-between items-center py-4 mb-6 -mt-6 -mx-6 px-6 md:-mt-10 md:-mx-10 md:px-10 border-b border-muji-border/50 backdrop-blur-sm bg-muji-bg/95">
                        <h3 className="text-2xl font-bold text-muji-text">我的帳戶</h3>
                        <div className="flex gap-2">
                            <div className="flex bg-muji-bg rounded-lg p-1 border border-muji-border mr-2">
                                <button onClick={() => setActiveTab('expense_list')} className={`px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 ${activeTab === 'expense_list' ? 'bg-white shadow-sm text-muji-accent' : 'text-muji-muted hover:text-muji-text'}`}>
                                    <LucideIcon name="list" className="w-3 h-3" /> 本月支出
                                </button>
                                <button onClick={() => setActiveTab('all_grid')} className={`px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 ${activeTab === 'all_grid' ? 'bg-white shadow-sm text-muji-accent' : 'text-muji-muted hover:text-muji-text'}`}>
                                    <LucideIcon name="grid" className="w-3 h-3" /> 所有帳戶
                                </button>
                            </div>

                            <button onClick={() => setInputModal({ show: true, title: '新增帳戶', value: '', type: 'add_account', extra: 'cash', value2: '' })} className="bg-muji-card border border-muji-border hover:border-muji-accent text-muji-text hover:text-muji-accent p-2 md:px-4 md:py-2 rounded-lg transition flex items-center gap-2 font-bold shadow-sm text-sm"><LucideIcon name="plus" className="w-4 h-4" /> <span className="hidden sm:inline">新增</span></button>
                        </div>
                    </div>
                    
                    {activeTab === 'expense_list' ? (
                        <div className="animate-fade">
                            <div className="mb-4 p-4 bg-white rounded-xl border border-muji-border shadow-sm flex justify-between items-center">
                                 <span className="text-sm font-bold text-muji-text">本月總支出</span>
                                 <span className="text-xl font-mono font-bold text-rose-500">${totalMonthlyExpenseSum.toLocaleString()}</span>
                            </div>
                            
                            {monthlyExpenseAccounts.length > 0 ? (
                                <div className="space-y-3">
                                    {monthlyExpenseAccounts.map(acc => {
                                        const expense = accountMonthlyExpenses[acc.id] || 0;
                                        const typeConfig = accountTypes[acc.type] || { icon: 'circle-help' };
                                        return (
                                            <div 
                                                key={acc.id} 
                                                onClick={() => setSelectedAccount(acc.id)} 
                                                className="bg-white p-4 rounded-xl border border-muji-border hover:border-muji-accent hover:shadow-md transition-all cursor-pointer flex justify-between items-center"
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center text-rose-500">
                                                        <LucideIcon name={typeConfig.icon} className="w-5 h-5" />
                                                    </div>
                                                    <div className="font-bold text-base text-muji-text">{acc.name}</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-lg font-mono font-bold text-rose-500">${expense.toLocaleString()}</div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <div className="p-10 text-center text-muji-muted border border-dashed border-muji-border rounded-xl">
                                    本月尚無支出紀錄
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="animate-fade">
                            {recentAccounts.length > 0 && (
                                 <div className="mb-6">
                                    <button onClick={() => toggleSection('recent')} className="w-full text-left flex items-center gap-2 mb-3 pb-1 border-b border-muji-border"><LucideIcon name={expandedTypes.includes('recent') ? "chevron-down" : "chevron-right"} className="w-4 h-4 text-muji-muted" /><h4 className="text-muji-muted text-sm font-bold flex items-center gap-2"><LucideIcon name="clock" className="w-4 h-4" /> 最近記帳</h4></button>
                                    {expandedTypes.includes('recent') && (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 animate-fade">
                                            {recentAccounts.map(acc => { const bal = window.calculateBalance(data, acc.id); const isPositive = bal >= 0; const typeConfig = accountTypes[acc.type] || { icon: 'circle-help' }; const expense = accountMonthlyExpenses[acc.id] || 0; return (<div key={'recent_' + acc.id} onClick={() => setSelectedAccount(acc.id)} className="bg-white p-4 rounded-xl border border-muji-border hover:border-muji-accent hover:shadow-md transition-all cursor-pointer relative group h-32 flex flex-col justify-between"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full border-2 border-muji-text/20 flex items-center justify-center text-muji-text text-xl"><LucideIcon name={typeConfig.icon} className="w-5 h-5" /></div><div className="font-bold text-base text-muji-text truncate">{acc.name}</div></div><div className="text-right"><div className={`text-xl font-mono font-bold ${isPositive ? 'text-muji-green' : 'text-rose-500'}`}>${bal.toLocaleString()}</div>{expense > 0 && (<div className="text-xs text-rose-500 font-bold mt-1">本月支出: ${expense.toLocaleString()}</div>)}</div></div>); })}
                                        </div>
                                    )}
                                 </div>
                             )}

                            {Object.entries(accountTypes).map(([typeKey, typeConfig]) => {
                                const typeAccounts = userAccounts.filter(a => a.type === typeKey);
                                if (typeAccounts.length === 0) return null;
                                const isExpanded = expandedTypes.includes(typeKey);
                                
                                const sortedTypeAccounts = typeAccounts.sort((a, b) => {
                                    const dateA = accountLastModified[a.id] || 0;
                                    const dateB = accountLastModified[b.id] || 0;
                                    return dateB - dateA; 
                                });

                                return (
                                    <div key={typeKey} className="mb-6">
                                        <button onClick={() => toggleSection(typeKey)} className="w-full text-left flex items-center gap-2 mb-3 pb-1 border-b border-muji-border"><LucideIcon name={isExpanded ? "chevron-down" : "chevron-right"} className="w-4 h-4 text-muji-muted" /><h4 className="text-muji-muted text-sm font-bold flex items-center gap-2"><LucideIcon name={typeConfig.icon} className="w-4 h-4" /> {typeConfig.label}</h4></button>
                                        {isExpanded && (
                                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 animate-fade">
                                                {sortedTypeAccounts.map(acc => { 
                                                    const bal = window.calculateBalance(data, acc.id); const isPositive = bal >= 0;
                                                    const expense = accountMonthlyExpenses[acc.id] || 0;
                                                    return (
                                                        <div 
                                                            key={acc.id} 
                                                            onDragOver={(e) => handleDragOver(e, acc.id)} 
                                                            onDrop={(e) => handleDrop(e, acc.id)} 
                                                            onClick={() => setSelectedAccount(acc.id)} 
                                                            className="bg-white p-4 rounded-xl border border-muji-border hover:border-muji-accent hover:shadow-md transition-all cursor-pointer relative group h-32 flex flex-col justify-between"
                                                        >
                                                            <div className="absolute right-2 top-2 opacity-0 group-hover:opacity-100 flex gap-2">
                                                                <button onClick={(e) => {e.stopPropagation(); setInputModal({ show: true, title: '餘額校正', value: bal.toString(), type: 'calibrate_account', data: acc.id, extra: bal, value2: '', value3: '' });}} className="p-1 hover:bg-muji-bg rounded text-muji-muted hover:text-muji-accent"><LucideIcon name="sliders-horizontal" className="w-3 h-3" /></button>
                                                                <button onClick={(e) => {e.stopPropagation(); setInputModal({ show: true, title: '修改帳戶', value: acc.name, value2: acc.balance || 0, type: 'rename_account', data: acc.id, extra: acc.type, value3: acc.closingDay || '' });}} className="p-1 hover:bg-muji-bg rounded text-muji-muted hover:text-muji-accent"><LucideIcon name="pencil" className="w-3 h-3" /></button>
                                                                <button onClick={(e) => {e.stopPropagation(); setInputModal({ show: true, title: '刪除', value: '確認', type: 'delete_account', data: acc.id, value2: '', value3: '' });}} className="p-1 hover:bg-muji-bg rounded text-muji-muted hover:text-muji-red"><LucideIcon name="trash-2" className="w-3 h-3" /></button>
                                                            </div>
                                                            <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full border-2 border-muji-text/20 flex items-center justify-center text-muji-text text-xl"><LucideIcon name={typeConfig.icon} className="w-5 h-5" /></div><div className="font-bold text-base text-muji-text truncate">{acc.name}</div></div>
                                                            <div className="text-right">
                                                                <div className={`text-xl font-mono font-bold ${isPositive ? 'text-muji-green' : 'text-rose-500'}`}>${bal.toLocaleString()}</div>
                                                                {expense > 0 && (
                                                                    <div className="text-xs text-rose-500 font-bold mt-1">本月支出: ${expense.toLocaleString()}</div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ); 
                                                })}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // --- OTHER VIEWS (Debt, Wealth, Analysis, Settings) from user files, adapted for single user ---
        // (For brevity, I'm embedding the essential logic directly or assuming they are loaded similarly. 
        //  The key changes were removing userId checks. I will implement simplified versions here.)

        const AnalysisView = ({ data }) => {
            const [filterType, setFilterType] = useState('expense'); 
            const [period, setPeriod] = useState('month'); 
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedCategoryId, setSelectedCategoryId] = useState(null);
            const [expandedCategory, setExpandedCategory] = useState(null); // Which tag is expanded

            useEffect(() => { refreshIcons(); }, [filterType, period, currentDate, selectedCategoryId]);

            // Helper to get start and end dates based on timeScale and anchorDate
            const getDateRange = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const day = currentDate.getDate();
                let start, end;

                if (period === 'year') {
                    start = new Date(year, 0, 1);
                    end = new Date(year, 11, 31, 23, 59, 59, 999);
                } else if (period === 'month') {
                    start = new Date(year, month, 1);
                    end = new Date(year, month + 1, 0, 23, 59, 59, 999);
                } else if (period === 'week') {
                    const dayOfWeek = currentDate.getDay(); // 0 is Sunday
                    const diffToSunday = dayOfWeek; 
                    start = new Date(year, month, day - diffToSunday);
                    start.setHours(0, 0, 0, 0);
                    end = new Date(year, month, day - diffToSunday + 6);
                    end.setHours(23, 59, 59, 999);
                } else { // day
                    start = new Date(year, month, day, 0, 0, 0, 0);
                    end = new Date(year, month, day, 23, 59, 59, 999);
                }
                return { start, end };
            };

            const shiftDate = (direction) => {
                const newDate = new Date(currentDate);
                const year = newDate.getFullYear();
                const month = newDate.getMonth();
                const day = newDate.getDate();

                if (period === 'year') {
                    newDate.setFullYear(year + direction);
                } else if (period === 'month') {
                    newDate.setMonth(month + direction);
                } else if (period === 'week') {
                    newDate.setDate(day + (direction * 7));
                } else { // day
                    newDate.setDate(day + direction);
                }
                setCurrentDate(newDate);
                setExpandedCategory(null); // Collapse when date changes
            };
            
            const formatDateLabel = () => {
                const y = currentDate.getFullYear();
                const m = currentDate.getMonth() + 1;
                const d = currentDate.getDate();
                if (period === 'year') return `${y}年`;
                if (period === 'month') return `${y}年 ${m}月`;
                if (period === 'day') return `${y}/${m}/${d}`;
                if (period === 'week') {
                     const { start, end } = getDateRange();
                     return `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}`;
                }
            };

            const stats = useMemo(() => {
                const { start, end } = getDateRange();
                const categoryGroups = data.settings?.categoryGroups || DEFAULT_CATEGORY_GROUPS;
                const flatCategories = getFlatCategories(categoryGroups);
                const userAccounts = data.accounts.map(a => a.id);

                let totalAmount = 0;
                const categoryMap = {}; // { mainCat: { total: 0, count: 0, icon, color, subs: { subName: amount } } }
                
                // Color mapping for tags
                const colors = ['bg-red-100 text-red-800', 'bg-orange-100 text-orange-800', 'bg-amber-100 text-amber-800', 'bg-yellow-100 text-yellow-800', 'bg-lime-100 text-lime-800', 'bg-green-100 text-green-800', 'bg-emerald-100 text-emerald-800', 'bg-teal-100 text-teal-800', 'bg-cyan-100 text-cyan-800', 'bg-sky-100 text-sky-800', 'bg-blue-100 text-blue-800', 'bg-indigo-100 text-indigo-800', 'bg-violet-100 text-violet-800', 'bg-purple-100 text-purple-800', 'bg-fuchsia-100 text-fuchsia-800', 'bg-pink-100 text-pink-800', 'bg-rose-100 text-rose-800'];
                let colorIndex = 0;

                data.transactions.forEach(tx => {
                    const txDate = new Date(tx.date);
                    if (txDate < start || txDate > end) return;
                    if (!userAccounts.includes(tx.accountId)) return;

                    let amount = 0;
                    if (filterType === 'expense') {
                        if (tx.type === 'expense') {
                            amount = tx.amount;
                            if (tx.splits && tx.splits.length > 0) {
                                const others = tx.splits.reduce((acc, s) => s.owner !== 'me' ? acc + (parseFloat(s.amount)||0) : acc, 0);
                                amount -= others;
                            }
                        }
                    } else if (filterType === 'income') {
                        if (tx.type === 'income') amount = tx.amount;
                    }

                    if (amount <= 0) return;
                    totalAmount += amount;
                    const catInfo = flatCategories[tx.categoryId] || { group: '未分類', name: '未分類' };
                    const mainCat = catInfo.group;
                    const subCat = catInfo.name;

                    if (!categoryMap[mainCat]) {
                        categoryMap[mainCat] = { total: 0, count: 0, icon: catInfo.icon || 'circle', color: colors[colorIndex % colors.length], subs: {} };
                        colorIndex++;
                    }
                    categoryMap[mainCat].total += amount;
                    categoryMap[mainCat].count += 1;
                    
                    if (!categoryMap[mainCat].subs[subCat]) categoryMap[mainCat].subs[subCat] = 0;
                    categoryMap[mainCat].subs[subCat] += amount;
                });

                const categories = Object.entries(categoryMap).map(([name, data]) => ({ name, value: data.total, count: data.count, icon: data.icon, color: data.color, subs: data.subs })).sort((a, b) => b.value - a.value);
                return { totalAmount, categories };
            }, [data, filterType, period, currentDate]);

            return (
                <div className="p-6 animate-fade pb-24">
                    {/* Header Controls */}
                    <div className="flex flex-col gap-4 mb-6">
                        <div className="flex justify-between items-center">
                            <h3 className="text-2xl font-bold text-muji-text">收支分析</h3>
                            <div className="flex bg-muji-bg rounded-lg p-1 border border-muji-border">
                                <button onClick={() => setFilterType('expense')} className={`px-4 py-1.5 rounded text-sm font-bold transition ${filterType === 'expense' ? 'bg-rose-500 text-white shadow-sm' : 'text-muji-muted hover:bg-white'}`}>支出</button>
                                <button onClick={() => setFilterType('income')} className={`px-4 py-1.5 rounded text-sm font-bold transition ${filterType === 'income' ? 'bg-emerald-500 text-white shadow-sm' : 'text-muji-muted hover:bg-white'}`}>收入</button>
                            </div>
                        </div>

                        {/* Date Filter & Navigator */}
                        <div className="flex flex-col sm:flex-row justify-between items-center gap-2 bg-white p-2 rounded-xl border border-muji-border shadow-sm">
                            <div className="flex bg-muji-bg rounded-lg p-1 overflow-x-auto no-scrollbar w-full sm:w-auto">
                                {['year', 'month', 'week', 'day'].map(t => (
                                    <button key={t} onClick={() => setPeriod(t)} className={`flex-1 sm:flex-none px-3 py-1.5 rounded text-xs font-bold transition whitespace-nowrap ${period === t ? 'bg-white shadow-sm text-muji-accent' : 'text-muji-muted hover:text-muji-text'}`}>
                                        {t === 'year' ? '年' : t === 'month' ? '月' : t === 'week' ? '週' : '日'}
                                    </button>
                                ))}
                            </div>
                            <div className="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end px-2 sm:px-0">
                                <button onClick={() => shiftDate(-1)} className="p-1 hover:bg-muji-bg rounded-full"><LucideIcon name="chevron-left" className="w-5 h-5" /></button>
                                <span className="font-bold text-lg font-mono min-w-[6rem] text-center">{formatDateLabel()}</span>
                                <button onClick={() => shiftDate(1)} className="p-1 hover:bg-muji-bg rounded-full"><LucideIcon name="chevron-right" className="w-5 h-5" /></button>
                                <button onClick={() => setCurrentDate(new Date())} className="text-xs bg-muji-bg px-2 py-1 rounded border border-muji-border hover:bg-gray-200">今天</button>
                            </div>
                        </div>
                    </div>

                    {/* Total Amount */}
                    <div className="bg-white p-6 rounded-xl border border-muji-border shadow-sm mb-6 text-center">
                        <div className="text-sm text-muji-muted mb-1">總金額 ({filterType === 'expense' ? '支出' : '收入'})</div>
                        <div className={`text-4xl font-mono font-bold ${filterType === 'expense' ? 'text-rose-500' : 'text-emerald-500'}`}>${stats.totalAmount.toLocaleString()}</div>
                    </div>

                    {/* Tags Layout */}
                    <div className="flex flex-wrap gap-2">
                        {stats.categories.length > 0 ? (
                            stats.categories.map((cat) => (
                                <div key={cat.name} onClick={() => setExpandedCategory(expandedCategory === cat.name ? null : cat.name)} className={`group px-4 py-2 rounded-full border border-transparent shadow-sm flex items-center gap-3 transition-all cursor-pointer ${cat.color} ${expandedCategory === cat.name ? 'ring-2 ring-offset-1 ring-black/20 scale-105' : 'hover:scale-105 hover:opacity-90'}`}>
                                    <div className="flex items-center gap-1.5 pointer-events-none">
                                        <LucideIcon name={cat.icon} className="w-4 h-4 opacity-70" />
                                        <span className="font-bold text-sm">{cat.name}</span>
                                    </div>
                                    <div className="flex items-center gap-2 border-l border-black/10 pl-3 pointer-events-none">
                                        <span className="font-mono font-bold text-sm">${cat.value.toLocaleString()}</span>
                                        <span className="text-[10px] opacity-60 bg-black/5 px-1.5 py-0.5 rounded-full">{cat.count}筆</span>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <div className="w-full text-center text-muji-muted py-10">此期間無資料</div>
                        )}
                    </div>

                    {/* Expanded Detail View */}
                    {expandedCategory && (
                        <div className="mt-6 animate-fade">
                            <div className="bg-white p-4 rounded-xl border border-muji-border shadow-sm">
                                <div className="flex justify-between items-center mb-4 pb-2 border-b border-muji-border">
                                    <h4 className="font-bold text-lg text-muji-text flex items-center gap-2">
                                        <LucideIcon name="list-tree" className="w-5 h-5 text-muji-accent" />
                                        {expandedCategory} 明細
                                    </h4>
                                    <button onClick={() => setExpandedCategory(null)} className="p-1 hover:bg-muji-bg rounded-full"><LucideIcon name="x" className="w-4 h-4" /></button>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    {(() => {
                                        const catData = stats.categories.find(c => c.name === expandedCategory);
                                        if(!catData || !catData.subs) return null;
                                        return Object.entries(catData.subs).sort((a,b) => b[1] - a[1]).map(([subName, val]) => (
                                            <div key={subName} className="flex justify-between items-center p-3 bg-muji-bg rounded-lg">
                                                <span className="font-bold text-sm text-muji-text">{subName}</span>
                                                <span className="font-mono font-bold text-sm text-muji-muted">${val.toLocaleString()}</span>
                                            </div>
                                        ));
                                    })()}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SettingsView = ({ data, saveData, setInputModal, showToast }) => {
            const [expandedSection, setExpandedSection] = useState('');
            const [editCategoryType, setEditCategoryType] = useState('expense');
            const [newCategorySubs, setNewCategorySubs] = useState({});
            const [newAccountTypeLabel, setNewAccountTypeLabel] = useState('');
            const [newDebtTarget, setNewDebtTarget] = useState('');
            const [newDebtPercent, setNewDebtPercent] = useState('');

            const toggleSection = (section) => setExpandedSection(expandedSection === section ? '' : section);
            useEffect(() => { refreshIcons(); }, [expandedSection, editCategoryType]);

            const ensureSettings = () => {
                const newData = { ...data };
                if (!newData.settings) newData.settings = JSON.parse(JSON.stringify(INITIAL_DATA.settings));
                if (!newData.settings.accountTypes) newData.settings.accountTypes = DEFAULT_ACCOUNT_TYPES;
                if (!newData.debtTargets) newData.debtTargets = DEFAULT_DEBT_TARGETS;
                return newData;
            };

            const handleAddSub = (groupId) => {
                const val = newCategorySubs[groupId] ? newCategorySubs[groupId].trim() : '';
                if (!val) return showToast('請輸入名稱', 'error');
                const newData = ensureSettings();
                const group = newData.settings.categoryGroups[editCategoryType].find(g => g.id === groupId);
                if (group) {
                    group.subs.push(val);
                    saveData(newData);
                    setNewCategorySubs(prev => ({ ...prev, [groupId]: '' }));
                    showToast('已新增子分類');
                }
            };

            const handleDeleteSub = (groupId, subName) => {
                const newData = ensureSettings();
                const group = newData.settings.categoryGroups[editCategoryType].find(g => g.id === groupId);
                if (group) {
                    group.subs = group.subs.filter(s => s !== subName);
                    saveData(newData);
                    showToast('子分類已刪除');
                }
            };

            const handleAddAccountType = () => {
                if (!newAccountTypeLabel) return showToast('請輸入名稱', 'error');
                const newData = ensureSettings();
                const newKey = `custom_${Date.now()}`;
                newData.settings.accountTypes[newKey] = { label: newAccountTypeLabel, icon: 'wallet' };
                saveData(newData);
                setNewAccountTypeLabel('');
                showToast('已新增帳戶類型');
            };

            const handleDeleteAccountType = (key) => {
                const newData = ensureSettings();
                delete newData.settings.accountTypes[key];
                saveData(newData);
                showToast('帳戶類型已刪除');
            };

            const handleAddDebtTarget = () => {
                if (!newDebtTarget) return showToast('請輸入名稱', 'error');
                const newData = ensureSettings();
                if (!newData.debtTargets) newData.debtTargets = [];
                newData.debtTargets.push({ id: `dt_${Date.now()}`, name: newDebtTarget, defaultPercent: newDebtPercent || '' });
                saveData(newData);
                setNewDebtTarget('');
                setNewDebtPercent('');
                showToast('已新增對象');
            };

            const handleDeleteDebtTarget = (id) => {
                const newData = ensureSettings();
                newData.debtTargets = newData.debtTargets.filter(t => t.id !== id);
                saveData(newData);
                showToast('對象已刪除');
            };

            const categoryGroups = data.settings?.categoryGroups || DEFAULT_CATEGORY_GROUPS;
            const accountTypes = data.settings?.accountTypes || DEFAULT_ACCOUNT_TYPES;
            const debtTargets = data.debtTargets || DEFAULT_DEBT_TARGETS;

            return (
                <div className="p-6 space-y-8 animate-fade pb-20 text-sm">
                    
                    <CollapsibleSection title="分類管理 (大/小分類)" isOpen={expandedSection === 'category'} onToggle={() => toggleSection('category')}>
                        <div className="flex bg-muji-bg rounded-lg p-1 mb-4">
                            <button onClick={() => setEditCategoryType('expense')} className={`flex-1 py-2 rounded text-sm font-bold transition ${editCategoryType === 'expense' ? 'bg-white shadow-sm text-muji-text' : 'text-muji-muted'}`}>支出</button>
                            <button onClick={() => setEditCategoryType('income')} className={`flex-1 py-2 rounded text-sm font-bold transition ${editCategoryType === 'income' ? 'bg-white shadow-sm text-muji-text' : 'text-muji-muted'}`}>收入</button>
                        </div>
                        <div className="space-y-4">
                            {categoryGroups[editCategoryType].map(group => (
                                <div key={group.id} className="border border-muji-border rounded-lg p-3">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="flex items-center gap-2 font-bold text-muji-text text-sm"><LucideIcon name={group.icon} className="w-4 h-4" /> {group.label}</div>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                className="w-24 p-1 bg-muji-bg rounded border-none text-sm text-muji-text" 
                                                placeholder="新子類" 
                                                value={newCategorySubs[group.id] || ''} 
                                                onChange={e => setNewCategorySubs(prev => ({...prev, [group.id]: e.target.value}))} 
                                                onKeyDown={(e) => e.key === 'Enter' && handleAddSub(group.id)} 
                                            />
                                            <button onClick={() => handleAddSub(group.id)} className="text-sm bg-muji-accent text-white px-2 py-1 rounded transition">＋</button>
                                        </div>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {group.subs.map(sub => (<span key={sub} className="text-sm bg-muji-bg px-2 py-1 rounded flex items-center gap-1 text-muji-text">{sub}<button onClick={() => handleDeleteSub(group.id, sub)} className="text-muji-muted hover:text-muji-red">×</button></span>))}
                                        {group.subs.length === 0 && <span className="text-sm text-muji-muted">無小分類</span>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </CollapsibleSection>

                    <CollapsibleSection title="帳戶類型管理" isOpen={expandedSection === 'account_type'} onToggle={() => toggleSection('account_type')}>
                        <div className="flex flex-wrap gap-2 mb-4">
                            {Object.entries(accountTypes).map(([key, conf]) => (
                                <div key={key} className="flex items-center gap-2 px-3 py-2 bg-muji-bg rounded-lg text-sm">
                                    <LucideIcon name={conf.icon} className="w-4 h-4" /> {conf.label} 
                                    {['cash', 'bank', 'credit', 'ticket', 'stock', 'pay'].indexOf(key) === -1 && 
                                        <button onClick={() => handleDeleteAccountType(key)} className="text-muji-red ml-1">×</button>
                                    }
                                </div>
                            ))}
                        </div>
                        <div className="flex gap-2">
                            <input className="flex-1 p-2 bg-muji-bg rounded border-none text-sm text-muji-text" placeholder="輸入類型名稱" value={newAccountTypeLabel} onChange={e => setNewAccountTypeLabel(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddAccountType()} />
                            <button onClick={handleAddAccountType} className="bg-muji-accent text-white px-4 py-2 rounded text-sm font-bold">新增</button>
                        </div>
                    </CollapsibleSection>

                    <CollapsibleSection title="代墊對象與比例" isOpen={expandedSection === 'debt_targets'} onToggle={() => toggleSection('debt_targets')}>
                        <div className="space-y-2 mb-4 max-h-40 overflow-y-auto">
                            {debtTargets.map(t => (<div key={t.id} className="flex justify-between items-center p-2 bg-muji-bg rounded text-sm"><div className="flex items-center gap-2"><span className="font-bold">{t.name}</span>{t.defaultPercent && <span className="text-sm bg-muji-accent text-white px-1.5 rounded">{t.defaultPercent}%</span>}</div><button onClick={() => handleDeleteDebtTarget(t.id)} className="text-muji-muted hover:text-muji-red"><LucideIcon name="trash-2" className="w-4 h-4" /></button></div>))}
                        </div>
                        <div className="flex flex-col gap-2 p-3 bg-muji-bg rounded-lg">
                            <div className="flex gap-2">
                                <input className="flex-1 p-2 bg-white rounded border-none text-sm text-muji-text" placeholder="名稱 (如: 朋友A)" value={newDebtTarget} onChange={e => setNewDebtTarget(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddDebtTarget()} />
                                <input type="number" className="w-20 p-2 bg-white rounded border-none text-sm text-muji-text" placeholder="預設%" value={newDebtPercent} onChange={e => setNewDebtPercent(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddDebtTarget()} />
                            </div>
                            <button onClick={handleAddDebtTarget} className="w-full py-2 bg-muji-accent text-white rounded text-sm font-bold">新增對象</button>
                        </div>
                    </CollapsibleSection>
                </div>
            );
        };

        const DebtView = ({ data, saveData, showToast, setViewingTarget, viewingTarget }) => {
            const [repayAmount, setRepayAmount] = useState('');
            const [selectedTxIds, setSelectedTxIds] = useState([]);
            const [repayAccountId, setRepayAccountId] = useState('');
            
            const debts = getDebtSummary(data);
            const userAccounts = data.accounts;

            const getTargetTransactions = (target) => {
                return data.transactions.filter(t => ((t.targetName === target && (t.type === 'advance' || t.type === 'repay')) || (t.splits && t.splits.some(s => s.name === target))));
            };

            const handleRepay = () => {
                const amount = parseFloat(repayAmount);
                if (!amount || !repayAccountId) return;
                
                const newTxs = [...data.transactions];
                // Mark selected as settled
                selectedTxIds.forEach(id => {
                    const idx = newTxs.findIndex(t => t.id === id);
                    if(idx !== -1) newTxs[idx] = { ...newTxs[idx], isSettled: true };
                });
                // Add repay tx
                newTxs.push({ id: Date.now().toString(), date: new Date().toISOString().split('T')[0], type: 'repay', accountId: repayAccountId, amount, targetName: viewingTarget, note: '債務結算', isSettled: true }); // Repayment itself is considered settled in context of history
                
                saveData({ ...data, transactions: newTxs });
                setViewingTarget(null); setSelectedTxIds([]); setRepayAmount('');
                showToast('還款已記錄');
            };

            if (viewingTarget) {
                const txs = getTargetTransactions(viewingTarget);
                const selectedTotal = txs.filter(t => selectedTxIds.includes(t.id)).reduce((sum, t) => {
                    if (t.type === 'advance') return sum + t.amount;
                    if (t.type === 'expense') return sum + (parseFloat(t.splits?.find(s => s.name === viewingTarget)?.amount || 0));
                    return sum;
                }, 0);

                return (
                    <div className="p-4 h-full flex flex-col">
                        <div className="flex items-center gap-4 mb-4"><button onClick={() => setViewingTarget(null)}><LucideIcon name="arrow-left" className="w-6 h-6" /></button><h3 className="text-xl font-bold">{viewingTarget} 明細</h3></div>
                        <div className="flex-1 overflow-y-auto mb-4">
                            {txs.sort((a,b) => new Date(b.date) - new Date(a.date)).map(tx => {
                                let amt = tx.amount;
                                if (tx.type === 'expense') amt = parseFloat(tx.splits?.find(s => s.name === viewingTarget)?.amount || 0);
                                
                                const isSettled = tx.isSettled; // Check status

                                return (
                                    <div key={tx.id} className={`flex items-center p-3 border-b border-muji-border gap-3 ${isSettled ? 'opacity-40 bg-gray-50' : 'cursor-pointer hover:bg-muji-hover'}`} onClick={() => !isSettled && setSelectedTxIds(prev => prev.includes(tx.id) ? prev.filter(i => i !== tx.id) : [...prev, tx.id])}>
                                        {/* Checkbox: Only show if not settled */}
                                        <div className="w-6 h-6 flex-shrink-0 flex items-center justify-center">
                                            {!isSettled && (
                                                <input type="checkbox" checked={selectedTxIds.includes(tx.id)} readOnly className="accent-muji-accent w-4 h-4" />
                                            )}
                                        </div>
                                        
                                        {/* Left side: Date and Note */}
                                        <div className="flex-1 flex flex-col min-w-0">
                                            <span className={`text-xs text-muji-muted font-mono mb-0.5 ${isSettled ? 'line-through' : ''}`}>{tx.date}</span>
                                            <span className={`text-sm font-bold text-muji-text truncate ${isSettled ? 'line-through' : ''}`}>{tx.note || '無備註'}</span>
                                        </div>

                                        {/* Right side: Amount */}
                                        <div className={`text-right font-mono font-bold whitespace-nowrap flex-shrink-0 ${isSettled ? 'line-through text-muji-muted' : (tx.type==='repay'?'text-green-600':'text-orange-500')}`}>
                                            ${amt.toLocaleString()}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="bg-white p-4 border-t border-muji-border shadow-inner">
                            <div className="flex justify-between mb-2 text-sm"><span className="text-muji-muted">選取總額</span><span className="font-bold font-mono text-lg text-orange-500">${selectedTotal.toLocaleString()}</span></div>
                            <div className="flex gap-2 mb-2"><input type="number" className="flex-1 p-3 border border-muji-border rounded-lg bg-muji-bg font-mono" placeholder="實際還款金額" value={repayAmount} onChange={e => setRepayAmount(e.target.value)} /><select className="flex-1 p-3 border border-muji-border rounded-lg bg-muji-bg" value={repayAccountId} onChange={e => setRepayAccountId(e.target.value)}><option value="">存入帳戶</option>{userAccounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>
                            <button onClick={handleRepay} disabled={selectedTotal <= 0} className={`w-full py-3 text-white rounded-lg font-bold shadow-sm transition-all ${selectedTotal > 0 ? 'bg-muji-accent hover:opacity-90' : 'bg-gray-300 cursor-not-allowed'}`}>確認還款</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-6 md:p-10">
                    <h3 className="text-2xl font-bold mb-6">債務管理</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {Object.entries(debts).map(([name, amount]) => {
                            // Show all targets, even if balance is 0, so history can be viewed
                            return (
                                <div key={name} onClick={() => setViewingTarget(name)} className="bg-white p-5 rounded-xl border border-muji-border shadow-sm cursor-pointer hover:shadow-md flex justify-between items-center transition-all">
                                    <span className="font-bold text-lg">{name}</span>
                                    <span className={`font-mono font-bold text-xl ${amount > 0 ? 'text-orange-500' : (amount < 0 ? 'text-green-600' : 'text-muji-muted')}`}>
                                        {amount > 0 ? '欠款' : (amount < 0 ? '溢繳' : '結清')} ${Math.abs(amount).toLocaleString()}
                                    </span>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const AppLayout = ({ children, view, setView, syncStatus, selectedAccount, setSelectedAccount, onResetDebt, data }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            
            return (
                <div className="h-screen w-screen bg-muji-bg text-muji-text font-sans flex overflow-hidden">
                    <div className={`hidden md:flex ${isCollapsed ? 'w-20' : 'w-48'} bg-muji-sidebar border-r border-muji-border flex-col p-4 space-y-4 transition-all duration-300 ease-in-out relative`}>
                        <button onClick={() => setIsCollapsed(!isCollapsed)} className="absolute -right-3 top-8 bg-white border border-muji-border rounded-full p-1 shadow-sm text-muji-muted hover:text-muji-accent z-10 hidden md:block"><LucideIcon name={isCollapsed ? "chevron-right" : "chevron-left"} className="w-4 h-4" /></button>
                        <div className={`flex items-center gap-2 mb-2 px-2 ${isCollapsed ? 'justify-center' : ''}`}><div className="w-8 h-8 bg-muji-accent rounded-full flex items-center justify-center text-white flex-shrink-0"><LucideIcon name="wallet" className="w-5 h-5" /></div>{!isCollapsed && (<h1 className="font-bold text-lg">我的記帳</h1>)}</div>
                        <div className="space-y-1">
                            {[{ id: 'dashboard', label: '總覽', icon: 'layout-grid' }, { id: 'accounting', label: '記帳', icon: 'notebook-pen' }, { id: 'analysis', label: '分析', icon: 'pie-chart' }, { id: 'debt', label: '債務', icon: 'hand-coins' }, { id: 'settings', label: '設定', icon: 'settings' }].map(item => (
                                <button key={item.id} onClick={() => { setView(item.id); if(item.id==='debt') onResetDebt(); if(['dashboard','accounting'].includes(item.id)) setSelectedAccount(null); }} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all text-sm ${view === item.id ? 'bg-white shadow-sm text-muji-accent font-bold' : 'text-muji-muted hover:bg-muji-hover'} ${isCollapsed ? 'justify-center px-0' : ''}`} title={isCollapsed ? item.label : ''}><LucideIcon name={item.icon} className="w-5 h-5 flex-shrink-0" /> {!isCollapsed && <span>{item.label}</span>}</button>
                            ))}
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col h-full bg-muji-bg relative overflow-hidden">
                        <div className="absolute top-6 right-6 z-20 flex items-center gap-4">
                             <div className="text-xs font-mono text-muji-muted tracking-wider">{new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' })}</div>
                             {GITHUB_CONFIG.ENABLED && <div title={syncStatus} className={`p-2 rounded-full bg-white transition-colors duration-300 border border-muji-border ${syncStatus === 'syncing' ? 'text-muji-accent animate-spin' : syncStatus === 'error' ? 'text-red-500' : 'text-muji-green'}`}><LucideIcon name="refresh-cw" className="w-4 h-4" /></div>}
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar md:p-8 pt-16 md:pt-8">{children}</div>
                        <div className="md:hidden fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-muji-border p-2 pb-6 flex justify-around items-center z-30">
                            {[{ id: 'dashboard', icon: 'layout-grid', label: '總覽' }, { id: 'accounting', icon: 'notebook-pen', label: '記帳' }, { id: 'analysis', icon: 'pie-chart', label: '分析' }, { id: 'settings', icon: 'settings', label: '設定' }].map(item => (
                                <button key={item.id} onClick={() => { setView(item.id); setSelectedAccount(null); }} className={`flex flex-col items-center p-2 rounded-lg w-16 transition ${view === item.id ? 'text-muji-accent' : 'text-muji-muted'}`}><LucideIcon name={item.icon} className="w-6 h-6" /><span className="text-[10px] mt-1 font-medium">{item.label}</span></button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard'); 
            const [data, setData] = useState(INITIAL_DATA);
            const [toast, setToast] = useState(null);
            const [selectedAccount, setSelectedAccount] = useState(null);
            const [inputModal, setInputModal] = useState({ show: false, title: '', value: '', type: '', data: null, extra: null, value2: '', value3: '' }); 
            const [syncStatus, setSyncStatus] = useState('idle');
            const [sha, setSha] = useState(null);
            const [viewingDebtTarget, setViewingDebtTarget] = useState(null); 

            const showToast = useCallback((msg, type = 'info') => setToast({ message: msg, type }), []);
            
            // GitHub Sync Logic
            const fetchContent = async (path) => {
                const { TOKEN, REPO } = window.GITHUB_CONFIG;
                if (!TOKEN || !REPO) return null;
                const safeToken = TOKEN.replace(/[^\x00-\x7F]/g, "").trim();
                try {
                    const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, { headers: { 'Authorization': `token ${safeToken}`, 'Accept': 'application/vnd.github.v3+json' } });
                    if (res.status === 404) return null;
                    if (res.status === 401) { setSyncStatus('error'); showToast('Token 無效', 'error'); return null; }
                    const json = await res.json();
                    if (path === window.GITHUB_CONFIG.PATH) setSha(json.sha);
                    const content = decodeURIComponent(escape(window.atob(json.content)));
                    return content;
                } catch (e) { console.error("Fetch Error", e); return null; }
            };

            const saveToGithub = async (contentObj, explicitSha = null) => {
                const { TOKEN, REPO, PATH } = window.GITHUB_CONFIG;
                const safeToken = TOKEN.replace(/[^\x00-\x7F]/g, "").trim();
                const contentStr = window.btoa(unescape(encodeURIComponent(JSON.stringify(contentObj))));
                const body = { message: `Update ${PATH} ${new Date().toLocaleString()}`, content: contentStr };
                
                if (!explicitSha) {
                     try {
                        const checkRes = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}`, { 
                            headers: { 'Authorization': `token ${safeToken}` }
                        });
                        if (checkRes.ok) {
                            const checkJson = await checkRes.json();
                            body.sha = checkJson.sha;
                        }
                    } catch(e) {}
                } else {
                    body.sha = explicitSha;
                }

                const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}`, { method: 'PUT', headers: { 'Authorization': `token ${safeToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (!res.ok) throw new Error("Save Failed");
                return await res.json();
            };

            const loadData = async () => {
                if (window.GITHUB_CONFIG.ENABLED && window.GITHUB_CONFIG.TOKEN && window.GITHUB_CONFIG.REPO) {
                    setSyncStatus('syncing');
                    try {
                        const content = await fetchContent(window.GITHUB_CONFIG.PATH);
                        if (content) {
                            const parsed = JSON.parse(content);
                            const merged = { ...INITIAL_DATA, ...parsed };
                            if(!merged.settings) merged.settings = INITIAL_DATA.settings;
                            setData(merged);
                            setSyncStatus('success');
                        } else {
                            setSyncStatus('idle');
                        }
                    } catch (e) {
                        setSyncStatus('error');
                        showToast('GitHub 同步失敗，使用本地資料', 'error');
                        loadLocal();
                    }
                } else {
                    loadLocal();
                }
            };

            const loadLocal = () => {
                const saved = localStorage.getItem('money_data_single');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setData({ ...INITIAL_DATA, ...parsed }); 
                    } catch(e) { console.error("Load failed", e); }
                }
            };

            useEffect(() => {
                loadData();
            }, []);

            const saveData = async (newData) => {
                setData(newData);
                localStorage.setItem('money_data_single', JSON.stringify(newData));
                if (window.GITHUB_CONFIG.ENABLED && window.GITHUB_CONFIG.TOKEN && window.GITHUB_CONFIG.REPO) {
                    setSyncStatus('syncing');
                    try {
                        const res = await saveToGithub(newData, sha);
                        setSha(res.content.sha);
                        setSyncStatus('success');
                        showToast('已同步至雲端');
                    } catch (e) {
                        setSyncStatus('error');
                        showToast('雲端同步失敗', 'error');
                    }
                }
            };

            const dailyQuote = useMemo(() => { const d = new Date().getDate(); return QUOTES[(d - 1) % QUOTES.length] || QUOTES[0]; }, []);

            const handleInputConfirm = () => {
                const val = inputModal.value ? inputModal.value.trim() : '';
                if (!val && !inputModal.type.includes('delete') && inputModal.type !== 'calibrate_account') { showToast('請輸入名稱', 'error'); return; }
                let newData = { ...data }; let successMessage = '更新成功';
                
                switch(inputModal.type) {
                    case 'add_account': 
                        const newAccId = `acc_${Date.now()}`; 
                        const initBal = parseFloat(inputModal.value2) || 0; 
                        newData.accounts.push({ 
                            id: newAccId, 
                            name: val, 
                            type: inputModal.extra || 'cash', 
                            balance: initBal, 
                            closingDay: (inputModal.extra === 'credit' ? inputModal.value3 : undefined) 
                        }); 
                        successMessage = '已新增帳戶'; 
                        break;
                    case 'rename_account':
                         newData.accounts = newData.accounts.map(a => a.id === inputModal.data ? { ...a, name: val, balance: parseFloat(inputModal.value2) || a.balance } : a);
                         successMessage = '帳戶已更新';
                         break;
                    case 'delete_account':
                        newData.accounts = newData.accounts.filter(a => a.id !== inputModal.data);
                        newData.transactions = newData.transactions.filter(t => t.accountId !== inputModal.data && t.toAccountId !== inputModal.data);
                        if(selectedAccount === inputModal.data) setSelectedAccount(null);
                        successMessage = '帳戶已刪除';
                        break;
                    case 'calibrate_account':
                         const newBalance = parseFloat(inputModal.value) || 0;
                         const accIndex = newData.accounts.findIndex(a => a.id === inputModal.data);
                         if(accIndex !== -1) { newData.accounts[accIndex].balance = newBalance; }
                         successMessage = '餘額已校正';
                         break;
                }
                saveData(newData); showToast(successMessage); setInputModal({ ...inputModal, show: false });
            };

            // Calculate Dashboard Stats
            const totalAssets = data.accounts.reduce((sum, acc) => sum + calculateBalance(data, acc.id), 0);
            const monthlyStats = calculateMonthlyStats(data);
            const monthlyNet = monthlyStats.income - monthlyStats.expense;

            return (
                <AppLayout 
                    view={view} 
                    setView={setView} 
                    syncStatus={syncStatus} 
                    selectedAccount={selectedAccount} 
                    setSelectedAccount={setSelectedAccount} 
                    onResetDebt={() => setViewingDebtTarget(null)} 
                    data={data}
                >
                    {view === 'dashboard' && (
                        <div className="p-6 space-y-8 animate-fade h-full flex flex-col justify-center max-w-4xl mx-auto pb-24">
                            <div className="mb-4 text-center">
                                <h2 className="text-3xl font-bold text-muji-text mb-2 font-mono tracking-widest">通往財富自由之路</h2>
                                <p className="text-muji-accent text-sm font-mono tracking-widest uppercase">{dailyQuote}</p>
                            </div>
                            <div className="bg-white rounded-2xl p-6 text-center shadow-sm border border-muji-border relative h-32 flex flex-col justify-center items-center">
                                <div className="text-muji-muted text-sm font-medium mb-2 font-mono tracking-widest uppercase">總資產</div>
                                <div className="text-5xl font-bold text-muji-text tracking-tighter tabular-nums font-mono">${totalAssets.toLocaleString()}</div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 w-full md:w-2/3 mx-auto z-10">
                                <div className="bg-emerald-50/60 p-4 rounded-xl border border-emerald-100 shadow-sm flex flex-col items-center">
                                    <span className="text-xs text-emerald-800 mb-1 font-mono font-bold uppercase tracking-wider">本月收入</span>
                                    <span className="text-lg font-bold text-emerald-900 font-mono">+${monthlyStats.income.toLocaleString()}</span>
                                </div>
                                <div onClick={() => { setView('accounting'); }} className="bg-rose-50/60 p-4 rounded-xl border border-rose-100 shadow-sm flex flex-col items-center cursor-pointer hover:bg-rose-100">
                                    <span className="text-xs text-rose-800 mb-1 font-mono font-bold uppercase tracking-wider">本月支出</span>
                                    <span className="text-lg font-bold text-rose-900 font-mono">-${monthlyStats.expense.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'accounting' && <AccountingView data={data} saveData={saveData} selectedAccount={selectedAccount} setSelectedAccount={setSelectedAccount} setInputModal={setInputModal} showToast={showToast} />}
                    {view === 'analysis' && <AnalysisView data={data} />}
                    {view === 'settings' && <SettingsView data={data} saveData={saveData} setInputModal={setInputModal} showToast={showToast} />}
                    
                    {view === 'debt' && <DebtView data={data} saveData={saveData} showToast={showToast} setViewingTarget={setViewingDebtTarget} viewingTarget={viewingDebtTarget} />}

                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {inputModal.show && (
                        <Modal title={inputModal.title} onClose={() => setInputModal({ ...inputModal, show: false })}>
                            <div className="space-y-4">
                                {inputModal.type === 'add_account' && <div className="flex bg-muji-bg rounded-lg p-1 overflow-x-auto no-scrollbar">{Object.entries(data.settings?.accountTypes || DEFAULT_ACCOUNT_TYPES).map(([key, config]) => <button key={key} onClick={() => setInputModal({...inputModal, extra: key})} className={`flex-1 min-w-[3rem] py-2 rounded text-xs font-bold ${inputModal.extra === key ? 'bg-white shadow-sm' : ''}`}><LucideIcon name={config.icon} className="w-4 h-4" /> {config.label}</button>)}</div>}
                                <input autoFocus className="w-full p-3 bg-muji-bg rounded-lg" value={inputModal.value} onChange={(e) => setInputModal({ ...inputModal, value: e.target.value })} placeholder="名稱/金額" />
                                {(inputModal.type === 'add_account' || inputModal.type === 'rename_account') && <input type="number" className="w-full p-3 bg-muji-bg rounded-lg" value={inputModal.value2} onChange={(e) => setInputModal({ ...inputModal, value2: e.target.value })} placeholder="初始金額" />}
                                <button onClick={handleInputConfirm} className="w-full py-3 bg-muji-accent text-white rounded-lg font-bold">確認</button>
                            </div>
                        </Modal>
                    )}
                </AppLayout>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>