<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>證券投資 - FinancePro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .recharts-default-tooltip { border-radius: 12px !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1) !important; border: none !important; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } = Recharts;
        const Icon = ({ name, size=20 }) => { useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [name]); return <i data-lucide={name} width={size} height={size}></i>; };
        
        // --- Config ---
        const CONFIG = { TOKEN_PREFIX: "ghp_", TOKEN_BODY: "uGYqNrODupI2hp9QjKSZCVtSygLzwB1jY42B", REPO: "zenningh1983/money", PATH: "wealth_freedom_v11.json" };
        const getGithubToken = () => CONFIG.TOKEN_PREFIX + CONFIG.TOKEN_BODY;
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const utf8_to_b64 = (str) => window.btoa(unescape(encodeURIComponent(str)));
        const b64_to_utf8 = (str) => decodeURIComponent(escape(window.atob(str)));
        const formatCurrency = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(val);
        const COLORS = ['#34C759', '#007AFF', '#5856D6', '#FF2D55', '#FF9500', '#AF52DE', '#5AC8FA', '#FF3B30', '#4CD964'];

        // --- App ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('fp_current_user')));
            useEffect(() => { if (!currentUser) window.location.href = 'index.html'; }, [currentUser]);

            // Data
            const [stockTxs, setStockTxs] = useState(() => JSON.parse(localStorage.getItem('fp_stock_txs')) || []);
            // Load others to preserve during sync
            const [accounts, setAccounts] = useState(() => JSON.parse(localStorage.getItem('fp_accounts')) || []);
            const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem('fp_transactions')) || []);
            const [categories, setCategories] = useState(() => JSON.parse(localStorage.getItem('fp_categories')) || []);
            const [userList, setUserList] = useState(() => JSON.parse(localStorage.getItem('fp_users')) || []);
            const [people, setPeople] = useState(() => JSON.parse(localStorage.getItem('fp_people')) || []);

            const [view, setView] = useState('dashboard');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [syncStatus, setSyncStatus] = useState('idle');

            const dataRef = useRef({ accounts, categories, transactions, stockTxs, userList, people });
            useEffect(() => { dataRef.current = { accounts, categories, transactions, stockTxs, userList, people }; }, [accounts, categories, transactions, stockTxs, userList, people]);

            useEffect(() => { localStorage.setItem('fp_stock_txs', JSON.stringify(stockTxs)); }, [stockTxs]);

            const syncData = async (mode) => {
                 const token = getGithubToken();
                 if(!token) return;
                 setSyncStatus('loading');
                 const url = `https://api.github.com/repos/${CONFIG.REPO}/contents/${CONFIG.PATH}`;
                 try {
                     if (mode === 'push') {
                        let sha = null;
                        try { const res = await fetch(url, { headers: { Authorization: `token ${token}` } }); if(res.ok) { const d = await res.json(); sha = d.sha; } } catch(e){}
                        const content = utf8_to_b64(JSON.stringify(dataRef.current));
                        await fetch(url, { method: 'PUT', headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: 'Sync from Investment', content, sha }) });
                        setSyncStatus('success');
                     } else {
                        const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                        if(res.ok) {
                            const d = await res.json();
                            const c = JSON.parse(b64_to_utf8(d.content));
                            setStockTxs(c.stockTxs || []);
                            setSyncStatus('success');
                        }
                    }
                 } catch(e) { setSyncStatus('error'); }
                 setTimeout(() => setSyncStatus('idle'), 2000);
            };

            const myStockTxs = stockTxs.filter(t => t.userId === currentUser?.id);
            const portfolio = useMemo(() => {
                const holdings = {}; let totalReturn = 0, div = 0;
                [...myStockTxs].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                    if (!holdings[t.ticker]) holdings[t.ticker] = { ticker: t.ticker, shares: 0, cost: 0 };
                    if (t.type === 'BUY') { holdings[t.ticker].shares += t.shares; holdings[t.ticker].cost += (t.shares*t.price+t.fees); }
                    else if (t.type === 'SELL') { holdings[t.ticker].shares -= t.shares; totalReturn += ((t.shares*t.price-t.fees) - (holdings[t.ticker].cost/holdings[t.ticker].shares)*t.shares); }
                    else if (t.type === 'DIVIDEND') { div += t.amount; totalReturn += t.amount; }
                });
                const list = Object.values(holdings).map(h => ({ ...h, avgPrice: h.shares > 0 ? h.cost/h.shares : 0, mktPrice: h.shares > 0 ? (h.cost/h.shares)*1.05 : 0 })).filter(h => h.shares > 0);
                const mktVal = list.reduce((a, b) => a + (b.shares * b.mktPrice), 0);
                return { holdings: list, mktVal, totalReturn, div };
            }, [myStockTxs]);

            return (
                <div className="flex h-screen bg-slate-50">
                    <div className="w-64 bg-white border-r hidden md:flex flex-col p-4">
                        <div className="font-bold text-xl mb-8 flex items-center gap-2 text-purple-600"><Icon name="trending-up"/> 證券投資</div>
                        <nav className="flex-1 space-y-2">
                            <button onClick={()=>setView('dashboard')} className="w-full p-2 text-left hover:bg-purple-50 text-purple-700 rounded font-bold flex gap-2"><Icon name="layout-grid"/> 資產概況</button>
                        </nav>
                        <div className="mt-auto pt-4 border-t space-y-2">
                             <div className="flex items-center gap-2 p-2">
                                <div className="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center font-bold">{currentUser?.name?.[0]}</div>
                                <div className="font-bold text-sm">{currentUser?.name}</div>
                             </div>
                             <button onClick={() => window.location.href='accounting.html'} className="w-full p-2 text-left hover:bg-blue-50 text-blue-600 rounded flex items-center gap-2 font-bold"><Icon name="wallet"/> 前往現金帳本</button>
                             <button onClick={() => window.location.href='index.html'} className="w-full p-2 text-left hover:bg-gray-100 text-gray-500 rounded flex items-center gap-2 font-bold"><Icon name="log-out"/> 返回首頁</button>
                        </div>
                    </div>
                    <div className="flex-1 p-8 overflow-auto">
                        <div className="absolute top-6 right-6"><button onClick={()=>syncData('pull')} className={`p-3 rounded-full shadow-lg transition-colors ${syncStatus==='loading'?'bg-blue-100 text-blue-600':syncStatus==='success'?'bg-green-100 text-green-600':syncStatus==='error'?'bg-red-100 text-red-600':'bg-white text-gray-600'}`}><Icon name="cloud"/></button></div>
                        <h1 className="text-2xl font-bold mb-4">投資組合</h1>
                        
                        {view === 'dashboard' && (
                             <div className="space-y-6 animate-fade-in">
                                <div className="bg-gradient-to-br from-indigo-900 to-purple-800 text-white p-8 rounded-[2.5rem] shadow-2xl"><div className="text-sm mb-1 text-indigo-200">證券總市值</div><div className="text-4xl font-bold">{formatCurrency(portfolio.mktVal)}</div></div>
                                <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex justify-center h-64">
                                     {portfolio.holdings.length > 0 ? <ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={portfolio.holdings.map(h=>({name:h.ticker,value:h.mktPrice*h.shares}))} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={80} fill="#8884d8">{portfolio.holdings.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}</Pie><Tooltip /></PieChart></ResponsiveContainer> : <div className="text-gray-400 self-center">無持股</div>}
                                </div>
                             </div>
                        )}
                    </div>
                    {/* Mobile Nav */}
                    <div className="md:hidden fixed bottom-0 w-full bg-white border-t p-2 flex justify-around z-20">
                        <button onClick={() => setView('dashboard')} className="flex flex-col items-center p-2 text-purple-600"><Icon name="layout-grid"/><span className="text-[10px]">概覽</span></button>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
