import React, { useState, useEffect, useCallback } from 'react';
import { 
  PieChart, Wallet, CreditCard, Landmark, Banknote, 
  Plus, Minus, Save, Trash2, Edit2, X, ChevronDown, ChevronRight,
  Sparkles, Camera, Mic, FileText, Settings, LayoutGrid,
  Tag, Check, ClipboardList, StickyNote, FolderOpen, Layers, Users, ChevronUp,
  Github, CloudUpload, CloudDownload, AlertCircle, RefreshCw
} from 'lucide-react';

// --- Utils & Constants ---

const generateId = () => Math.random().toString(36).substr(2, 9);

// 解決 Base64 中文亂碼問題
const utf8_to_b64 = (str) => window.btoa(unescape(encodeURIComponent(str)));
const b64_to_utf8 = (str) => decodeURIComponent(escape(window.atob(str)));

const DEFAULT_CATEGORIES = [
  { 
    id: 'c_food', name: '飲食', type: 'expense', color: 'bg-orange-100 text-orange-600',
    subs: [
      { id: 's_bf', name: '早餐' }, { id: 's_lun', name: '午餐' }, { id: 's_din', name: '晚餐' }, 
      { id: 's_bev', name: '飲料/咖啡' }, { id: 's_snack', name: '零食/點心' }, { id: 's_groc', name: '買菜/食材' }
    ]
  },
  { 
    id: 'c_trans', name: '交通', type: 'expense', color: 'bg-blue-100 text-blue-600',
    subs: [
      { id: 's_bus', name: '公車捷運' }, { id: 's_taxi', name: '計程車/Uber' }, 
      { id: 's_gas', name: '加油' }, { id: 's_park', name: '停車費' }, { id: 's_main', name: '保養維修' }
    ]
  },
  { 
    id: 'c_ent', name: '娛樂', type: 'expense', color: 'bg-purple-100 text-purple-600',
    subs: [
      { id: 's_mov', name: '電影/展覽' }, { id: 's_game', name: '遊戲/課金' }, 
      { id: 's_sub', name: '串流訂閱' }, { id: 's_tvl', name: '旅遊住宿' }, { id: 's_party', name: '聚餐交際' }
    ]
  },
  { 
    id: 'c_life', name: '生活', type: 'expense', color: 'bg-pink-100 text-pink-600',
    subs: [
      { id: 's_daily', name: '日用品' }, { id: 's_cloth', name: '服飾鞋包' }, 
      { id: 's_beauty', name: '美妝保養' }, { id: 's_med', name: '醫療保健' }, { id: 's_pet', name: '寵物' }
    ]
  },
  { 
    id: 'c_home', name: '居家', type: 'expense', color: 'bg-indigo-100 text-indigo-600',
    subs: [
      { id: 's_rent', name: '房租' }, { id: 's_util', name: '水電瓦斯' }, 
      { id: 's_net', name: '網路/電話' }, { id: 's_furn', name: '傢俱家電' }
    ]
  },
  { 
    id: 'c_learn', name: '學習', type: 'expense', color: 'bg-yellow-100 text-yellow-600',
    subs: [
      { id: 's_book', name: '書籍' }, { id: 's_course', name: '課程/補習' }
    ]
  },
  { 
    id: 'c_inc', name: '收入', type: 'income', color: 'bg-green-100 text-green-600',
    subs: [
      { id: 's_sal', name: '薪資' }, { id: 's_bonus', name: '獎金' }, 
      { id: 's_invest', name: '投資獲利' }, { id: 's_part', name: '兼職/外包' }
    ]
  }
];

const DEFAULT_ACCOUNTS = [
  { id: 'a_cash', name: '現金皮夾', type: 'cash', balance: 2000, icon: 'Banknote' },
  { id: 'a_bank', name: '薪資帳戶', type: 'bank', balance: 50000, icon: 'Landmark' },
  { id: 'a_card', name: '主力信用卡', type: 'credit', balance: -5000, icon: 'CreditCard' },
];

// --- Components ---

const Toast = ({ message, type, onClose }) => {
  useEffect(() => {
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, [onClose]);

  const bgClass = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-600' : 'bg-gray-800';

  return (
    <div className={`fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-white text-sm font-medium shadow-lg z-[60] flex items-center gap-2 animate-in fade-in slide-in-from-bottom-2 ${bgClass}`}>
      {type === 'error' && <AlertCircle size={16}/>}
      {type === 'success' && <Check size={16}/>}
      {message}
    </div>
  );
};

const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-lg" }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
      <div className={`bg-white rounded-2xl w-full ${maxWidth} max-h-[90vh] overflow-hidden shadow-2xl flex flex-col`}>
        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-white z-10 shrink-0">
          <h3 className="font-bold text-lg text-gray-800">{title}</h3>
          <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full"><X size={20} /></button>
        </div>
        <div className="p-4 flex-1 overflow-y-auto">{children}</div>
      </div>
    </div>
  );
};

const IconComponent = ({ name, size = 18, className }) => {
  const icons = { Wallet, CreditCard, Landmark, Banknote };
  const Icon = icons[name] || Wallet;
  return <Icon size={size} className={className} />;
};

// --- Main App ---

export default function FinancePro() {
  // --- Global State ---
  const [activeTab, setActiveTab] = useState('dashboard');
  const [toast, setToast] = useState(null); // { message, type }
  
  // Data State
  const [accounts, setAccounts] = useState(() => JSON.parse(localStorage.getItem('fp_accounts')) || DEFAULT_ACCOUNTS);
  const [categories, setCategories] = useState(() => JSON.parse(localStorage.getItem('fp_categories')) || DEFAULT_CATEGORIES);
  const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem('fp_transactions')) || []);
  
  // Settings State
  const [ghConfig, setGhConfig] = useState(() => JSON.parse(localStorage.getItem('fp_gh_config')) || { token: '', repo: '', path: 'finance_backup.json' });

  // UI State
  const [isTxModalOpen, setIsTxModalOpen] = useState(false);
  const [isSmartModalOpen, setIsSmartModalOpen] = useState(false);
  const [editingTx, setEditingTx] = useState(null);
  const [accountManageOpen, setAccountManageOpen] = useState(false);
  const [categoryManageOpen, setCategoryManageOpen] = useState(false);
  const [settingsOpen, setSettingsOpen] = useState(false);

  // Persistence
  useEffect(() => {
    localStorage.setItem('fp_accounts', JSON.stringify(accounts));
    localStorage.setItem('fp_categories', JSON.stringify(categories));
    localStorage.setItem('fp_transactions', JSON.stringify(transactions));
    localStorage.setItem('fp_gh_config', JSON.stringify(ghConfig));
  }, [accounts, categories, transactions, ghConfig]);

  const showToast = (message, type = 'info') => {
    setToast({ message, type });
  };

  // --- Logic ---

  const handleSaveTransaction = (txData) => {
    const amount = parseFloat(txData.amount);
    if (!amount) {
      showToast('請輸入有效金額', 'error');
      return;
    }

    const newTx = {
      ...txData,
      id: txData.id || generateId(),
      date: txData.date || new Date().toISOString(),
      amount: amount,
    };

    let newAccounts = [...accounts];
    
    // 如果是編輯，先還原舊餘額
    if (txData.id) {
      const oldTx = transactions.find(t => t.id === txData.id);
      if (oldTx) {
        newAccounts = newAccounts.map(acc => {
          if (acc.id === oldTx.accountId) {
            return { ...acc, balance: acc.balance - (oldTx.type === 'income' ? oldTx.amount : -oldTx.amount) };
          }
          return acc;
        });
      }
    }

    // 計算新餘額
    newAccounts = newAccounts.map(acc => {
      if (acc.id === newTx.accountId) {
        const change = newTx.type === 'income' ? amount : -amount;
        return { ...acc, balance: acc.balance + change };
      }
      return acc;
    });

    if (txData.id) {
      setTransactions(prev => prev.map(t => t.id === txData.id ? newTx : t));
    } else {
      setTransactions(prev => [newTx, ...prev]);
    }
    
    setAccounts(newAccounts);
    setIsTxModalOpen(false);
    setEditingTx(null);
    showToast('交易已儲存', 'success');
  };

  const handleBulkImport = (newTransactions) => {
    let newAccounts = [...accounts];
    const processedTxs = newTransactions.map(tx => ({
       ...tx,
       id: generateId(),
       amount: parseFloat(tx.amount)
    }));

    processedTxs.forEach(tx => {
       const accIndex = newAccounts.findIndex(a => a.id === tx.accountId);
       if(accIndex >= 0) {
          const change = tx.type === 'income' ? tx.amount : -tx.amount;
          newAccounts[accIndex] = { ...newAccounts[accIndex], balance: newAccounts[accIndex].balance + change };
       }
    });

    setTransactions(prev => [...processedTxs, ...prev]);
    setAccounts(newAccounts);
    showToast(`成功匯入 ${processedTxs.length} 筆交易！`, 'success');
  };

  const deleteTransaction = (id) => {
    if (!confirm('確定刪除此記錄？餘額將會回滾。')) return;
    const tx = transactions.find(t => t.id === id);
    if (!tx) return;

    setAccounts(prev => prev.map(acc => {
      if (acc.id === tx.accountId) {
        const change = tx.type === 'income' ? -tx.amount : tx.amount;
        return { ...acc, balance: acc.balance + change };
      }
      return acc;
    }));

    setTransactions(prev => prev.filter(t => t.id !== id));
    showToast('交易已刪除');
  };

  // --- GitHub Logic ---

  const githubBackup = async () => {
    if (!ghConfig.token || !ghConfig.repo) return showToast('請先設定 GitHub Token 與 Repository', 'error');
    
    const content = JSON.stringify({ accounts, categories, transactions });
    const b64Content = utf8_to_b64(content);
    const url = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`;

    try {
        // 1. Get SHA (if file exists)
        let sha = null;
        try {
            const res = await fetch(url, {
                headers: { Authorization: `token ${ghConfig.token}` }
            });
            if (res.ok) {
                const data = await res.json();
                sha = data.sha;
            }
        } catch (e) {}

        // 2. PUT
        const body = {
            message: `Backup ${new Date().toISOString()}`,
            content: b64Content,
            ...(sha ? { sha } : {})
        };

        const putRes = await fetch(url, {
            method: 'PUT',
            headers: { 
                Authorization: `token ${ghConfig.token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });

        if (putRes.ok) showToast('備份成功！', 'success');
        else {
            const err = await putRes.json();
            showToast(`備份失敗: ${err.message}`, 'error');
        }
    } catch (e) {
        showToast('備份過程發生錯誤', 'error');
    }
  };

  const githubRestore = async () => {
    if (!ghConfig.token || !ghConfig.repo) return showToast('請先設定 GitHub Token 與 Repository', 'error');
    
    const url = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`;
    
    try {
        const res = await fetch(url, {
            headers: { Authorization: `token ${ghConfig.token}` }
        });
        
        if (!res.ok) return showToast('找不到備份檔案', 'error');
        
        const data = await res.json();
        const content = b64_to_utf8(data.content);
        const parsed = JSON.parse(content);

        if (confirm('確定要還原備份嗎？這將覆蓋目前的資料！')) {
            if(parsed.accounts) setAccounts(parsed.accounts);
            if(parsed.categories) setCategories(parsed.categories);
            if(parsed.transactions) setTransactions(parsed.transactions);
            showToast('資料還原成功！', 'success');
        }
    } catch (e) {
        showToast('還原失敗，格式錯誤或網路問題', 'error');
    }
  };

  // --- Components ---

  const SettingsModal = ({ onClose }) => {
      const [localGh, setLocalGh] = useState(ghConfig);

      const save = () => {
          setGhConfig(localGh);
          showToast('設定已儲存', 'success');
      };

      return (
          <div className="space-y-6">
              <div className="space-y-4">
                  <h4 className="font-bold text-gray-800 flex items-center gap-2">
                      <Github size={20}/> GitHub 雲端同步
                  </h4>
                  <div className="space-y-2">
                      <label className="text-xs font-bold text-gray-500">Personal Access Token</label>
                      <input 
                          type="password" 
                          value={localGh.token} 
                          onChange={e => setLocalGh({...localGh, token: e.target.value})}
                          placeholder="ghp_xxxxxxxxxxxx"
                          className="w-full border rounded p-2 text-sm"
                      />
                  </div>
                  <div className="space-y-2">
                      <label className="text-xs font-bold text-gray-500">Repository (帳號/倉庫名)</label>
                      <input 
                          type="text" 
                          value={localGh.repo} 
                          onChange={e => setLocalGh({...localGh, repo: e.target.value})}
                          placeholder="username/repo-name"
                          className="w-full border rounded p-2 text-sm"
                      />
                  </div>
                  <div className="space-y-2">
                      <label className="text-xs font-bold text-gray-500">File Path (檔案名稱)</label>
                      <input 
                          type="text" 
                          value={localGh.path} 
                          onChange={e => setLocalGh({...localGh, path: e.target.value})}
                          placeholder="finance_backup.json"
                          className="w-full border rounded p-2 text-sm"
                      />
                  </div>
                  
                  <button onClick={save} className="w-full py-2 bg-gray-800 text-white rounded-lg font-bold">儲存設定</button>
              </div>

              <div className="border-t pt-4 grid grid-cols-2 gap-3">
                  <button onClick={githubBackup} className="flex items-center justify-center gap-2 py-3 bg-blue-50 text-blue-700 rounded-xl font-bold border border-blue-100 hover:bg-blue-100">
                      <CloudUpload size={18}/> 立即備份
                  </button>
                  <button onClick={githubRestore} className="flex items-center justify-center gap-2 py-3 bg-orange-50 text-orange-700 rounded-xl font-bold border border-orange-100 hover:bg-orange-100">
                      <CloudDownload size={18}/> 立即還原
                  </button>
              </div>
              
              <div className="border-t pt-4">
                  <h4 className="font-bold text-gray-800 mb-2">資料管理</h4>
                  <div className="flex gap-2">
                      <button onClick={() => setCategoryManageOpen(true)} className="flex-1 py-2 border rounded-lg text-sm text-gray-600 hover:bg-gray-50">分類管理</button>
                      <button onClick={() => setAccountManageOpen(true)} className="flex-1 py-2 border rounded-lg text-sm text-gray-600 hover:bg-gray-50">帳戶管理</button>
                  </div>
              </div>
          </div>
      );
  };

  const SmartImport = ({ onClose, onImport }) => {
    const [text, setText] = useState('');
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [previews, setPreviews] = useState([]); 
    const [step, setStep] = useState('input');
    const [expandedItems, setExpandedItems] = useState({});

    const toggleExpand = (id) => {
        setExpandedItems(prev => ({...prev, [id]: !prev[id]}));
    };

    const analyzeText = () => {
      if (!text.trim()) return;
      setIsAnalyzing(true);
      
      setTimeout(() => {
        // --- 預處理 ---
        let processedText = text;
        processedText = processedText.replace(/−/g, '-');
        processedText = processedText.replace(/([^\n])(?=20\d{2}\/\d{2}\/\d{2})/g, "$1\n");
        processedText = processedText.replace(/([\u4e00-\u9fa5a-zA-Z])(?=\d)/g, "$1 ");
        processedText = processedText.replace(/(\d)(?=-)/g, "$1 ");
        processedText = processedText.replace(/(-)(?=\d)/g, "$1 ");

        const lines = processedText.split(/\n+/);
        const detected = [];
        
        // 關鍵字對映表
        const keywords = {
             '飲食': ['早餐', '午餐', '晚餐', '飲料', '星巴克', '麥當勞', '食', '飯', '茶', '咖啡', 'Eats', 'Foodpanda', '全家', '7-11', '零食'],
             '交通': ['Uber', '計程車', '高鐵', '台鐵', '捷運', '加油', '停車', 'yoxi', 'Line Taxi', '悠遊卡'],
             '娛樂': ['電影', 'Netflix', 'Spotify', 'Steam', '好樂迪', 'KTV', '住宿', '機票', '旅遊'],
             '生活': ['屈臣氏', '康是美', '藥局', '剪髮', '洗髮', '衣服', 'UNIQLO', 'GU', '鞋'],
             '購物': ['全聯', '家樂福', '蝦皮', 'MOMO', 'PChome', '百貨', '超市', '零用金'],
             '居家': ['電費', '水費', '瓦斯', '房租', '中華電信', '網路', '管理費', '轉帳', '賠償', 'IKEA'],
             '學習': ['書局', '誠品', '課程', '補習', '學費'],
             '收入': ['薪資', '入帳', '利息', '股息']
        };

        const guessCat = (desc, type) => {
             let guessedCat = categories[0];
             let guessedSub = categories[0].subs[0];
             
             if (type === 'income') {
                  const incCat = categories.find(c => c.type === 'income');
                  if(incCat) { guessedCat = incCat; guessedSub = incCat.subs[0]; }
             }

             for (const [catName, keys] of Object.entries(keywords)) {
                 if (keys.some(k => desc.toLowerCase().includes(k.toLowerCase()))) {
                    const foundCat = categories.find(c => c.name === catName);
                    if (foundCat && foundCat.type === type) {
                       guessedCat = foundCat;
                       guessedSub = foundCat.subs[0];
                       break; 
                    }
                 }
             }
             return { categoryId: guessedCat.id, subCategoryId: guessedSub.id };
        };

        lines.forEach((line, idx) => {
          let trimmed = line.trim();
          if (!trimmed || trimmed.includes("交易日期") || trimmed.length < 2) return;
          trimmed = trimmed.replace(/^[^\d]*(?=20\d{2}\/\d{2}\/\d{2})/, '');

          let date = new Date().toISOString().split('T')[0];
          const dateMatch = trimmed.match(/^(20\d{2}\/\d{2}\/\d{2})/);
          
          if (!dateMatch) {
             if (detected.length > 0) {
                 const lastTx = detected[detected.length - 1];
                 if (!trimmed.match(/^[-_=]*$/)) {
                     lastTx.note = (lastTx.note ? lastTx.note + ' ' : '') + trimmed;
                     const newCat = guessCat(lastTx.payee + lastTx.note, lastTx.type);
                     lastTx.categoryId = newCat.categoryId;
                     lastTx.subCategoryId = newCat.subCategoryId;
                 }
             }
             return;
          }
          
          if (dateMatch) {
             date = dateMatch[1].replace(/\//g, '-');
             trimmed = trimmed.replace(/^20\d{2}\/\d{2}\/\d{2}(\s+\d{2}:\d{2})?(\s*20\d{2}\/\d{2}\/\d{2})?/, '').trim();
          }

          let amount = 0;
          let type = 'expense';
          let description = trimmed;
          let extraInfo = '';

          const bankRegex = /^(.*?)\s+([\d,]+|-)\s+([\d,]+|-)\s+([\d,]+|-)(.*)$/;
          const match = trimmed.match(bankRegex);

          if (match) {
             description = match[1].trim();
             const withdrawal = match[2].trim().replace(/,/g, '');
             const deposit = match[3].trim().replace(/,/g, '');
             extraInfo = match[5].trim();

             if (withdrawal && withdrawal !== '-' && !isNaN(Number(withdrawal)) && Number(withdrawal) > 0) {
                amount = withdrawal;
                type = 'expense';
             } else if (deposit && deposit !== '-' && !isNaN(Number(deposit)) && Number(deposit) > 0) {
                amount = deposit;
                type = 'income';
             }
          } else {
             const numbers = trimmed.match(/[\d,]+/g);
             if (numbers) {
                 const validNums = numbers.map(n => n.replace(/,/g, '')).filter(n => !isNaN(Number(n)));
                 if (validNums.length > 0) {
                     amount = validNums[validNums.length - 1]; 
                     description = description.replace(amount, '').trim(); 
                     type = 'expense'; 
                 }
             }
          }

          const fullDesc = description + extraInfo;
          const { categoryId, subCategoryId } = guessCat(fullDesc, type);

          if (amount > 0) {
              detected.push({
                tempId: Date.now() + idx,
                date,
                amount,
                payee: description || '未知交易',
                categoryId,
                subCategoryId,
                accountId: accounts[0].id,
                type,
                note: extraInfo || '', 
                isSplit: false,
                splitDetail: ''
              });
          }
        });

        // 預設全部展開
        const allExpanded = detected.reduce((acc, item) => ({ ...acc, [item.tempId]: true }), {});
        setExpandedItems(allExpanded);
        setPreviews(detected);
        setIsAnalyzing(false);
        setStep('review');
      }, 800);
    };

    const updatePreview = (id, field, value) => {
        setPreviews(prev => prev.map(p => {
            if (p.tempId === id) {
                const newData = { ...p, [field]: value };
                if (field === 'categoryId') {
                    const newCat = categories.find(c => c.id === value);
                    if (newCat) newData.subCategoryId = newCat.subs[0].id;
                }
                return newData;
            }
            return p;
        }));
    };

    const removePreview = (id) => {
        setPreviews(prev => prev.filter(p => p.tempId !== id));
    };

    const confirmImport = () => {
        if (previews.length === 0) return;
        onImport(previews);
        onClose();
    };

    if (step === 'review') {
        return (
            <div className="space-y-4 h-full flex flex-col">
                <div className="flex justify-between items-center bg-blue-50 p-3 rounded-lg text-sm text-blue-800">
                    <span className="font-bold flex items-center gap-2"><Check size={16}/> 已識別 {previews.length} 筆資料</span>
                    <button onClick={() => setStep('input')} className="text-blue-600 hover:underline">重新輸入</button>
                </div>
                
                <div className="flex-1 overflow-y-auto space-y-3 pr-1">
                    {previews.map((item) => (
                        <div key={item.tempId} className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm transition-all">
                             {/* 簡易摘要列 */}
                             <div className="p-3 flex gap-2 items-center bg-gray-50 border-b border-gray-100">
                                <button onClick={() => toggleExpand(item.tempId)} className="text-gray-400 hover:text-blue-600">
                                    {expandedItems[item.tempId] ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}
                                </button>
                                <div className="flex-1 flex gap-2 items-center overflow-hidden">
                                    <span className="text-xs font-mono text-gray-500 bg-white px-1 rounded">{item.date}</span>
                                    <span className="font-bold text-gray-700 truncate text-sm">{item.payee}</span>
                                    {item.note && <span className="text-xs text-gray-400 truncate hidden sm:block">- {item.note}</span>}
                                </div>
                                <span className={`font-bold text-sm ${item.type === 'income' ? 'text-green-600' : 'text-gray-800'}`}>
                                    {item.type === 'income' ? '+' : '-'}{item.amount}
                                </span>
                                <button onClick={() => removePreview(item.tempId)} className="text-red-300 hover:text-red-500 p-1"><X size={16}/></button>
                             </div>

                             {/* 詳細編輯區塊 (展開時顯示) */}
                             {expandedItems[item.tempId] && (
                                <div className="p-3 text-sm space-y-3 animate-in slide-in-from-top-1">
                                    <div className="grid grid-cols-2 gap-2">
                                        <input 
                                            type="text" 
                                            value={item.payee} 
                                            onChange={e => updatePreview(item.tempId, 'payee', e.target.value)}
                                            className="border rounded p-1.5 bg-white font-medium text-gray-800"
                                            placeholder="摘要"
                                        />
                                        <input 
                                            type="number" 
                                            value={item.amount} 
                                            onChange={e => updatePreview(item.tempId, 'amount', e.target.value)}
                                            className="border rounded p-1.5 bg-white font-bold text-gray-800"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">主分類</label>
                                            <select 
                                                value={item.categoryId} 
                                                onChange={e => updatePreview(item.tempId, 'categoryId', e.target.value)}
                                                className="w-full border rounded p-1.5 bg-white"
                                            >
                                                {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">子分類</label>
                                            <select 
                                                value={item.subCategoryId} 
                                                onChange={e => updatePreview(item.tempId, 'subCategoryId', e.target.value)}
                                                className="w-full border rounded p-1.5 bg-white"
                                            >
                                                {categories.find(c => c.id === item.categoryId)?.subs.map(s => (
                                                    <option key={s.id} value={s.id}>{s.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">扣款帳戶</label>
                                            <select 
                                                value={item.accountId} 
                                                onChange={e => updatePreview(item.tempId, 'accountId', e.target.value)}
                                                className="w-full border rounded p-1.5 bg-white"
                                            >
                                                {accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-500 block mb-1">備註說明</label>
                                            <input 
                                                type="text" 
                                                value={item.note} 
                                                onChange={e => updatePreview(item.tempId, 'note', e.target.value)}
                                                className="w-full border rounded p-1.5 bg-white"
                                                placeholder="詳細備註..."
                                            />
                                        </div>
                                    </div>

                                    <div className="border border-blue-100 bg-blue-50/50 rounded-lg p-2">
                                        <div className="flex items-center gap-2 mb-2">
                                            <input 
                                                type="checkbox" 
                                                id={`split-${item.tempId}`}
                                                checked={item.isSplit}
                                                onChange={e => updatePreview(item.tempId, 'isSplit', e.target.checked)}
                                                className="rounded text-blue-600"
                                            />
                                            <label htmlFor={`split-${item.tempId}`} className="font-bold text-blue-700 flex items-center gap-1">
                                                <Users size={14}/> 啟用分帳 (代付/拆帳)
                                            </label>
                                        </div>
                                        {item.isSplit && (
                                            <textarea 
                                                value={item.splitDetail}
                                                onChange={e => updatePreview(item.tempId, 'splitDetail', e.target.value)}
                                                placeholder="輸入拆帳對象與金額 (例如: Andy 200, Jason 150)"
                                                className="w-full text-xs p-2 border rounded bg-white h-16 resize-none"
                                            />
                                        )}
                                    </div>
                                </div>
                             )}
                        </div>
                    ))}
                    {previews.length === 0 && <div className="text-center text-gray-400 py-10">所有項目已被移除</div>}
                </div>

                <div className="pt-2 border-t border-gray-100 flex gap-3">
                    <button onClick={() => setStep('input')} className="flex-1 py-3 border border-gray-300 rounded-xl text-gray-600 font-medium">取消</button>
                    <button onClick={confirmImport} disabled={previews.length === 0} className="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-md disabled:bg-gray-300">
                        確認匯入
                    </button>
                </div>
            </div>
        );
    }

    return (
      <div className="space-y-4">
        <div className="flex gap-2">
          <button className="flex-1 py-3 bg-gray-50 border border-gray-200 rounded-xl flex flex-col items-center gap-1 text-gray-600 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600 transition-colors" onClick={() => setText(prev => prev + "2025/12/04 14:272025/12/04網銀轉帳565−155,115(013)0000012561990059\n")}>
            <ClipboardList size={20} /> <span className="text-xs">範例(網銀)</span>
          </button>
          <button className="flex-1 py-3 bg-gray-50 border border-gray-200 rounded-xl flex flex-col items-center gap-1 text-gray-600 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600 transition-colors" onClick={() => setText(prev => prev + "Uber Eats 350\n")}>
             <FileText size={20} /> <span className="text-xs">範例(文字)</span>
          </button>
        </div>
        <div className="relative">
             <textarea
              value={text}
              onChange={e => setText(e.target.value)}
              placeholder="請貼上交易明細..."
              className="w-full h-48 p-4 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-blue-500 resize-none font-mono text-sm leading-relaxed"
            />
            {text && (
                <button onClick={() => setText('')} className="absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500 bg-white rounded-full shadow-sm"><X size={14}/></button>
            )}
        </div>
        <button 
          onClick={analyzeText}
          disabled={!text || isAnalyzing}
          className="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-200"
        >
          {isAnalyzing ? <span className="animate-pulse">AI 正在分析...</span> : <><Sparkles size={18} /> 開始智慧分析</>}
        </button>
      </div>
    );
  };

  // --- Category Manager ---
  
  const CategoryManager = ({ onClose }) => {
    const [localCats, setLocalCats] = useState(categories);
    const [expandedCatId, setExpandedCatId] = useState(null);
    const [newCatName, setNewCatName] = useState('');
    const [newCatType, setNewCatType] = useState('expense');
    const [newSubName, setNewSubName] = useState('');

    const save = () => {
        setCategories(localCats);
        onClose();
        showToast('分類已更新', 'success');
    };

    const addCategory = () => {
        if (!newCatName) return;
        const newCat = {
            id: generateId(),
            name: newCatName,
            type: newCatType,
            color: newCatType === 'expense' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600',
            subs: [{ id: generateId(), name: '一般' }]
        };
        setLocalCats([...localCats, newCat]);
        setNewCatName('');
    };

    const removeCategory = (id) => {
        if (!confirm('刪除大類會連同所有子分類一起刪除，確定嗎？')) return;
        setLocalCats(localCats.filter(c => c.id !== id));
        if (expandedCatId === id) setExpandedCatId(null);
    };

    const addSubCategory = (catId) => {
        if (!newSubName) return;
        setLocalCats(localCats.map(c => {
            if (c.id === catId) {
                return { ...c, subs: [...c.subs, { id: generateId(), name: newSubName }] };
            }
            return c;
        }));
        setNewSubName('');
    };

    const removeSubCategory = (catId, subId) => {
        setLocalCats(localCats.map(c => {
            if (c.id === catId) {
                return { ...c, subs: c.subs.filter(s => s.id !== subId) };
            }
            return c;
        }));
    };

    return (
      <div className="space-y-4 h-full flex flex-col">
        {/* 新增大類區塊 */}
        <div className="bg-gray-50 p-3 rounded-xl border border-gray-200">
            <h4 className="font-bold text-gray-700 text-sm mb-2 flex items-center gap-2"><FolderOpen size={16}/> 新增大類</h4>
            <div className="flex gap-2">
                <select 
                    value={newCatType} 
                    onChange={e => setNewCatType(e.target.value)}
                    className="border rounded p-2 bg-white text-sm"
                >
                    <option value="expense">支出</option>
                    <option value="income">收入</option>
                </select>
                <input 
                    value={newCatName} 
                    onChange={e => setNewCatName(e.target.value)} 
                    placeholder="大類名稱" 
                    className="border rounded p-2 flex-1 text-sm"
                />
                <button onClick={addCategory} className="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
                    <Plus size={18}/>
                </button>
            </div>
        </div>

        {/* 分類列表 */}
        <div className="flex-1 overflow-y-auto space-y-2">
            {localCats.map(cat => (
                <div key={cat.id} className="border border-gray-100 rounded-xl overflow-hidden">
                    <div 
                        className={`flex justify-between items-center p-3 cursor-pointer ${cat.type === 'income' ? 'bg-green-50' : 'bg-white hover:bg-gray-50'}`}
                        onClick={() => setExpandedCatId(expandedCatId === cat.id ? null : cat.id)}
                    >
                        <div className="flex items-center gap-2">
                            {expandedCatId === cat.id ? <ChevronDown size={16} className="text-gray-400"/> : <ChevronRight size={16} className="text-gray-400"/>}
                            <span className={`font-bold ${cat.type === 'income' ? 'text-green-700' : 'text-gray-800'}`}>{cat.name}</span>
                            <span className="text-xs text-gray-400">({cat.subs.length} 子分類)</span>
                        </div>
                        <button 
                            onClick={(e) => { e.stopPropagation(); removeCategory(cat.id); }}
                            className="text-gray-300 hover:text-red-500 p-1"
                        >
                            <Trash2 size={16}/>
                        </button>
                    </div>

                    {/* 子分類區塊 */}
                    {expandedCatId === cat.id && (
                        <div className="bg-gray-50 p-3 border-t border-gray-100 animate-in slide-in-from-top-2">
                            <div className="flex flex-wrap gap-2 mb-3">
                                {cat.subs.map(sub => (
                                    <div key={sub.id} className="bg-white border border-gray-200 px-3 py-1 rounded-full text-sm flex items-center gap-2 group">
                                        {sub.name}
                                        <button onClick={() => removeSubCategory(cat.id, sub.id)} className="text-gray-300 hover:text-red-500 hidden group-hover:block">
                                            <X size={12}/>
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-2 items-center mt-2">
                                <input 
                                    value={newSubName} 
                                    onChange={e => setNewSubName(e.target.value)} 
                                    placeholder={`新增 ${cat.name} 的子分類`} 
                                    className="border rounded p-1.5 flex-1 text-sm"
                                    onKeyDown={e => e.key === 'Enter' && addSubCategory(cat.id)}
                                />
                                <button onClick={() => addSubCategory(cat.id)} className="text-blue-600 p-1.5 hover:bg-blue-100 rounded">
                                    <Plus size={18}/>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            ))}
        </div>

        <button onClick={save} className="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl font-bold">
            儲存變更
        </button>
      </div>
    );
  };

  // --- Account Manager ---
  
  const AccountManager = ({ onClose }) => {
    const [localAccounts, setLocalAccounts] = useState(accounts);
    const [newAcc, setNewAcc] = useState({ name: '', type: 'cash', balance: 0 });

    const addAccount = () => {
      if(!newAcc.name) return;
      setLocalAccounts([...localAccounts, { ...newAcc, id: generateId(), icon: 'Wallet' }]);
      setNewAcc({ name: '', type: 'cash', balance: 0 });
    };

    const removeAccount = (id) => {
      setLocalAccounts(prev => prev.filter(a => a.id !== id));
    };

    const saveAll = () => {
      setAccounts(localAccounts);
      onClose();
      showToast('帳戶已更新', 'success');
    };

    return (
      <div className="space-y-4">
        <div className="space-y-2 max-h-[400px] overflow-y-auto">
          {localAccounts.map(acc => (
            <div key={acc.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
              <div className="flex items-center gap-2">
                 <span className="text-xs bg-white border border-gray-200 px-1 rounded text-gray-500">{acc.type}</span>
                 <span className="font-medium">{acc.name}</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="font-mono">{acc.balance}</span>
                <button onClick={() => removeAccount(acc.id)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button>
              </div>
            </div>
          ))}
        </div>
        
        <div className="border-t border-gray-100 pt-4 grid grid-cols-12 gap-2 items-end">
          <div className="col-span-5">
             <label className="text-xs text-gray-500">帳戶名稱</label>
             <input value={newAcc.name} onChange={e => setNewAcc({...newAcc, name: e.target.value})} className="w-full p-2 border rounded-md" placeholder="例如: 中信卡" />
          </div>
          <div className="col-span-3">
             <label className="text-xs text-gray-500">類型</label>
             <select value={newAcc.type} onChange={e => setNewAcc({...newAcc, type: e.target.value})} className="w-full p-2 border rounded-md">
               <option value="cash">現金</option>
               <option value="bank">銀行</option>
               <option value="credit">信用卡</option>
             </select>
          </div>
          <div className="col-span-3">
             <label className="text-xs text-gray-500">初始餘額</label>
             <input type="number" value={newAcc.balance} onChange={e => setNewAcc({...newAcc, balance: Number(e.target.value)})} className="w-full p-2 border rounded-md" />
          </div>
          <div className="col-span-1">
             <button onClick={addAccount} className="w-full p-2 bg-blue-600 text-white rounded-md flex justify-center"><Plus size={20}/></button>
          </div>
        </div>
        <button onClick={saveAll} className="w-full py-2 bg-gray-800 text-white rounded-lg">儲存變更</button>
      </div>
    );
  };

  // --- Views ---

  const DashboardView = () => {
    const totalAssets = accounts.reduce((sum, acc) => sum + acc.balance, 0);
    const recentTx = transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

    return (
      <div className="space-y-6 animate-in fade-in">
        <div className="bg-gradient-to-r from-gray-900 to-gray-800 text-white p-6 rounded-2xl shadow-xl">
          <div className="text-gray-400 text-sm font-medium mb-1">總資產淨值</div>
          <div className="text-4xl font-bold tracking-tight">
            {new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(totalAssets)}
          </div>
          <div className="flex gap-3 mt-6">
            <button 
              onClick={() => { setEditingTx(null); setIsTxModalOpen(true); }}
              className="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors"
            >
              <Plus size={18} /> 一般記帳
            </button>
            <button 
              onClick={() => setIsSmartModalOpen(true)}
              className="flex-1 bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white py-2 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors border border-white/10"
            >
              <Sparkles size={18} className="text-yellow-400"/> 智慧匯入
            </button>
          </div>
        </div>

        <div>
          <div className="flex justify-between items-center mb-3">
            <h3 className="font-bold text-gray-800">我的帳戶</h3>
            <button onClick={() => setAccountManageOpen(true)} className="text-sm text-blue-600 font-medium">管理</button>
          </div>
          <div className="flex gap-4 overflow-x-auto pb-2 scrollbar-hide">
            {accounts.map(acc => (
              <div key={acc.id} className="min-w-[160px] bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex flex-col justify-between h-28">
                <div className="flex items-start justify-between">
                  <div className={`p-2 rounded-lg ${acc.type === 'credit' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`}>
                    <IconComponent name={acc.icon} size={20} />
                  </div>
                  <span className="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-full">{acc.type === 'credit' ? '負債' : '資產'}</span>
                </div>
                <div>
                  <div className="text-sm font-medium text-gray-600 truncate">{acc.name}</div>
                  <div className={`text-lg font-bold ${acc.balance < 0 ? 'text-red-500' : 'text-gray-900'}`}>
                    {acc.balance.toLocaleString()}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div>
           <div className="flex justify-between items-center mb-3">
            <h3 className="font-bold text-gray-800">最近交易</h3>
            <button onClick={() => setActiveTab('history')} className="text-sm text-gray-500">查看全部</button>
          </div>
          <div className="space-y-3">
            {recentTx.length === 0 ? <div className="text-center text-gray-400 py-8">暫無資料</div> : recentTx.map(tx => (
              <TransactionCard key={tx.id} tx={tx} onDelete={deleteTransaction} onEdit={(t) => { setEditingTx(t); setIsTxModalOpen(true); }} />
            ))}
          </div>
        </div>
      </div>
    );
  };

  const TransactionCard = ({ tx, onDelete, onEdit }) => {
    const cat = categories.find(c => c.id === tx.categoryId);
    const sub = cat?.subs.find(s => s.id === tx.subCategoryId);
    const acc = accounts.find(a => a.id === tx.accountId);

    return (
      <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between group">
        <div className="flex items-center gap-3 overflow-hidden">
          <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${cat?.color || 'bg-gray-100 text-gray-500'}`}>
            {tx.type === 'expense' ? <Minus size={16} /> : <Plus size={16} />}
          </div>
          <div className="min-w-0">
            <div className="font-bold text-gray-800 truncate flex items-center gap-2">
              {cat?.name} {sub && <span className="text-xs font-normal text-gray-500">/ {sub.name}</span>}
            </div>
            <div className="text-xs text-gray-500 truncate flex items-center gap-1">
              {new Date(tx.date).toLocaleDateString()} • {acc?.name}
              {tx.payee && <span className="bg-gray-100 px-1.5 rounded text-gray-600">{tx.payee}</span>}
              {tx.isSplit && <span className="bg-orange-100 text-orange-700 px-1.5 rounded">含分帳</span>}
            </div>
            {tx.note && <div className="text-xs text-gray-400 truncate mt-0.5">{tx.note}</div>}
          </div>
        </div>
        <div className="flex flex-col items-end gap-1">
          <div className={`font-bold ${tx.type === 'income' ? 'text-green-600' : 'text-gray-900'}`}>
            {tx.type === 'income' ? '+' : '-'}{Number(tx.amount).toLocaleString()}
          </div>
          <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onClick={() => onEdit(tx)} className="text-blue-500 p-1"><Edit2 size={14}/></button>
            <button onClick={() => onDelete(tx.id)} className="text-red-500 p-1"><Trash2 size={14}/></button>
          </div>
        </div>
      </div>
    );
  };

  const TransactionForm = ({ initialData, onClose, onSave }) => {
    const [formData, setFormData] = useState(initialData || {
      type: 'expense',
      amount: '',
      date: new Date().toISOString().split('T')[0],
      categoryId: categories[0]?.id,
      subCategoryId: categories[0]?.subs[0]?.id,
      accountId: accounts[0]?.id,
      payee: '',
      note: '',
      isSplit: false,
      splitDetail: '' 
    });

    const activeCat = categories.find(c => c.id === formData.categoryId);

    return (
      <div className="space-y-4">
        <div className="flex bg-gray-100 p-1 rounded-lg">
          {['expense', 'income'].map(type => (
            <button
              key={type}
              onClick={() => setFormData({ ...formData, type })}
              className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${
                formData.type === type 
                  ? (type === 'expense' ? 'bg-white text-red-600 shadow-sm' : 'bg-white text-green-600 shadow-sm') 
                  : 'text-gray-500'
              }`}
            >
              {type === 'expense' ? '支出' : '收入'}
            </button>
          ))}
        </div>

        <div>
          <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1 block">金額</label>
          <div className="relative">
            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-lg">$</span>
            <input 
              type="number" 
              value={formData.amount}
              onChange={e => setFormData({...formData, amount: e.target.value})}
              className="w-full pl-8 pr-4 py-3 bg-gray-50 border-none rounded-xl text-2xl font-bold text-gray-900 focus:ring-2 focus:ring-blue-500"
              placeholder="0"
              autoFocus
            />
          </div>
        </div>

        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="text-xs font-bold text-gray-500 mb-1 block">主分類</label>
            <select 
              value={formData.categoryId}
              onChange={e => {
                const cat = categories.find(c => c.id === e.target.value);
                setFormData({
                  ...formData, 
                  categoryId: e.target.value,
                  subCategoryId: cat?.subs[0]?.id || ''
                });
              }}
              className="w-full p-2.5 bg-white border border-gray-200 rounded-lg"
            >
              {categories.filter(c => c.type === formData.type).map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="text-xs font-bold text-gray-500 mb-1 block">子分類</label>
            <select 
              value={formData.subCategoryId}
              onChange={e => setFormData({...formData, subCategoryId: e.target.value})}
              className="w-full p-2.5 bg-white border border-gray-200 rounded-lg"
            >
              {activeCat?.subs?.map(s => (
                <option key={s.id} value={s.id}>{s.name}</option>
              ))}
            </select>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="text-xs font-bold text-gray-500 mb-1 block">支付帳戶</label>
            <select 
              value={formData.accountId}
              onChange={e => setFormData({...formData, accountId: e.target.value})}
              className="w-full p-2.5 bg-white border border-gray-200 rounded-lg"
            >
              {accounts.map(a => (
                <option key={a.id} value={a.id}>{a.name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="text-xs font-bold text-gray-500 mb-1 block">對象/商家 (選填)</label>
            <input 
              type="text" 
              value={formData.payee}
              onChange={e => setFormData({...formData, payee: e.target.value})}
              placeholder="如: 7-11, 王小明"
              className="w-full p-2.5 bg-white border border-gray-200 rounded-lg"
            />
          </div>
        </div>

        <div className="border border-gray-100 rounded-lg p-3">
          <div className="flex items-center justify-between">
            <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
              <input 
                type="checkbox" 
                checked={formData.isSplit}
                onChange={e => setFormData({...formData, isSplit: e.target.checked})}
                className="w-4 h-4 text-blue-600 rounded"
              />
              啟用分帳 (代付)
            </label>
          </div>
          {formData.isSplit && (
            <textarea
              value={formData.splitDetail}
              onChange={e => setFormData({...formData, splitDetail: e.target.value})}
              placeholder="請輸入分帳明細，例如：Andy 200, Judy 300"
              className="w-full mt-2 p-2 text-sm bg-gray-50 rounded-lg border-none resize-none h-20"
            />
          )}
        </div>

        <div>
           <label className="text-xs font-bold text-gray-500 mb-1 block">備註</label>
           <textarea 
             value={formData.note}
             onChange={e => setFormData({...formData, note: e.target.value})}
             className="w-full p-2.5 bg-white border border-gray-200 rounded-lg h-20 resize-none"
             placeholder="寫點什麼..."
           />
        </div>

        <button 
          onClick={() => onSave(formData)}
          className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-all"
        >
          儲存交易
        </button>
      </div>
    );
  };

  return (
    <div className="max-w-md mx-auto min-h-screen bg-gray-50 pb-20 font-sans text-gray-900 relative">
      <div className="bg-white px-4 py-3 border-b border-gray-200 sticky top-0 z-20 flex items-center justify-between">
         <div className="flex items-center gap-2 text-blue-700 font-bold text-lg">
           <Wallet className="fill-blue-600 text-blue-600" /> FinancePro
         </div>
         <div className="flex gap-2">
            <button onClick={() => setCategoryManageOpen(true)} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full"><Tag size={20}/></button>
            <button onClick={() => setSettingsOpen(true)} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full"><Settings size={20}/></button>
         </div>
      </div>

      <div className="p-4">
        {activeTab === 'dashboard' && <DashboardView />}
        {activeTab === 'history' && (
          <div className="space-y-4">
             <div className="flex items-center gap-2 mb-2">
               <button onClick={() => setActiveTab('dashboard')} className="text-gray-500"><ChevronDown className="rotate-90"/></button>
               <h2 className="font-bold text-xl">全部交易記錄</h2>
             </div>
             {transactions.length === 0 ? <div className="text-center text-gray-400 mt-10">空空如也</div> : 
               transactions.map(tx => (
                 <TransactionCard key={tx.id} tx={tx} onDelete={deleteTransaction} onEdit={(t) => { setEditingTx(t); setIsTxModalOpen(true); }} />
               ))
             }
          </div>
        )}
      </div>

      <div className="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 p-2 flex justify-around z-20">
        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center p-2 rounded-lg ${activeTab === 'dashboard' ? 'text-blue-600' : 'text-gray-400'}`}>
          <LayoutGrid size={24} />
          <span className="text-[10px] font-bold mt-1">概覽</span>
        </button>
        <div className="relative -top-6">
           <button 
             onClick={() => { setEditingTx(null); setIsTxModalOpen(true); }}
             className="w-14 h-14 bg-blue-600 rounded-full text-white shadow-lg shadow-blue-300 flex items-center justify-center hover:scale-105 transition-transform"
           >
             <Plus size={32} />
           </button>
        </div>
        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center p-2 rounded-lg ${activeTab === 'history' ? 'text-blue-600' : 'text-gray-400'}`}>
          <FileText size={24} />
          <span className="text-[10px] font-bold mt-1">明細</span>
        </button>
      </div>

      <Modal isOpen={isTxModalOpen} onClose={() => setIsTxModalOpen(false)} title={editingTx ? "編輯交易" : "新增交易"}>
        <TransactionForm initialData={editingTx} onClose={() => setIsTxModalOpen(false)} onSave={handleSaveTransaction} />
      </Modal>

      <Modal isOpen={isSmartModalOpen} onClose={() => setIsSmartModalOpen(false)} title="智慧匯入 (批次解析)" maxWidth="max-w-xl">
        <SmartImport onClose={() => setIsSmartModalOpen(false)} onImport={handleBulkImport} />
      </Modal>
      
      <Modal isOpen={accountManageOpen} onClose={() => setAccountManageOpen(false)} title="帳戶管理">
        <AccountManager onClose={() => setAccountManageOpen(false)} />
      </Modal>

      <Modal isOpen={categoryManageOpen} onClose={() => setCategoryManageOpen(false)} title="分類管理">
         <CategoryManager onClose={() => setCategoryManageOpen(false)} />
      </Modal>

      <Modal isOpen={settingsOpen} onClose={() => setSettingsOpen(false)} title="設定">
         <SettingsModal onClose={() => setSettingsOpen(false)} />
      </Modal>

      {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
    </div>
  );
}
