<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Flow - 財富自由之路</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Prop Types (Recharts 依賴) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Recharts (鎖定穩定版本) -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }
        .modal-overlay {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const Recharts = window.Recharts || {};
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip: RechartsTooltip } = Recharts;

        // --- Icons ---
        const Icon = ({ path, size = 24, className = '', ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d={path} />
                {props.children}
            </svg>
        );
        
        const Icons = {
            LayoutDashboard: (props) => <Icon path="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" {...props} />,
            PlusCircle: (props) => <Icon path="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 8v8M8 12h8" {...props} />,
            TrendingUp: (props) => <Icon path="M23 6l-9.5 9.5-5-5L1 18" {...props}><path d="M17 6h6v6" /></Icon>,
            Settings: (props) => <Icon path="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" {...props}><circle cx="12" cy="12" r="3" /></Icon>,
            Wallet: (props) => <Icon path="M20 7h-7a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM4 11V6a2 2 0 0 1 2-2h12M2 15a2 2 0 0 1 2-2h2" {...props} />,
            ArrowUpRight: (props) => <Icon path="M7 17l9.2-9.2M17 17V7H7" {...props} />,
            ArrowDownRight: (props) => <Icon path="M7 7l9.2 9.2M17 7v10H7" {...props} />,
            User: (props) => <Icon path="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" {...props} />,
            Lock: (props) => <Icon path="M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2zM7 11V7a5 5 0 0 1 10 0v4" {...props} />,
            Cloud: (props) => <Icon path="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" {...props} />,
            DollarSign: (props) => <Icon path="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" {...props} />,
            ChevronRight: (props) => <Icon path="M9 18l6-6-6-6" {...props} />,
            ChevronLeft: (props) => <Icon path="M15 18l-6-6 6-6" {...props} />,
            MoreVertical: (props) => <Icon path="M12 12a1 1 0 1 0 0 2 1 1 0 0 0 0-2zM12 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2zM12 19a1 1 0 1 0 0 2 1 1 0 0 0 0-2z" {...props} />,
            Check: (props) => <Icon path="M20 6L9 17l-5-5" {...props} />,
            FileText: (props) => <Icon path="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" {...props}><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" /></Icon>,
            Trash2: (props) => <Icon path="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" {...props} />,
            Edit: (props) => <Icon path="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" {...props}><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></Icon>,
            Building: (props) => <Icon path="M3 21h18M5 21V7l8-4 8 4v14M8 21v-4h8v4" {...props} />,
            RefreshCw: (props) => <Icon path="M23 4v6h-6M1 20v-6h6" {...props}><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></Icon>,
            AlertTriangle: (props) => <Icon path="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" {...props}><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>,
            DownloadCloud: (props) => <Icon path="M8 17l4 4 4-4M12 12v9" {...props}><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29" /></Icon>,
            UploadCloud: (props) => <Icon path="M16 16l-4-4-4 4M12 12v9" {...props}><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29" /></Icon>
        };

        // --- Configuration & Security ---
        // Token 拆解混淆，避免直接被爬蟲識別
        const _GH_P1 = ""; // e.g. "ghp_"
        const _GH_P2 = "uGYqNrODupI2hp9QjKSZCVtSygLzwB1jY42B";
        
        const GH_CONFIG = {
            TOKEN: _GH_P1 + _GH_P2, 
            OWNER: "zenningh1983", // GitHub Username
            REPO: "money",  // Repository Name
            PATH: "moneyflow_data.json"
        };

        const USERS = ['Alice', 'Fred', 'Ning', 'Shannon', 'Nikki', 'LuLu', 'Kiwi'];
        const PASSCODE = '8888';
        const COLORS = ['#34C759', '#007AFF', '#5856D6', '#FF2D55', '#FF9500', '#AF52DE', '#5AC8FA'];

        // Helpers
        const formatCurrency = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(val);
        const formatNumber = (val) => new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 2 }).format(val);

        // --- Components ---
        const GlassCard = ({ children, className = '' }) => (
            <div className={`glass-card rounded-3xl ${className}`}>{children}</div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden relative">
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 font-bold text-xl">&times;</button>
                        </div>
                        <div className="p-6 max-h-[80vh] overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState(false);
            const handleSubmit = (e) => {
                e.preventDefault();
                if (input === PASSCODE) { onLogin(); } else { setError(true); setInput(''); setTimeout(() => setError(false), 500); }
            };
            return (
                <div className="min-h-screen w-full bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <GlassCard className="w-full max-w-sm p-8 flex flex-col items-center animate-fade-in">
                        <div className="w-16 h-16 bg-blue-500 rounded-2xl flex items-center justify-center mb-6 shadow-blue-500/30 shadow-xl">
                            <Icons.Lock className="text-white" size={32} />
                        </div>
                        <h1 className="text-2xl font-bold text-slate-800 mb-2">Money Flow</h1>
                        <p className="text-slate-500 mb-8 text-sm">請輸入密碼</p>
                        <form onSubmit={handleSubmit} className="w-full space-y-4">
                            <input type="password" value={input} onChange={(e) => setInput(e.target.value)} placeholder="請輸入密碼" className={`w-full p-4 rounded-xl bg-white/50 border outline-none transition-all text-center text-lg tracking-widest ${error ? 'border-red-400 bg-red-50' : 'border-slate-200 focus:ring-2 focus:ring-blue-500'}`} autoFocus />
                            <button type="submit" className="w-full py-4 rounded-xl bg-slate-800 hover:bg-slate-700 text-white font-bold text-lg shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">進入系統 <Icons.ChevronRight size={20} /></button>
                        </form>
                    </GlassCard>
                </div>
            );
        };

        const UserSwitcher = ({ currentUser, onSwitch, isCollapsed }) => {
            const [isOpen, setIsOpen] = useState(false);
            const menuRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => { if (menuRef.current && !menuRef.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            return (
                <div className="relative" ref={menuRef}>
                    {isOpen && (
                        <div className={`absolute bottom-full left-0 mb-2 w-48 bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden py-1 z-50 animate-fade-in ${isCollapsed ? 'left-14' : 'w-full'}`}>
                            <div className="px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider bg-slate-50">切換帳戶</div>
                            <div className="max-h-64 overflow-y-auto">
                                {USERS.map(user => (
                                    <button key={user} onClick={() => { onSwitch(user); setIsOpen(false); }} className={`w-full text-left px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors ${currentUser === user ? 'bg-blue-50 text-blue-600' : 'text-slate-600'}`}>
                                        <div className="flex items-center gap-3"><div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs text-white font-bold ${currentUser === user ? 'bg-blue-500' : 'bg-slate-300'}`}>{user[0]}</div><span className="text-sm font-medium">{user}</span></div>
                                        {currentUser === user && <Icons.Check size={14} />}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                    <button onClick={() => setIsOpen(!isOpen)} className={`flex items-center gap-3 p-2 rounded-xl hover:bg-white/50 transition-all w-full ${isCollapsed ? 'justify-center' : ''}`}>
                        <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold shadow-md shrink-0">{currentUser[0]}</div>
                        {!isCollapsed && (<div className="flex-1 text-left min-w-0"><div className="text-sm font-bold text-slate-800 truncate">{currentUser}</div><div className="text-xs text-slate-500 truncate">檢視資產中</div></div>)}
                        {!isCollapsed && <Icons.MoreVertical size={16} className="text-slate-400" />}
                    </button>
                </div>
            );
        };

        const TransactionForm = ({ onSave, selectedUser, accounts = [], initialData = null, onCancel }) => {
            const [type, setType] = useState('BUY');
            const [ticker, setTicker] = useState('');
            const [date, setDate] = useState(new Date().toISOString().substr(0, 10));
            const [shares, setShares] = useState('');
            const [price, setPrice] = useState('');
            const [fees, setFees] = useState('0');
            const [selectedAccount, setSelectedAccount] = useState(accounts.length > 0 ? accounts[0] : '預設帳戶');

            useEffect(() => {
                if (initialData) {
                    setType(initialData.type);
                    setTicker(initialData.ticker);
                    setDate(initialData.date);
                    setShares(initialData.shares);
                    setPrice(initialData.price);
                    setFees(initialData.fees);
                    setSelectedAccount(initialData.account || (accounts.length > 0 ? accounts[0] : '預設帳戶'));
                } else if (accounts.length > 0 && !accounts.includes(selectedAccount)) {
                    setSelectedAccount(accounts[0]);
                }
            }, [initialData, accounts]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!ticker || !price) return;
                
                onSave({
                    id: initialData ? initialData.id : Date.now(),
                    user: selectedUser,
                    account: selectedAccount,
                    type,
                    ticker: ticker.toUpperCase(),
                    date,
                    shares: Number(shares) || 0,
                    price: Number(price),
                    fees: Number(fees),
                    amount: type === 'DIVIDEND' ? Number(price) : (Number(shares) * Number(price))
                });
                
                if (!initialData) { setShares(''); setPrice(''); setFees('0'); }
            };

            return (
                <div className="space-y-4">
                    {!initialData && (
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <Icons.PlusCircle size={20} className="text-blue-500"/> 新增交易
                        </h3>
                    )}
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="flex p-1 bg-slate-200/50 rounded-xl w-full">
                            {['BUY', 'SELL', 'DIVIDEND'].map(t => (
                                <button key={t} type="button" onClick={() => setType(t)} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${type === t ? (t === 'BUY' ? 'bg-green-500 text-white shadow' : t === 'SELL' ? 'bg-red-500 text-white shadow' : 'bg-yellow-500 text-white shadow') : 'text-slate-500 hover:text-slate-700'}`}>
                                    {t === 'BUY' ? '買入' : t === 'SELL' ? '賣出' : '股利'}
                                </button>
                            ))}
                        </div>
                        <div>
                             <label className="text-xs font-medium text-slate-500 ml-1">證券帳戶</label>
                             <div className="relative">
                                <Icons.Building size={16} className="absolute left-3 top-3.5 text-slate-400" />
                                <select value={selectedAccount} onChange={e => setSelectedAccount(e.target.value)} className="w-full p-3 pl-9 rounded-xl bg-white/50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                                    {accounts.length > 0 ? accounts.map(acc => <option key={acc} value={acc}>{acc}</option>) : <option value="預設帳戶">預設帳戶</option>}
                                </select>
                             </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-xs font-medium text-slate-500 ml-1">代號</label>
                                <input type="text" value={ticker} onChange={e => setTicker(e.target.value)} placeholder="e.g. 2330" className="w-full p-3 rounded-xl bg-white/50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none uppercase" required />
                            </div>
                            <div>
                                <label className="text-xs font-medium text-slate-500 ml-1">日期</label>
                                <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-3 rounded-xl bg-white/50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" required />
                            </div>
                        </div>
                        {type !== 'DIVIDEND' && (
                            <div>
                                <label className="text-xs font-medium text-slate-500 ml-1">股數</label>
                                <input type="number" value={shares} onChange={e => setShares(e.target.value)} placeholder="0" className="w-full p-3 rounded-xl bg-white/50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" required />
                            </div>
                        )}
                        <div>
                            <label className="text-xs font-medium text-slate-500 ml-1">{type === 'DIVIDEND' ? '實領金額' : '單價'}</label>
                            <div className="relative">
                                <Icons.DollarSign size={16} className="absolute left-3 top-3.5 text-slate-400" />
                                <input type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="0.00" step="0.01" className="w-full p-3 pl-9 rounded-xl bg-white/50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" required />
                            </div>
                        </div>
                        {type !== 'DIVIDEND' && (
                           <div>
                                <label className="text-xs font-medium text-slate-500 ml-1">手續費</label>
                                <input type="number" value={fees} onChange={e => setFees(e.target.value)} placeholder="0" className="w-full p-3 rounded-xl bg-white/50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" />
                            </div>
                        )}
                        <div className="flex gap-2">
                             {onCancel && <button type="button" onClick={onCancel} className="flex-1 py-4 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-all">取消</button>}
                             <button type="submit" className="flex-1 py-4 rounded-xl bg-slate-800 text-white font-bold text-lg shadow-lg hover:bg-slate-700 active:scale-95 transition-all">{initialData ? '儲存修改' : '確認紀錄'}</button>
                        </div>
                    </form>
                </div>
            );
        };

        const HistoryView = ({ transactions, onEdit, onDelete }) => {
            const grouped = useMemo(() => {
                const groups = {};
                transactions.forEach(t => {
                    const monthKey = t.date.substring(0, 7);
                    if (!groups[monthKey]) groups[monthKey] = {};
                    if (!groups[monthKey][t.ticker]) groups[monthKey][t.ticker] = [];
                    groups[monthKey][t.ticker].push(t);
                });
                return Object.keys(groups).sort().reverse().map(month => ({ month, tickers: groups[month] }));
            }, [transactions]);

            if (transactions.length === 0) return <div className="text-center text-slate-400 mt-20">尚無交易資料</div>;

            return (
                <div className="space-y-8 animate-fade-in pb-20">
                    <h2 className="text-2xl font-bold text-slate-800">交易歷史紀錄</h2>
                    {grouped.map(g => (
                        <div key={g.month} className="space-y-4">
                            <h3 className="text-lg font-bold text-blue-600 bg-blue-50 inline-block px-3 py-1 rounded-lg">{g.month}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {Object.keys(g.tickers).map(ticker => (
                                    <GlassCard key={ticker} className="p-4">
                                        <div className="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                                            <span className="font-bold text-slate-800 text-lg">{ticker}</span>
                                            <span className="text-xs text-slate-400">{g.tickers[ticker].length} 筆交易</span>
                                        </div>
                                        <div className="space-y-2">
                                            {g.tickers[ticker].map(t => (
                                                <div key={t.id} className="flex justify-between items-center text-sm group">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`w-2 h-2 rounded-full ${t.type === 'BUY' ? 'bg-green-500' : t.type === 'SELL' ? 'bg-red-500' : 'bg-yellow-500'}`}></span>
                                                        <span className="text-slate-600">{t.date.substring(8)}</span>
                                                        <span className="text-xs text-slate-400 bg-slate-100 px-1 rounded">{t.account || '預設'}</span>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <div className="text-right">
                                                            <div className={`font-medium ${t.type === 'BUY' ? 'text-green-600' : t.type === 'SELL' ? 'text-red-600' : 'text-yellow-600'}`}>{t.type === 'BUY' ? '買' : t.type === 'SELL' ? '賣' : '息'} {t.type !== 'DIVIDEND' ? t.shares : ''}</div>
                                                            <div className="text-xs text-slate-400">{t.type === 'DIVIDEND' ? formatCurrency(t.amount) : `@${t.price}`}</div>
                                                        </div>
                                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={() => onEdit(t)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded"><Icons.Edit size={14} /></button>
                                                            <button onClick={() => onDelete(t.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded"><Icons.Trash2 size={14} /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </GlassCard>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const SettingsView = ({ settings, onUpdateSettings, currentUser, onManualSync, onDeleteAll }) => {
            const [newAccount, setNewAccount] = useState('');
            const [deleteConfirm, setDeleteConfirm] = useState(false);
            const userAccounts = settings.accounts?.[currentUser] || [];

            const addAccount = () => { if (newAccount) { onUpdateSettings(currentUser, [...userAccounts, newAccount]); setNewAccount(''); } };
            const removeAccount = (acc) => { onUpdateSettings(currentUser, userAccounts.filter(a => a !== acc)); };

            return (
                <div className="animate-fade-in max-w-2xl mx-auto space-y-8">
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-6">系統設定</h2>
                        <GlassCard className="p-6">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.Building size={20} className="text-blue-500"/> 證券戶頭管理</h3>
                            <div className="mb-4 flex gap-2">
                                <input type="text" value={newAccount} onChange={e => setNewAccount(e.target.value)} placeholder={`新增 ${currentUser} 的證券戶 (如: 國泰)`} className="flex-1 p-3 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <button onClick={addAccount} className="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-xl font-bold">+</button>
                            </div>
                            <div className="space-y-2">
                                {userAccounts.length === 0 ? <p className="text-center text-slate-400 text-sm py-4">尚未設定證券戶</p> : userAccounts.map(acc => (
                                    <div key={acc} className="flex justify-between items-center p-3 bg-white/50 rounded-xl border border-slate-100">
                                        <span className="font-medium text-slate-700">{acc}</span>
                                        <button onClick={() => removeAccount(acc)} className="text-red-400 hover:text-red-600 p-2"><Icons.Trash2 size={16}/></button>
                                    </div>
                                ))}
                            </div>
                        </GlassCard>
                    </div>

                    <GlassCard className="p-6">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.Cloud size={20} className="text-blue-500"/> 雲端同步</h3>
                         <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => onManualSync('push')} className="flex items-center justify-center gap-2 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold hover:bg-blue-100 transition-colors"><Icons.UploadCloud size={18} /> 立即上傳 (Push)</button>
                            <button onClick={() => onManualSync('pull')} className="flex items-center justify-center gap-2 py-3 rounded-xl bg-green-50 text-green-600 font-bold hover:bg-green-100 transition-colors"><Icons.DownloadCloud size={18} /> 立即下載 (Pull)</button>
                         </div>
                         <p className="text-xs text-slate-400 mt-2 text-center">系統會自動上傳變更。若在多裝置操作，請手動下載最新進度。</p>
                    </GlassCard>

                    <div className="pt-8">
                        <button onClick={() => setDeleteConfirm(!deleteConfirm)} className="text-xs text-slate-300 hover:text-red-400 flex items-center gap-1 mx-auto transition-colors">
                            <Icons.AlertTriangle size={12}/> 進階危險區域
                        </button>
                        {deleteConfirm && (
                            <div className="mt-4 p-4 border border-red-100 bg-red-50/50 rounded-xl text-center animate-fade-in">
                                <p className="text-sm text-red-600 font-bold mb-3">確定要刪除所有資料嗎？此動作無法復原。</p>
                                <button onClick={() => { onDeleteAll(); setDeleteConfirm(false); }} className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-bold rounded-lg shadow-md transition-all">確認刪除所有資料</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [transactions, setTransactions] = useState([]);
            const [settings, setSettings] = useState({ accounts: {} });
            const [currentUser, setCurrentUser] = useState('Alice');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isSidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [syncStatus, setSyncStatus] = useState('idle'); // idle, loading, success, error
            const [ghSha, setGhSha] = useState(null);
            
            // Edit Modal State
            const [editingTransaction, setEditingTransaction] = useState(null);

            useEffect(() => {
                const savedData = localStorage.getItem('mf_data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (Array.isArray(parsed)) { setTransactions(parsed); } else { setTransactions(parsed.transactions || []); setSettings(parsed.settings || { accounts: {} }); }
                    } catch (e) { console.error("Local data parse error", e); }
                }
            }, []);

            // Auto-Push Helper
            const saveAndSync = (newTx, newSettings) => {
                const data = { transactions: newTx, settings: newSettings };
                localStorage.setItem('mf_data', JSON.stringify(data));
                setTransactions(newTx);
                setSettings(newSettings);
                handleSync('push', newTx, newSettings); // Trigger Auto Push
            };

            const handleUpdateSettings = (user, accounts) => {
                const newSettings = { ...settings, accounts: { ...settings.accounts, [user]: accounts } };
                saveAndSync(transactions, newSettings);
            };

            const addTransaction = (t) => saveAndSync([...transactions, t], settings);
            
            const updateTransaction = (updatedTx) => {
                const newTx = transactions.map(t => t.id === updatedTx.id ? updatedTx : t);
                saveAndSync(newTx, settings);
                setEditingTransaction(null); // Close modal
            };

            const deleteTransaction = (id) => {
                if(confirm("確定要刪除這筆交易嗎？")) {
                    const newTx = transactions.filter(t => t.id !== id);
                    saveAndSync(newTx, settings);
                }
            };

            const deleteAllData = () => {
                saveAndSync([], { accounts: {} });
                alert("已清除所有資料並同步至雲端");
            };

            const handleSync = async (direction, currentTx = transactions, currentSettings = settings) => {
                const { TOKEN, OWNER, REPO, PATH } = GH_CONFIG;
                if (!TOKEN || !OWNER || !REPO) return; // Silent fail if config not set
                
                setSyncStatus('loading');
                const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
                
                try {
                    const getRes = await fetch(url, { headers: { 'Authorization': `token ${TOKEN}` }});
                    
                    if (direction === 'pull') {
                        if (getRes.ok) {
                            const data = await getRes.json();
                            setGhSha(data.sha);
                            const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                            
                            if (Array.isArray(content)) { setTransactions(content); } 
                            else { setTransactions(content.transactions || []); setSettings(content.settings || { accounts: {} }); }
                            
                            localStorage.setItem('mf_data', JSON.stringify(content));
                            setSyncStatus('success');
                        }
                    } else { // push
                        let sha = ghSha;
                        if (!sha && getRes.ok) {
                            const data = await getRes.json();
                            sha = data.sha;
                        }
                        const contentObj = { transactions: currentTx, settings: currentSettings };
                        const contentStr = btoa(unescape(encodeURIComponent(JSON.stringify(contentObj, null, 2))));
                        
                        const putRes = await fetch(url, {
                            method: 'PUT',
                            headers: { 'Authorization': `token ${TOKEN}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: 'Auto-Sync Money Flow', content: contentStr, sha })
                        });
                        if (putRes.ok) {
                            const data = await putRes.json();
                            setGhSha(data.content.sha);
                            setSyncStatus('success');
                        } else throw new Error('Push failed');
                    }
                } catch (e) { console.error(e); setSyncStatus('error'); }
                setTimeout(() => setSyncStatus('idle'), 2000);
            };

            const handleUserSwitch = (user) => {
                setCurrentUser(user);
                setActiveTab('dashboard');
                handleSync('pull'); // Auto-pull on switch
            };

            const portfolio = useMemo(() => {
                const userTx = transactions.filter(t => t.user === currentUser);
                const holdings = {};
                let totalInvested = 0, totalRealized = 0, totalDiv = 0;
                userTx.sort((a,b) => new Date(a.date) - new Date(b.date));
                userTx.forEach(t => {
                    if (!holdings[t.ticker]) holdings[t.ticker] = { ticker: t.ticker, shares: 0, cost: 0, div: 0 };
                    const h = holdings[t.ticker];
                    if (t.type === 'BUY') { const amt = (t.shares * t.price) + t.fees; h.shares += t.shares; h.cost += amt; totalInvested += amt; } 
                    else if (t.type === 'SELL') { 
                        const avgCost = h.shares > 0 ? h.cost / h.shares : 0; const costBasis = avgCost * t.shares; const revenue = (t.shares * t.price) - t.fees; 
                        h.shares -= t.shares; h.cost -= costBasis; totalRealized += (revenue - costBasis); totalInvested -= costBasis; 
                    } 
                    else if (t.type === 'DIVIDEND') { h.div += t.amount; totalDiv += t.amount; }
                });
                const list = Object.values(holdings).map(h => ({ ...h, avgPrice: h.shares > 0 ? h.cost / h.shares : 0, mktPrice: h.shares > 0 ? (h.cost / h.shares) * 1.05 : 0 })).filter(h => h.shares > 0);
                const mktVal = list.reduce((a, b) => a + (b.shares * b.mktPrice), 0);
                return { holdings: list, mktVal, totalReturn: (mktVal - totalInvested) + totalRealized + totalDiv, realized: totalRealized, div: totalDiv };
            }, [transactions, currentUser]);

            if (!isAuthenticated) return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;

            return (
                <div className="flex h-screen bg-slate-50 font-sans">
                    {/* Top Right Cloud Icon (One Only) */}
                    <div className="fixed top-4 right-4 z-50">
                        <button onClick={() => handleSync('pull')} className={`p-3 rounded-full bg-white/80 backdrop-blur shadow-lg border border-slate-200 hover:bg-white transition-all ${syncStatus === 'loading' ? 'text-blue-500' : syncStatus === 'success' ? 'text-green-500' : syncStatus === 'error' ? 'text-red-500' : 'text-slate-400'}`} title="點擊下載最新進度">
                            <Icons.Cloud size={24} className={syncStatus === 'loading' ? 'animate-spin-slow' : ''} />
                            {syncStatus === 'loading' && <span className="absolute top-0 right-0 w-3 h-3 bg-blue-500 rounded-full animate-ping"></span>}
                        </button>
                    </div>

                    {/* Sidebar */}
                    <aside className={`hidden md:flex flex-col h-full bg-white/80 backdrop-blur-xl border-r border-slate-200 transition-all duration-300 z-40 ${isSidebarCollapsed ? 'w-20' : 'w-64'}`}>
                        <div className="h-16 flex items-center justify-between px-4 border-b border-slate-100 relative">
                            <div className={`flex items-center gap-2 text-blue-600 transition-opacity duration-300 ${isSidebarCollapsed ? 'opacity-100 absolute left-1/2 -translate-x-1/2' : 'opacity-100'}`}>
                                <Icons.TrendingUp size={24} />
                                {!isSidebarCollapsed && <span className="font-bold text-lg tracking-tight">Money Flow</span>}
                            </div>
                            <button onClick={() => setSidebarCollapsed(!isSidebarCollapsed)} className={`p-1.5 rounded hover:bg-slate-100 text-slate-400 absolute right-2`}>
                                {isSidebarCollapsed ? <Icons.ChevronRight size={16}/> : <Icons.ChevronLeft size={16}/>}
                            </button>
                        </div>
                        <nav className="flex-1 p-3 space-y-1">
                            {[
                                { id: 'dashboard', icon: Icons.LayoutDashboard, label: '資產總覽' },
                                { id: 'history', icon: Icons.FileText, label: '交易紀錄' },
                                { id: 'add', icon: Icons.PlusCircle, label: '新增交易' },
                                { id: 'settings', icon: Icons.Settings, label: '系統設定' }
                            ].map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${activeTab === item.id ? 'bg-blue-50 text-blue-600' : 'text-slate-500 hover:bg-slate-100'}`}>
                                    <item.icon size={24} />
                                    {!isSidebarCollapsed && <span className="font-medium">{item.label}</span>}
                                </button>
                            ))}
                        </nav>
                        <div className="p-3 border-t border-slate-100">
                            <UserSwitcher currentUser={currentUser} onSwitch={handleUserSwitch} isCollapsed={isSidebarCollapsed} />
                        </div>
                    </aside>

                    {/* Content */}
                    <main className="flex-1 overflow-y-auto relative">
                        <div className="md:hidden sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 py-3 flex items-center gap-2">
                             <Icons.TrendingUp className="text-blue-600" size={20} /><span className="font-bold">Money Flow</span>
                        </div>

                        <div className="max-w-6xl mx-auto p-4 md:p-10 pb-24">
                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div><h1 className="text-3xl font-bold text-slate-800">早安, {currentUser}</h1><p className="text-slate-500">資產概況</p></div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <GlassCard className="p-6"><div className="text-slate-500 text-sm mb-1">總資產市值</div><div className="text-3xl font-bold text-slate-800">{formatCurrency(portfolio.mktVal)}</div></GlassCard>
                                        <GlassCard className="p-6"><div className="text-slate-500 text-sm mb-1">總損益 (含息)</div><div className={`text-3xl font-bold ${portfolio.totalReturn >= 0 ? 'text-red-500' : 'text-green-500'}`}>{portfolio.totalReturn > 0 ? '+' : ''}{formatCurrency(portfolio.totalReturn)}</div><div className="mt-2 text-xs text-slate-400">股利: {formatNumber(portfolio.div)}</div></GlassCard>
                                        <GlassCard className="p-6 h-40">{Recharts.PieChart ? (<ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={portfolio.holdings} dataKey="shares" nameKey="ticker" cx="50%" cy="50%" outerRadius={50}>{portfolio.holdings.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}</Pie><RechartsTooltip /></PieChart></ResponsiveContainer>) : <div className="flex items-center justify-center h-full text-xs text-slate-400">圖表載入中</div>}</GlassCard>
                                    </div>
                                    <GlassCard className="overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-4">標的</th><th className="p-4">股數</th><th className="p-4">均價</th><th className="p-4">現價</th><th className="p-4">損益</th></tr></thead><tbody className="divide-y divide-slate-100">{portfolio.holdings.map(h => { const un = (h.mktPrice - h.avgPrice) * h.shares; return (<tr key={h.ticker}><td className="p-4 font-bold">{h.ticker}</td><td className="p-4">{formatNumber(h.shares)}</td><td className="p-4">{formatNumber(h.avgPrice)}</td><td className="p-4">{formatNumber(h.mktPrice)}</td><td className={`p-4 ${un >= 0 ? 'text-red-500' : 'text-green-500'}`}>{formatNumber(un)}</td></tr>) })}</tbody></table></GlassCard>
                                </div>
                            )}

                            {activeTab === 'history' && (
                                <HistoryView 
                                    transactions={transactions.filter(t => t.user === currentUser)} 
                                    onEdit={(t) => setEditingTransaction(t)}
                                    onDelete={deleteTransaction}
                                />
                            )}

                            {activeTab === 'add' && (
                                <div className="max-w-md mx-auto animate-fade-in">
                                    <GlassCard className="p-6">
                                        <TransactionForm 
                                            onSave={(t) => { addTransaction(t); setActiveTab('dashboard'); }} 
                                            selectedUser={currentUser} 
                                            accounts={settings.accounts?.[currentUser] || []}
                                        />
                                    </GlassCard>
                                </div>
                            )}

                            {activeTab === 'settings' && (
                                <SettingsView 
                                    settings={settings} 
                                    onUpdateSettings={handleUpdateSettings} 
                                    currentUser={currentUser}
                                    onManualSync={handleSync}
                                    onDeleteAll={deleteAllData}
                                />
                            )}
                        </div>

                        {/* Edit Modal */}
                        <Modal isOpen={!!editingTransaction} onClose={() => setEditingTransaction(null)} title="編輯交易">
                            {editingTransaction && (
                                <TransactionForm 
                                    initialData={editingTransaction}
                                    onSave={updateTransaction}
                                    onCancel={() => setEditingTransaction(null)}
                                    selectedUser={currentUser}
                                    accounts={settings.accounts?.[currentUser] || []}
                                />
                            )}
                        </Modal>
                    </main>

                    {/* Mobile Tab Bar */}
                    <div className="md:hidden fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur border-t border-slate-200 z-40 flex justify-around p-2">
                        {[{ id: 'dashboard', icon: Icons.LayoutDashboard, label: '總覽' },{ id: 'history', icon: Icons.FileText, label: '紀錄' },{ id: 'add', icon: Icons.PlusCircle, label: '記帳' },{ id: 'settings', icon: Icons.Settings, label: '設定' }].map(item => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center p-2 rounded ${activeTab === item.id ? 'text-blue-600' : 'text-slate-400'}`}><item.icon size={24} /><span className="text-[10px] mt-1">{item.label}</span></button>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
